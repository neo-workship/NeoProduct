# NiceGUI Auth 包 完整使用指南

## 📋 目录

1. [Auth 包概述](#auth包概述)
2. [核心组件介绍](#核心组件介绍)
3. [快速开始](#快速开始)
4. [装饰器使用](#装饰器使用)
5. [页面访问控制](#页面访问控制)
6. [角色权限管理](#角色权限管理)
7. [实际应用示例](#实际应用示例)
8. [配置选项](#配置选项)
9. [最佳实践](#最佳实践)

---

## Auth 包概述

Auth 包是一个完整的用户认证和权限管理解决方案，专为 NiceGUI 应用程序设计。它提供了用户登录、注册、会话管理、角色控制和权限验证等功能。

### 主要特性

- 🔐 **用户认证**: 登录、注册、注销功能
- 👥 **角色管理**: 多角色系统支持
- 🛡️ **权限控制**: 细粒度权限管理
- 🎯 **装饰器保护**: 简单易用的页面和功能保护
- 📊 **会话管理**: 安全的用户会话处理
- 🎨 **内置页面**: 开箱即用的认证界面

---

## 核心组件介绍

### 1. AuthManager (认证管理器)

负责用户登录、注册、会话验证等核心认证功能。

### 2. 装饰器系统

- `@require_login()`: 要求用户登录
- `@require_role('admin')`: 要求特定角色
- `@require_permission('user.manage')`: 要求特定权限

### 3. 内置页面

- 登录页面 (`login_page_content`)
- 注册页面 (`register_page_content`)
- 用户管理页面 (`user_management_page_content`)
- 角色管理页面 (`role_management_page_content`)
- 权限管理页面 (`permission_management_page_content`)

---

## 快速开始

### 步骤 1: 导入必要组件

```python
from auth import (
    auth_manager,
    require_login,
    require_role,
    require_permission,
    login_page_content,
    register_page_content,
    init_database
)
```

### 步骤 2: 初始化数据库

```python
# 初始化Auth数据库
init_database()

# 创建测试用户（开发环境）
def init_test_data():
    from auth.database import get_db
    from auth.models import User, Role

    with get_db() as db:
        if db.query(User).count() > 0:
            return

        # 创建管理员
        admin = User(
            username='admin',
            email='admin@example.com',
            full_name='系统管理员',
            is_active=True,
            is_superuser=True
        )
        admin.set_password('admin123')

        # 创建普通用户
        user = User(
            username='user',
            email='user@example.com',
            full_name='测试用户',
            is_active=True
        )
        user.set_password('user123')

        db.add(admin)
        db.add(user)
        db.commit()
```

### 步骤 3: 创建登录和注册页面

```python
from nicegui import ui

# 登录页面
@ui.page('/login')
def login_page():
    login_page_content()

# 注册页面
@ui.page('/register')
def register_page():
    register_page_content()
```

### 步骤 4: 保护主应用

```python
@ui.page('/workbench')
def main_page():
    # 检查登录状态
    user = auth_manager.check_session()
    if not user:
        ui.navigate.to('/login')
        return

    # 已登录用户的主界面
    ui.label(f'欢迎，{user.full_name}!')
```

---

## 装饰器使用

### 1. @require_login 要求登录

```python
from auth import require_login

@require_login()
def protected_function():
    """只有登录用户才能访问"""
    ui.label('这是受保护的内容')

# 页面级保护
@require_login(redirect_to_login=True)
def dashboard_page_content():
    ui.label('仪表板页面')
    # 页面内容...
```

### 2. @require_role 角色控制

```python
from auth import require_role

# 单个角色
@require_role('admin')
def admin_function():
    """只有管理员可以访问"""
    ui.label('管理员专用功能')

# 多个角色（任一即可）
@require_role('admin', 'editor')
def editor_function():
    """管理员或编辑可以访问"""
    ui.label('编辑功能')

# 实际页面示例
@require_role('admin')
def user_management_page_content():
    """用户管理页面 - 仅管理员"""
    ui.label('用户管理').classes('text-2xl font-bold')
    # 用户管理界面...
```

### 3. @require_permission 权限控制

```python
from auth import require_permission

# 单个权限
@require_permission('user.manage')
def manage_users():
    """需要用户管理权限"""
    ui.label('用户管理功能')

# 多个权限（都必须拥有）
@require_permission('content.create', 'content.edit')
def create_and_edit():
    """需要创建和编辑权限"""
    ui.label('内容创建编辑')
```

### 4. 组合使用装饰器

```python
@require_login()
@require_role('admin')
def admin_dashboard():
    """需要登录且是管理员"""
    ui.label('管理员仪表板')

@require_login()
@require_permission('system.manage')
def system_settings():
    """需要登录且有系统管理权限"""
    ui.label('系统设置')
```

---

## 页面访问控制

### 方法 1: 在页面路由中检查认证

```python
@ui.page('/admin')
def admin_page():
    # 检查用户登录
    user = auth_manager.check_session()
    if not user:
        ui.navigate.to('/login')
        return

    # 检查管理员角色
    if not user.has_role('admin'):
        ui.notify('需要管理员权限', type='error')
        ui.navigate.to('/workbench')
        return

    # 管理员页面内容
    ui.label('管理员页面')
```

### 方法 2: 使用装饰器保护页面内容

```python
@ui.page('/dashboard')
def dashboard_page():
    dashboard_content()

@require_login()
def dashboard_content():
    """仪表板页面内容"""
    ui.label('仪表板').classes('text-3xl font-bold')
    # 页面内容...
```

### 方法 3: 在布局管理器中集成

```python
# 在SPA布局中的页面处理器
def create_protected_handlers():
    menu_handlers = get_menu_page_handlers()
    header_handlers = get_header_page_handlers()
    auth_handlers = get_auth_page_handlers()

    return {**menu_handlers, **header_handlers, **auth_handlers}

# 使用受保护的处理器
@with_spa_layout(
    config=config,
    route_handlers=create_protected_handlers()
)
def main_layout():
    pass
```

---

## 角色权限管理

### 默认角色系统

Auth 包提供了四个默认角色：

```python
# 在 auth/config.py 中定义的默认角色
default_roles = [
    {'name': 'admin', 'display_name': '管理员', 'description': '系统管理员，拥有所有权限'},
    {'name': 'editor', 'display_name': '编辑', 'description': '可以编辑内容'},
    {'name': 'viewer', 'display_name': '查看', 'description': '只能查看内容'},
    {'name': 'user', 'display_name': '普通用户', 'description': '普通注册用户'}
]
```

### 角色检查方法

```python
# 检查当前用户角色
if auth_manager.has_role('admin'):
    ui.label('您是管理员')

# 在用户对象上检查
user = auth_manager.current_user
if user and user.has_role('editor'):
    ui.label('您有编辑权限')
```

### 权限系统

```python
# 默认权限类别
default_permissions = [
    # 系统权限
    {'name': 'system.manage', 'display_name': '系统管理', 'category': '系统'},
    {'name': 'user.manage', 'display_name': '用户管理', 'category': '系统'},
    {'name': 'role.manage', 'display_name': '角色管理', 'category': '系统'},

    # 内容权限
    {'name': 'content.create', 'display_name': '创建内容', 'category': '内容'},
    {'name': 'content.edit', 'display_name': '编辑内容', 'category': '内容'},
    {'name': 'content.delete', 'display_name': '删除内容', 'category': '内容'},
    {'name': 'content.view', 'display_name': '查看内容', 'category': '内容'},
]
```

### 权限检查方法

```python
# 检查特定权限
if auth_manager.has_permission('user.manage'):
    ui.button('用户管理', on_click=show_user_management)

# 多权限检查
required_permissions = ['content.create', 'content.edit']
if all(auth_manager.has_permission(p) for p in required_permissions):
    ui.button('创建并编辑', on_click=create_and_edit_content)
```

---

## 实际应用示例

### 示例 1: 完整的主应用结构

```python
from nicegui import ui
from auth import (
    auth_manager, require_login, require_role,
    login_page_content, register_page_content,
    init_database, get_auth_page_handlers
)

# 初始化
init_database()

# 登录页面
@ui.page('/login')
def login_page():
    login_page_content()

# 注册页面
@ui.page('/register')
def register_page():
    register_page_content()

# 主应用页面
@ui.page('/workbench')
def main_page():
    user = auth_manager.check_session()
    if not user:
        ui.navigate.to('/login')
        return

    create_main_layout(user)

def create_main_layout(user):
    """创建主布局"""
    with ui.header().classes('bg-blue-600 text-white'):
        ui.label('我的应用').classes('text-xl font-bold')
        with ui.row().classes('ml-auto gap-2'):
            ui.label(f'欢迎，{user.full_name}')
            ui.button('注销', on_click=logout).classes('bg-red-500')

    with ui.left_drawer().classes('bg-gray-100'):
        create_navigation_menu(user)

    with ui.page_sticky():
        create_content_area()

def logout():
    """注销功能"""
    auth_manager.logout()
    ui.navigate.to('/login')
```

### 示例 2: 角色相关的菜单显示

```python
def create_navigation_menu(user):
    """根据用户角色创建导航菜单"""

    # 所有用户都能看到的菜单
    ui.button('首页', on_click=lambda: show_page('home')).classes('w-full')
    ui.button('个人资料', on_click=lambda: show_page('profile')).classes('w-full')

    # 编辑角色及以上可见
    if user.has_role('editor') or user.has_role('admin'):
        ui.separator()
        ui.label('内容管理').classes('font-bold text-gray-600')
        ui.button('创建内容', on_click=lambda: show_page('create')).classes('w-full')
        ui.button('编辑内容', on_click=lambda: show_page('edit')).classes('w-full')

    # 仅管理员可见
    if user.has_role('admin'):
        ui.separator()
        ui.label('系统管理').classes('font-bold text-gray-600')
        ui.button('用户管理', on_click=lambda: show_page('users')).classes('w-full')
        ui.button('角色管理', on_click=lambda: show_page('roles')).classes('w-full')
        ui.button('权限管理', on_click=lambda: show_page('permissions')).classes('w-full')
```

### 示例 3: 功能级权限控制

```python
def create_data_table():
    """创建数据表格，根据权限显示不同按钮"""

    with ui.table() as table:
        # 表格内容...
        pass

    # 根据权限显示操作按钮
    with ui.row().classes('mt-4 gap-2'):
        # 查看权限 - 所有用户
        if auth_manager.has_permission('content.view'):
            ui.button('查看详情', icon='visibility')

        # 编辑权限
        if auth_manager.has_permission('content.edit'):
            ui.button('编辑', icon='edit', on_click=edit_item).classes('bg-blue-500')

        # 删除权限
        if auth_manager.has_permission('content.delete'):
            ui.button('删除', icon='delete', on_click=delete_item).classes('bg-red-500')

        # 管理员专用功能
        if auth_manager.has_role('admin'):
            ui.button('高级设置', icon='settings', on_click=advanced_settings).classes('bg-purple-500')
```

---

## 配置选项

### AuthConfig 配置类

```python
from auth.config import auth_config

# 数据库配置
auth_config.database_type = 'sqlite'  # 或 'mysql', 'postgresql'
auth_config.database_url = 'sqlite:///auth.db'

# 会话配置
auth_config.session_timeout = 3600 * 24  # 24小时
auth_config.remember_me_duration = 3600 * 24 * 30  # 30天

# 密码策略
auth_config.password_min_length = 8
auth_config.password_require_uppercase = True
auth_config.password_require_numbers = True

# 注册配置
auth_config.allow_registration = True
auth_config.require_email_verification = False
auth_config.default_user_role = 'user'

# 登录安全
auth_config.max_login_attempts = 5
auth_config.lockout_duration = 1800  # 30分钟

# 路由配置
auth_config.login_route = '/login'
auth_config.logout_route = '/logout'
auth_config.register_route = '/register'
```

### 页面权限映射

```python
# 在 auth_config 中定义页面权限要求
auth_config.page_permissions = {
    'dashboard': ['content.view'],
    'data': ['content.view', 'content.edit'],
    'analysis': ['content.view'],
    'user_management': ['user.manage'],
    'system_settings': ['system.manage'],
}
```

---

## 最佳实践

### 1. 安全原则

```python
# ✅ 好的做法：总是检查登录状态
@ui.page('/sensitive-data')
def sensitive_page():
    user = auth_manager.check_session()
    if not user:
        ui.navigate.to('/login')
        return
    show_sensitive_data()

# ❌ 避免：不检查就显示敏感内容
@ui.page('/bad-example')
def bad_page():
    show_sensitive_data()  # 任何人都能访问
```

### 2. 装饰器层次

```python
# ✅ 推荐：由粗到细的权限控制
@require_login()          # 第一层：必须登录
@require_role('admin')    # 第二层：必须是管理员
def admin_function():
    pass

# ✅ 或者使用权限控制
@require_login()
@require_permission('user.manage', 'system.manage')
def manage_function():
    pass
```

### 3. 错误处理

```python
def safe_operation():
    """安全的操作示例"""
    try:
        user = auth_manager.check_session()
        if not user:
            ui.notify('请先登录', type='warning')
            return

        if not user.has_permission('required.permission'):
            ui.notify('权限不足', type='error')
            return

        # 执行实际操作
        perform_operation()
        ui.notify('操作成功', type='positive')

    except Exception as e:
        ui.notify(f'操作失败: {str(e)}', type='negative')
```

### 4. 用户体验优化

```python
def create_smart_ui(user):
    """根据用户权限智能显示UI"""

    # 始终显示基础功能
    with ui.card().classes('mb-4'):
        ui.label('基础功能')
        ui.button('查看数据', on_click=view_data)

    # 有编辑权限才显示编辑功能
    if user.has_permission('content.edit'):
        with ui.card().classes('mb-4'):
            ui.label('编辑功能')
            ui.button('编辑数据', on_click=edit_data)

    # 管理员显示管理功能
    if user.has_role('admin'):
        with ui.card().classes('mb-4'):
            ui.label('管理功能').classes('text-red-600')
            ui.button('系统设置', on_click=system_settings)
```

### 5. 开发和生产环境

```python
import os

# 开发环境初始化测试数据
if os.environ.get('ENVIRONMENT') == 'development':
    init_test_data()

# 生产环境使用强密码策略
if os.environ.get('ENVIRONMENT') == 'production':
    auth_config.password_min_length = 12
    auth_config.password_require_uppercase = True
    auth_config.password_require_numbers = True
    auth_config.password_require_special = True
```

---

## 总结

Auth 包为 NiceGUI 应用提供了完整的认证和权限管理解决方案。通过合理使用装饰器、角色和权限系统，您可以：

1. **保护应用安全**: 确保只有授权用户能访问敏感功能
2. **简化开发**: 使用装饰器快速添加访问控制
3. **灵活管理**: 通过角色和权限系统实现精细化控制
4. **提升体验**: 根据用户权限动态显示界面元素

遵循本指南中的最佳实践，您可以构建安全、易用的 NiceGUI 应用程序。
