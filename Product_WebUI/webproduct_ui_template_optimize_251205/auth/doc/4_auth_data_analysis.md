# webproduct_ui_template Auth åŒ… - æ•°æ®å±‚é¢æ·±åº¦åˆ†æ

## ğŸ“‹ ç›®å½•

1. [æ•°æ®æ¶æ„æ€»è§ˆ](#æ•°æ®æ¶æ„æ€»è§ˆ)
2. [æ•°æ®å®šä¹‰ä¸å»ºæ¨¡](#æ•°æ®å®šä¹‰ä¸å»ºæ¨¡)
3. [æ•°æ®å­˜å‚¨ç­–ç•¥](#æ•°æ®å­˜å‚¨ç­–ç•¥)
4. [æ•°æ®è·å–æœºåˆ¶](#æ•°æ®è·å–æœºåˆ¶)
5. [æ•°æ®ä¼ é€’æµç¨‹](#æ•°æ®ä¼ é€’æµç¨‹)
6. [æ•°æ®è½¬æ¢ä¸æ˜ å°„](#æ•°æ®è½¬æ¢ä¸æ˜ å°„)
7. [æ•°æ®ç”Ÿå‘½å‘¨æœŸç®¡ç†](#æ•°æ®ç”Ÿå‘½å‘¨æœŸç®¡ç†)
8. [æ•°æ®ä¸€è‡´æ€§ä¿éšœ](#æ•°æ®ä¸€è‡´æ€§ä¿éšœ)
9. [æ•°æ®å®‰å…¨æœºåˆ¶](#æ•°æ®å®‰å…¨æœºåˆ¶)
10. [æ€§èƒ½ä¼˜åŒ–ç­–ç•¥](#æ€§èƒ½ä¼˜åŒ–ç­–ç•¥)

---

## æ•°æ®æ¶æ„æ€»è§ˆ

### æ•°æ®åˆ†å±‚æ¶æ„

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                     åº”ç”¨å±‚ (Application Layer)                    â”‚
â”‚                        NiceGUI Pages                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                             â”‚
                â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                â”‚                         â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   ä¸šåŠ¡æ•°æ®å¯¹è±¡ (UserSession)  â”‚  â”‚  ä¸šåŠ¡é€»è¾‘å±‚ (AuthManager)   â”‚
â”‚   - å†…å­˜æ•°æ®ç»“æ„              â”‚  â”‚  - ä¸šåŠ¡è§„åˆ™å¤„ç†             â”‚
â”‚   - è¿è¡Œæ—¶çŠ¶æ€                â”‚  â”‚  - æ•°æ®éªŒè¯                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                â”‚                         â”‚
                â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                             â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                  ç¼“å­˜å±‚ (Cache Layer)                            â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                  â”‚
â”‚  â”‚ L1: current_user â”‚    â”‚ L2: SessionManagerâ”‚                  â”‚
â”‚  â”‚   (å•ä¾‹ç¼“å­˜)      â”‚    â”‚   (å­—å…¸ç¼“å­˜)      â”‚                  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                             â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                 æŒä¹…å±‚ (Persistence Layer)                       â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                  â”‚
â”‚  â”‚ Browser Storage  â”‚    â”‚  Database (ORM)  â”‚                  â”‚
â”‚  â”‚ - session_token  â”‚    â”‚  - User Table    â”‚                  â”‚
â”‚  â”‚ - remember_token â”‚    â”‚  - Role Table    â”‚                  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚  - Permission    â”‚                  â”‚
â”‚                          â”‚  - Link Tables   â”‚                  â”‚
â”‚                          â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### æ•°æ®æµåŠ¨è·¯å¾„

```
ç”¨æˆ·æ“ä½œ
   â†“
[UI å±‚] â†’ è¡¨å•æ•°æ®æ”¶é›†
   â†“
[ä¸šåŠ¡å±‚] â†’ æ•°æ®éªŒè¯ + ä¸šåŠ¡å¤„ç†
   â†“
[ORM å±‚] â†’ SQLModel å¯¹è±¡æ˜ å°„
   â†“
[æ•°æ®åº“] â†’ æŒä¹…åŒ–å­˜å‚¨
   â†“
[ORM å±‚] â†’ æŸ¥è¯¢ç»“æœåŠ è½½
   â†“
[è½¬æ¢å±‚] â†’ User â†’ UserSession
   â†“
[ç¼“å­˜å±‚] â†’ å†…å­˜ç¼“å­˜å­˜å‚¨
   â†“
[ä¸šåŠ¡å±‚] â†’ æƒé™è®¡ç®— + çŠ¶æ€æ›´æ–°
   â†“
[UI å±‚] â†’ é¡µé¢æ¸²æŸ“
```

---

## æ•°æ®å®šä¹‰ä¸å»ºæ¨¡

### 1. æ ¸å¿ƒæ•°æ®å®ä½“

#### User å®ä½“å®Œæ•´å®šä¹‰

```python
class User(SQLModel, table=True):
    """
    ç”¨æˆ·å®ä½“ - ç³»ç»Ÿè®¤è¯çš„æ ¸å¿ƒæ•°æ®æ¨¡å‹

    æ•°æ®åˆ†ç±»ï¼š
    1. æ ‡è¯†æ•°æ® - å”¯ä¸€è¯†åˆ«ç”¨æˆ·
    2. è®¤è¯æ•°æ® - å®‰å…¨éªŒè¯
    3. ä¸ªäººèµ„æ–™ - ç”¨æˆ·ä¿¡æ¯
    4. çŠ¶æ€æ•°æ® - è´¦æˆ·çŠ¶æ€
    5. å®¡è®¡æ•°æ® - è¿½è¸ªè®°å½•
    6. å…³ç³»æ•°æ® - å¤–é”®å…³è”
    """
    __tablename__ = "users"

    # ========== 1. æ ‡è¯†æ•°æ® ==========
    id: Optional[int] = Field(
        default=None,           # æ•°æ®åº“è‡ªåŠ¨ç”Ÿæˆ
        primary_key=True,       # ä¸»é”®æ ‡è¯†
        index=True              # åˆ›å»ºç´¢å¼•åŠ é€ŸæŸ¥è¯¢
    )

    username: str = Field(
        max_length=50,          # é™åˆ¶é•¿åº¦
        unique=True,            # å”¯ä¸€çº¦æŸ
        index=True,             # ç´¢å¼•ï¼ˆç”¨äºç™»å½•æŸ¥è¯¢ï¼‰
        description="ç”¨æˆ·å"
    )

    email: str = Field(
        max_length=100,
        unique=True,            # å”¯ä¸€çº¦æŸ
        index=True,             # ç´¢å¼•ï¼ˆç”¨äºé‚®ç®±ç™»å½•ï¼‰
        description="é‚®ç®±"
    )

    # ========== 2. è®¤è¯æ•°æ® ==========
    password_hash: str = Field(
        max_length=255,
        description="å¯†ç å“ˆå¸Œå€¼ï¼ˆSHA-256ï¼‰"
    )

    session_token: Optional[str] = Field(
        default=None,
        max_length=255,
        description="å½“å‰ä¼šè¯ä»¤ç‰Œï¼ˆä¸´æ—¶ï¼‰"
    )

    remember_token: Optional[str] = Field(
        default=None,
        max_length=255,
        description="è®°ä½æˆ‘ä»¤ç‰Œï¼ˆé•¿æœŸï¼‰"
    )

    # ========== 3. ä¸ªäººèµ„æ–™ ==========
    full_name: Optional[str] = Field(
        default=None,
        max_length=100,
        description="å…¨å"
    )

    phone: Optional[str] = Field(
        default=None,
        max_length=20,
        description="ç”µè¯å·ç "
    )

    avatar: Optional[str] = Field(
        default=None,
        max_length=255,
        description="å¤´åƒ URL"
    )

    bio: Optional[str] = Field(
        default=None,
        sa_column=Column(Text),  # TEXT ç±»å‹ï¼ˆæ— é•¿åº¦é™åˆ¶ï¼‰
        description="ä¸ªäººç®€ä»‹"
    )

    # ========== 4. çŠ¶æ€æ•°æ® ==========
    is_active: bool = Field(
        default=True,
        description="è´¦æˆ·æ˜¯å¦æ¿€æ´»"
    )

    is_verified: bool = Field(
        default=False,
        description="é‚®ç®±æ˜¯å¦éªŒè¯"
    )

    is_superuser: bool = Field(
        default=False,
        description="æ˜¯å¦è¶…çº§ç®¡ç†å‘˜"
    )

    # ========== 5. å®‰å…¨å®¡è®¡æ•°æ® ==========
    last_login: Optional[datetime] = Field(
        default=None,
        description="æœ€åç™»å½•æ—¶é—´"
    )

    login_count: int = Field(
        default=0,
        description="ç™»å½•æ¬¡æ•°ç»Ÿè®¡"
    )

    failed_login_count: int = Field(
        default=0,
        description="å¤±è´¥ç™»å½•æ¬¡æ•°"
    )

    locked_until: Optional[datetime] = Field(
        default=None,
        description="è´¦æˆ·é”å®šæˆªæ­¢æ—¶é—´"
    )

    created_at: Optional[datetime] = Field(
        default_factory=datetime.now,
        description="åˆ›å»ºæ—¶é—´"
    )

    updated_at: Optional[datetime] = Field(
        default_factory=datetime.now,
        description="æ›´æ–°æ—¶é—´"
    )

    # ========== 6. å…³ç³»æ•°æ® ==========
    roles: List["Role"] = Relationship(
        back_populates="users",
        link_model=UserRoleLink
    )

    permissions: List["Permission"] = Relationship(
        back_populates="users",
        link_model=UserPermissionLink
    )
```

#### æ•°æ®ç±»å‹æ˜ å°„è¡¨

| Python ç±»å‹ | SQLModel å­—æ®µ        | SQLite ç±»å‹   | MySQL ç±»å‹  | PostgreSQL ç±»å‹ |
| ----------- | -------------------- | ------------- | ----------- | --------------- |
| int         | Field()              | INTEGER       | INT         | INTEGER         |
| str         | Field(max_length=50) | VARCHAR(50)   | VARCHAR(50) | VARCHAR(50)     |
| str         | Column(Text)         | TEXT          | TEXT        | TEXT            |
| bool        | Field()              | INTEGER (0/1) | TINYINT(1)  | BOOLEAN         |
| datetime    | Field()              | TIMESTAMP     | DATETIME    | TIMESTAMP       |
| Optional[T] | Field(default=None)  | NULL          | NULL        | NULL            |

### 2. å…³è”å…³ç³»å»ºæ¨¡

#### å¤šå¯¹å¤šå…³ç³»å®ç°

```python
# å…³ç³»1: User â†â†’ Role
class UserRoleLink(SQLModel, table=True):
    """
    ç”¨æˆ·-è§’è‰²å…³è”è¡¨

    æ•°æ®ç»“æ„ï¼š
    - å¤åˆä¸»é”® (user_id, role_id)
    - å¤–é”®çº¦æŸ + çº§è”åˆ é™¤
    """
    __tablename__ = "user_roles"

    user_id: Optional[int] = Field(
        default=None,
        foreign_key="users.id",      # å¤–é”®æŒ‡å‘ users è¡¨
        primary_key=True,             # å¤åˆä¸»é”®çš„ä¸€éƒ¨åˆ†
        ondelete="CASCADE"            # ç”¨æˆ·åˆ é™¤æ—¶çº§è”åˆ é™¤å…³è”
    )

    role_id: Optional[int] = Field(
        default=None,
        foreign_key="roles.id",       # å¤–é”®æŒ‡å‘ roles è¡¨
        primary_key=True,             # å¤åˆä¸»é”®çš„ä¸€éƒ¨åˆ†
        ondelete="CASCADE"            # è§’è‰²åˆ é™¤æ—¶çº§è”åˆ é™¤å…³è”
    )

# æ•°æ®åº“è¡¨ç»“æ„ï¼š
CREATE TABLE user_roles (
    user_id INTEGER NOT NULL,
    role_id INTEGER NOT NULL,
    PRIMARY KEY (user_id, role_id),
    FOREIGN KEY (user_id) REFERENCES users(id) ON DELETE CASCADE,
    FOREIGN KEY (role_id) REFERENCES roles(id) ON DELETE CASCADE
);
```

#### å…³ç³»æ•°æ®å­˜å‚¨ç¤ºä¾‹

```
users è¡¨:
â”Œâ”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ id â”‚ username â”‚ email             â”‚
â”œâ”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ 1  â”‚ admin    â”‚ admin@example.com â”‚
â”‚ 2  â”‚ editor   â”‚ editor@example.comâ”‚
â””â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

roles è¡¨:
â”Œâ”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ id â”‚ name  â”‚ display  â”‚
â”œâ”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ 1  â”‚ admin â”‚ ç®¡ç†å‘˜    â”‚
â”‚ 2  â”‚ editorâ”‚ ç¼–è¾‘     â”‚
â””â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

user_roles è¡¨ (å…³è”è¡¨):
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ user_id â”‚ role_id â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ 1       â”‚ 1       â”‚  â† admin ç”¨æˆ·æœ‰ admin è§’è‰²
â”‚ 2       â”‚ 2       â”‚  â† editor ç”¨æˆ·æœ‰ editor è§’è‰²
â”‚ 1       â”‚ 2       â”‚  â† admin ç”¨æˆ·ä¹Ÿæœ‰ editor è§’è‰²
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## æ•°æ®å­˜å‚¨ç­–ç•¥

### 1. å››å±‚å­˜å‚¨æ¶æ„

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Layer 1: å†…å­˜å¯¹è±¡ (Runtime Objects)                         â”‚
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚ â”‚ AuthManager.current_user: UserSession                   â”‚ â”‚
â”‚ â”‚ - ç”Ÿå‘½å‘¨æœŸ: å•æ¬¡è¯·æ±‚                                     â”‚ â”‚
â”‚ â”‚ - è®¿é—®é€Ÿåº¦: æœ€å¿« (~0.001ms)                              â”‚ â”‚
â”‚ â”‚ - å®¹é‡: 1 ä¸ªå¯¹è±¡                                         â”‚ â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Layer 2: å†…å­˜ç¼“å­˜ (Memory Cache)                            â”‚
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚ â”‚ SessionManager._sessions: Dict[str, UserSession]        â”‚ â”‚
â”‚ â”‚ - ç”Ÿå‘½å‘¨æœŸ: åº”ç”¨è¿è¡ŒæœŸé—´                                 â”‚ â”‚
â”‚ â”‚ - è®¿é—®é€Ÿåº¦: å¾ˆå¿« (~0.01ms)                               â”‚ â”‚
â”‚ â”‚ - å®¹é‡: æ‰€æœ‰æ´»è·ƒä¼šè¯                                     â”‚ â”‚
â”‚ â”‚ - æ•°æ®ç»“æ„: å“ˆå¸Œè¡¨ {token: session}                      â”‚ â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Layer 3: æµè§ˆå™¨å­˜å‚¨ (Browser Storage)                       â”‚
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚ â”‚ app.storage.user = {                                    â”‚ â”‚
â”‚ â”‚   'auth_session_token': 'xxx...',                       â”‚ â”‚
â”‚ â”‚   'auth_remember_token': 'yyy...'                       â”‚ â”‚
â”‚ â”‚ }                                                        â”‚ â”‚
â”‚ â”‚ - ç”Ÿå‘½å‘¨æœŸ: æµè§ˆå™¨ä¼šè¯ / æŒä¹…åŒ–                          â”‚ â”‚
â”‚ â”‚ - è®¿é—®é€Ÿåº¦: å¿« (~1ms)                                    â”‚ â”‚
â”‚ â”‚ - å®¹é‡: ä»… token                                         â”‚ â”‚
â”‚ â”‚ - å®ç°: Cookie / LocalStorage                            â”‚ â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Layer 4: æ•°æ®åº“ (Database)                                  â”‚
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚ â”‚ Tables: users, roles, permissions, user_roles, ...      â”‚ â”‚
â”‚ â”‚ - ç”Ÿå‘½å‘¨æœŸ: æ°¸ä¹…                                         â”‚ â”‚
â”‚ â”‚ - è®¿é—®é€Ÿåº¦: è¾ƒæ…¢ (~10ms)                                 â”‚ â”‚
â”‚ â”‚ - å®¹é‡: æ‰€æœ‰ç”¨æˆ·æ•°æ®                                     â”‚ â”‚
â”‚ â”‚ - ç‰¹æ€§: æŒä¹…åŒ–ã€äº‹åŠ¡ã€ç´¢å¼•                               â”‚ â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 2. æ•°æ®å­˜å‚¨æ ¼å¼

#### Layer 1: å†…å­˜å¯¹è±¡

```python
# AuthManager.current_user
<UserSession å¯¹è±¡>
    â”œâ”€ id: 1
    â”œâ”€ username: 'admin'
    â”œâ”€ email: 'admin@example.com'
    â”œâ”€ roles: ['admin', 'editor']  # List[str]
    â””â”€ permissions: {'user.create', 'content.edit', ...}  # Set[str]
```

#### Layer 2: å†…å­˜ç¼“å­˜

```python
# SessionManager._sessions
{
    'token_abc123': <UserSession å¯¹è±¡ 1>,
    'token_def456': <UserSession å¯¹è±¡ 2>,
    'token_ghi789': <UserSession å¯¹è±¡ 3>,
}
```

#### Layer 3: æµè§ˆå™¨å­˜å‚¨

```javascript
// app.storage.user (å®é™…æ˜¯ Cookie æˆ– LocalStorage)
{
    "auth_session_token": "vJgkT9X_mP4nQ1wL...",  // 32å­—èŠ‚ base64
    "auth_remember_token": "8hR3Ks_Zn2Vm5Yj..."   // å¯é€‰
}
```

#### Layer 4: æ•°æ®åº“

```sql
-- users è¡¨
SELECT * FROM users WHERE id = 1;

â”Œâ”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ id â”‚ username â”‚ email             â”‚ password_hash â”‚ is_active   â”‚ ...     â”‚
â”œâ”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ 1  â”‚ admin    â”‚ admin@example.com â”‚ $sha256$...   â”‚ 1           â”‚ ...     â”‚
â””â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 3. å­˜å‚¨ç­–ç•¥é€‰æ‹©

| æ•°æ®ç±»å‹      | å­˜å‚¨ä½ç½®        | åŸå›                            |
| ------------- | --------------- | ------------------------------ |
| ç”¨æˆ·åŸºæœ¬ä¿¡æ¯  | æ•°æ®åº“ + ç¼“å­˜   | éœ€è¦æŒä¹…åŒ–ï¼Œé¢‘ç¹è®¿é—®éœ€ç¼“å­˜     |
| å¯†ç å“ˆå¸Œ      | ä»…æ•°æ®åº“        | å®‰å…¨æ•æ„Ÿï¼Œä¸ç¼“å­˜               |
| Session Token | æ•°æ®åº“ + æµè§ˆå™¨ | éªŒè¯éœ€è¦ï¼Œæµè§ˆå™¨æŒä¹…åŒ–         |
| è§’è‰²æƒé™      | æ•°æ®åº“ + ç¼“å­˜   | å…³ç³»æ•°æ®æŒä¹…åŒ–ï¼Œæƒé™è®¡ç®—åç¼“å­˜ |
| ç™»å½•æ¬¡æ•°      | ä»…æ•°æ®åº“        | ç»Ÿè®¡æ•°æ®ï¼Œæ— éœ€ç¼“å­˜             |
| å½“å‰ç”¨æˆ·çŠ¶æ€  | æ‰€æœ‰å±‚          | æœ€é«˜é¢‘è®¿é—®ï¼Œå¤šå±‚åŠ é€Ÿ           |

---

## æ•°æ®è·å–æœºåˆ¶

### 1. æ•°æ®æŸ¥è¯¢æ–¹å¼

#### æ–¹å¼ 1: ä¸»é”®æŸ¥è¯¢ï¼ˆæœ€å¿«ï¼‰

```python
# é€šè¿‡ä¸»é”® ID ç›´æ¥è·å–
with get_db() as session:
    user = session.get(User, user_id)  # O(1) ç´¢å¼•æŸ¥è¯¢

# SQL: SELECT * FROM users WHERE id = ?
# æ€§èƒ½: ~1ms (æœ‰ç´¢å¼•)
```

#### æ–¹å¼ 2: å”¯ä¸€ç´¢å¼•æŸ¥è¯¢

```python
# é€šè¿‡ username æˆ– emailï¼ˆæœ‰å”¯ä¸€ç´¢å¼•ï¼‰
with get_db() as session:
    user = session.exec(
        select(User).where(User.username == 'admin')
    ).first()

# SQL: SELECT * FROM users WHERE username = ? LIMIT 1
# æ€§èƒ½: ~2ms (æœ‰å”¯ä¸€ç´¢å¼•)
```

#### æ–¹å¼ 3: æ¡ä»¶æŸ¥è¯¢

```python
# é€šè¿‡å¤šä¸ªæ¡ä»¶
with get_db() as session:
    users = session.exec(
        select(User).where(
            User.is_active == True,
            User.created_at > some_date
        )
    ).all()

# SQL: SELECT * FROM users WHERE is_active = 1 AND created_at > ?
# æ€§èƒ½: ~10ms (å–å†³äºæ•°æ®é‡)
```

#### æ–¹å¼ 4: å…³è”æŸ¥è¯¢

```python
# è‡ªåŠ¨åŠ è½½å…³è”æ•°æ®
with get_db() as session:
    user = session.get(User, user_id)
    # SQLModel è‡ªåŠ¨å¤„ç†å…³ç³»åŠ è½½
    roles = user.roles  # æ‡’åŠ è½½æˆ–ç«‹å³åŠ è½½

    for role in roles:
        permissions = role.permissions  # å†æ¬¡åŠ è½½

# SQLModel ä¼˜åŠ¿: ä¸éœ€è¦æ‰‹åŠ¨ joinedload
```

### 2. æ•°æ®åŠ è½½ç­–ç•¥

#### æ‡’åŠ è½½ (Lazy Loading)

```python
# è®¿é—®æ—¶æ‰æŸ¥è¯¢
user = session.get(User, 1)        # åªæŸ¥è¯¢ user è¡¨
print(user.username)               # âœ“ ä¸è§¦å‘é¢å¤–æŸ¥è¯¢

roles = user.roles                 # âœ— æ­¤æ—¶æ‰æŸ¥è¯¢ user_roles å’Œ roles
for role in roles:
    print(role.name)
```

**ä¼˜åŠ¿**: èŠ‚çœåˆå§‹æŸ¥è¯¢æ—¶é—´  
**åŠ£åŠ¿**: N+1 æŸ¥è¯¢é—®é¢˜

#### é¢„åŠ è½½ä¼˜åŒ–ï¼ˆN+1 é—®é¢˜è§£å†³ï¼‰

```python
# æ–¹æ¡ˆ1: ä½¿ç”¨ SQLModel çš„è‡ªåŠ¨ä¼˜åŒ–
# SQLModel ä¼šåœ¨å¿…è¦æ—¶è‡ªåŠ¨ä¼˜åŒ–æŸ¥è¯¢

# æ–¹æ¡ˆ2: æ‰¹é‡æŸ¥è¯¢ç”¨æˆ·æ—¶é¢„åŠ è½½
with get_db() as session:
    users = session.exec(select(User)).all()

    # æ–¹å¼1: æ‰‹åŠ¨é¢„åŠ è½½
    user_ids = [u.id for u in users]
    roles_query = session.exec(
        select(Role).join(UserRoleLink).where(
            UserRoleLink.user_id.in_(user_ids)
        )
    ).all()

    # æ–¹å¼2: è®© SQLModel å¤„ç†
    # è®¿é—® user.roles æ—¶ï¼ŒSQLModel ä¼šä¼˜åŒ–æŸ¥è¯¢
```

### 3. ç¼“å­˜å‘½ä¸­ç­–ç•¥

```python
def check_session(self) -> Optional[UserSession]:
    """
    å››çº§ç¼“å­˜æŸ¥è¯¢æµç¨‹
    """

    # Level 1: æ£€æŸ¥å®ä¾‹ç¼“å­˜ (æœ€å¿«)
    if self.current_user:
        return self.current_user  # å‘½ä¸­ç‡: ~80%ï¼Œè€—æ—¶: 0.001ms

    # Level 2: ä»æµè§ˆå™¨è·å– token
    token = app.storage.user.get(self._session_key)
    if not token:
        return None  # æœªç™»å½•

    # Level 3: æ£€æŸ¥å†…å­˜ç¼“å­˜
    user_session = session_manager.get_session(token)
    if user_session:
        self.current_user = user_session
        return user_session  # å‘½ä¸­ç‡: ~15%ï¼Œè€—æ—¶: 0.01ms

    # Level 4: æ•°æ®åº“æŸ¥è¯¢ (æœ€æ…¢)
    with get_db() as session:
        user = session.exec(
            select(User).where(User.session_token == token)
        ).first()

        if user:
            # é‡å»ºç¼“å­˜
            user_session = session_manager.create_session(token, user)
            self.current_user = user_session
            return user_session  # å‘½ä¸­ç‡: ~5%ï¼Œè€—æ—¶: 10ms

    return None  # Token æ— æ•ˆ
```

---

## æ•°æ®ä¼ é€’æµç¨‹

### 1. ç”¨æˆ·ç™»å½•æ•°æ®æµ

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Step 1: æ•°æ®æ”¶é›† (UI â†’ Business)                             â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ login_page.py:                                               â”‚
â”‚   username_input.value  â†’  username: str                     â”‚
â”‚   password_input.value  â†’  password: str                     â”‚
â”‚   remember_checkbox.value  â†’  remember_me: bool              â”‚
â”‚                                                              â”‚
â”‚ è°ƒç”¨: auth_manager.login(username, password, remember_me)   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Step 2: æ•°æ®éªŒè¯ (Business Layer)                            â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ auth_manager.py:                                             â”‚
â”‚   1. è¾“å…¥éªŒè¯: éç©ºæ£€æŸ¥                                       â”‚
â”‚   2. æ ¼å¼éªŒè¯: username é•¿åº¦ã€email æ ¼å¼                      â”‚
â”‚   3. ä¸šåŠ¡éªŒè¯: ç”¨æˆ·å­˜åœ¨æ€§                                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Step 3: æ•°æ®åº“æŸ¥è¯¢ (ORM â†’ Database)                          â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ with get_db() as session:                                    â”‚
â”‚   user = session.exec(                                       â”‚
â”‚       select(User).where(                                    â”‚
â”‚           User.username == username                          â”‚
â”‚       )                                                      â”‚
â”‚   ).first()                                                  â”‚
â”‚                                                              â”‚
â”‚ æ•°æ®æµå‘:                                                    â”‚
â”‚   Python å¯¹è±¡ â†’ SQL æŸ¥è¯¢ â†’ æ•°æ®åº“ â†’ ç»“æœé›† â†’ User å¯¹è±¡       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Step 4: å¯†ç éªŒè¯ (Security Layer)                            â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ user.verify_password(password):                              â”‚
â”‚   input_hash = hashlib.sha256(password.encode()).hexdigest()â”‚
â”‚   return input_hash == user.password_hash                    â”‚
â”‚                                                              â”‚
â”‚ æ•°æ®è½¬æ¢:                                                    â”‚
â”‚   æ˜æ–‡å¯†ç  â†’ SHA-256 â†’ å“ˆå¸Œå€¼ â†’ æ¯”å¯¹æ•°æ®åº“å“ˆå¸Œ               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Step 5: Token ç”Ÿæˆ (Security Layer)                          â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ token = secrets.token_urlsafe(32)                            â”‚
â”‚ # ç”Ÿæˆ32å­—èŠ‚éšæœºæ•°æ®ï¼Œbase64 ç¼–ç                              â”‚
â”‚                                                              â”‚
â”‚ æ•°æ®æ›´æ–°åˆ°æ•°æ®åº“:                                             â”‚
â”‚   user.session_token = token                                â”‚
â”‚   user.last_login = datetime.now()                          â”‚
â”‚   user.login_count += 1                                     â”‚
â”‚   session.add(user)  # æ ‡è®°ä¸ºè„æ•°æ®                          â”‚
â”‚   # é€€å‡º with å—æ—¶è‡ªåŠ¨ commit                                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Step 6: æ•°æ®è½¬æ¢ (Database â†’ Cache)                          â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ user_session = UserSession.from_user(user)                   â”‚
â”‚                                                              â”‚
â”‚ æ•°æ®è½¬æ¢è¿‡ç¨‹:                                                â”‚
â”‚ User (ORMå¯¹è±¡)                                               â”‚
â”‚   â”œâ”€ user.id â†’ user_session.id                              â”‚
â”‚   â”œâ”€ user.username â†’ user_session.username                  â”‚
â”‚   â”œâ”€ user.roles (List[Role]) â†’ user_session.roles (List[str])â”‚
â”‚   â””â”€ è®¡ç®—æ‰€æœ‰æƒé™ â†’ user_session.permissions (Set[str])     â”‚
â”‚                                                              â”‚
â”‚ æƒé™è®¡ç®—:                                                    â”‚
â”‚   permissions = set()                                        â”‚
â”‚   for role in user.roles:                                   â”‚
â”‚       for perm in role.permissions:                         â”‚
â”‚           permissions.add(perm.name)                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Step 7: å¤šå±‚å­˜å‚¨ (Cache + Storage)                           â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ # å­˜å‚¨åˆ°æµè§ˆå™¨                                               â”‚
â”‚ app.storage.user['auth_session_token'] = token              â”‚
â”‚                                                              â”‚
â”‚ # å­˜å‚¨åˆ°å†…å­˜ç¼“å­˜                                             â”‚
â”‚ session_manager.create_session(token, user)                  â”‚
â”‚   â†’ _sessions[token] = user_session                          â”‚
â”‚                                                              â”‚
â”‚ # å­˜å‚¨åˆ°å®ä¾‹å˜é‡                                             â”‚
â”‚ self.current_user = user_session                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Step 8: å“åº”è¿”å› (Business â†’ UI)                             â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ return {                                                     â”‚
â”‚     'success': True,                                         â”‚
â”‚     'message': 'ç™»å½•æˆåŠŸ',                                    â”‚
â”‚     'user': user_session,  # UserSession å¯¹è±¡                â”‚
â”‚     'token': token         # Session token                   â”‚
â”‚ }                                                            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 2. æƒé™æ£€æŸ¥æ•°æ®æµ

```
ç”¨æˆ·è®¿é—®å—ä¿æŠ¤é¡µé¢
        â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ @require_permission('user.manage')   â”‚
â”‚ è£…é¥°å™¨æ‹¦æˆª                            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
             â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ auth_manager.check_session()                   â”‚
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚ â”‚ 1. self.current_user? â†’ è¿”å› (0.001ms)    â”‚ â”‚
â”‚ â”‚ 2. SessionManager._sessions[token]?        â”‚ â”‚
â”‚ â”‚    â†’ è¿”å› (0.01ms)                         â”‚ â”‚
â”‚ â”‚ 3. æ•°æ®åº“éªŒè¯ token â†’ é‡å»º UserSession     â”‚ â”‚
â”‚ â”‚    â†’ è¿”å› (10ms)                           â”‚ â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚ è¿”å›: UserSession å¯¹è±¡                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
             â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ auth_manager.has_permission('user.manage')   â”‚
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚ â”‚ 1. current_user.is_superuser? â†’ True    â”‚ â”‚
â”‚ â”‚ 2. 'user.manage' in current_user.        â”‚ â”‚
â”‚ â”‚     permissions? â†’ True/False            â”‚ â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚ æƒé™æ£€æŸ¥: Set æˆå‘˜æµ‹è¯• O(1)                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
             â†“
      [True/False]
             â†“
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”
    â†“                 â†“
  å…è®¸è®¿é—®          æ‹’ç»è®¿é—®
  æ‰§è¡Œå‡½æ•°       è·³è½¬æ— æƒé™é¡µé¢
```

---

## æ•°æ®è½¬æ¢ä¸æ˜ å°„

### 1. æ•°æ®åº“ â†’ ORM å¯¹è±¡

```python
# æ•°æ®åº“åŸå§‹æ•°æ®
Row in Database:
{
    'id': 1,
    'username': 'admin',
    'password_hash': '$sha256$...',
    'is_active': 1,  # SQLite å¸ƒå°”å€¼
    'created_at': '2024-01-01 10:00:00',
    ...
}

â†“ SQLModel è‡ªåŠ¨æ˜ å°„ â†“

# Python ORM å¯¹è±¡
user = User(
    id=1,
    username='admin',
    password_hash='$sha256$...',
    is_active=True,        # è‡ªåŠ¨è½¬æ¢ 1 â†’ True
    created_at=datetime(2024, 1, 1, 10, 0, 0),  # å­—ç¬¦ä¸² â†’ datetime
    ...
)
```

### 2. ORM å¯¹è±¡ â†’ ä¸šåŠ¡å¯¹è±¡

```python
# SQLModel User å¯¹è±¡ï¼ˆå®Œæ•´æ•°æ®ï¼‰
user = User(
    id=1,
    username='admin',
    email='admin@example.com',
    password_hash='$sha256$...',  # âœ— æ•æ„Ÿæ•°æ®
    session_token='abc123...',    # âœ— æ•æ„Ÿæ•°æ®
    is_active=True,
    roles=[Role(...), Role(...)], # âœ— å¤æ‚å¯¹è±¡
    ...
)

â†“ UserSession.from_user() è½¬æ¢ â†“

# UserSession å¯¹è±¡ï¼ˆç²¾ç®€ + é¢„è®¡ç®—ï¼‰
user_session = UserSession(
    id=1,
    username='admin',
    email='admin@example.com',
    # password_hash: ä¸åŒ…å«
    # session_token: ä¸åŒ…å«
    is_active=True,
    roles=['admin', 'editor'],          # âœ“ ç®€åŒ–ä¸ºå­—ç¬¦ä¸²åˆ—è¡¨
    permissions={'user.create',         # âœ“ é¢„è®¡ç®—æ‰€æœ‰æƒé™
                 'user.edit',
                 'content.create',
                 ...}
)
```

**è½¬æ¢åŸå› ï¼š**

1. **å®‰å…¨æ€§**: ç§»é™¤æ•æ„Ÿå­—æ®µï¼ˆpassword_hash, tokenï¼‰
2. **æ€§èƒ½**: é¢„è®¡ç®—æƒé™ï¼Œé¿å…é‡å¤æŸ¥è¯¢
3. **ç®€åŒ–**: å¤æ‚å¯¹è±¡å…³ç³»è½¬ä¸ºç®€å•æ•°æ®ç±»å‹
4. **ç¼“å­˜å‹å¥½**: çº¯æ•°æ®å¯¹è±¡ï¼Œé€‚åˆåºåˆ—åŒ–

### 3. ä¸šåŠ¡å¯¹è±¡ â†’ JSON å“åº”

```python
# UserSession å¯¹è±¡
user_session = UserSession(...)

â†“ åºåˆ—åŒ– â†“

# JSON å“åº”ï¼ˆAPIï¼‰
{
    "id": 1,
    "username": "admin",
    "email": "admin@example.com",
    "full_name": "ç³»ç»Ÿç®¡ç†å‘˜",
    "is_active": true,
    "roles": ["admin", "editor"],
    "permissions": ["user.create", "user.edit", ...],
    "created_at": "2024-01-01T10:00:00Z"
}
```

### 4. è¡¨å•æ•°æ® â†’ ORM å¯¹è±¡

```python
# å‰ç«¯è¡¨å•æ•°æ®
form_data = {
    'username': 'newuser',
    'email': 'user@example.com',
    'password': 'password123',  # æ˜æ–‡
    'full_name': 'æ–°ç”¨æˆ·'
}

â†“ éªŒè¯ + è½¬æ¢ â†“

# åˆ›å»º User å¯¹è±¡
user = User(
    username=form_data['username'],
    email=form_data['email'],
    full_name=form_data['full_name'],
    # å¯†ç éœ€è¦ç‰¹æ®Šå¤„ç†
)

# å¯†ç åŠ å¯†
user.set_password(form_data['password'])
# å†…éƒ¨: password_hash = hashlib.sha256(password.encode()).hexdigest()

â†“ ä¿å­˜åˆ°æ•°æ®åº“ â†“

with get_db() as session:
    session.add(user)
    # è‡ªåŠ¨ç”Ÿæˆ idï¼Œè®¾ç½® created_at ç­‰é»˜è®¤å€¼
```

---

## æ•°æ®ç”Ÿå‘½å‘¨æœŸç®¡ç†

### 1. æ•°æ®åˆ›å»ºæµç¨‹

```python
def register(username, email, password):
    """ç”¨æˆ·æ³¨å†Œ - å®Œæ•´æ•°æ®åˆ›å»ºæµç¨‹"""

    # Phase 1: æ•°æ®éªŒè¯
    if not validate_email(email):
        return {'success': False}

    # Phase 2: åˆ›å»º ORM å¯¹è±¡
    user = User(
        username=username,
        email=email,
        # ä»¥ä¸‹å­—æ®µä½¿ç”¨é»˜è®¤å€¼
        # is_active=True (é»˜è®¤)
        # login_count=0 (é»˜è®¤)
        # created_at=datetime.now() (è‡ªåŠ¨)
    )

    # Phase 3: è®¾ç½®å¯†ç 
    user.set_password(password)
    # â†’ å†…éƒ¨ç”Ÿæˆ password_hash

    # Phase 4: åˆ†é…é»˜è®¤è§’è‰²
    with get_db() as session:
        default_role = session.exec(
            select(Role).where(Role.name == 'user')
        ).first()

        if default_role:
            user.roles.append(default_role)
            # â†’ è‡ªåŠ¨æ’å…¥ user_roles å…³è”è¡¨

        # Phase 5: æŒä¹…åŒ–
        session.add(user)
        # é€€å‡º with å—æ—¶:
        # 1. session.commit() æäº¤äº‹åŠ¡
        # 2. æ•°æ®åº“åˆ†é… id
        # 3. è§¦å‘å™¨æ›´æ–° created_at
        # 4. å¤–é”®çº¦æŸéªŒè¯

    # Phase 6: åˆ›å»ºç¼“å­˜ï¼ˆå¯é€‰ï¼‰
    # æ³¨å†Œä¸ç«‹å³åˆ›å»ºä¼šè¯ï¼Œç”±ç™»å½•æ—¶åˆ›å»º
```

### 2. æ•°æ®è¯»å–æµç¨‹

```python
def get_user_with_permissions(user_id):
    """è¯»å–ç”¨æˆ·åŠå…¶å®Œæ•´æƒé™"""

    with get_db() as session:
        # Step 1: æŸ¥è¯¢ç”¨æˆ·
        user = session.get(User, user_id)
        if not user:
            return None

        # Step 2: è®¿é—®å…³è”æ•°æ®
        # SQLModel è‡ªåŠ¨åŠ è½½å…³ç³»
        roles = user.roles  # List[Role]

        # Step 3: éå†åµŒå¥—å…³ç³»
        all_permissions = set()
        for role in roles:
            permissions = role.permissions  # List[Permission]
            for perm in permissions:
                all_permissions.add(perm.name)

        # Step 4: æ•°æ®è½¬æ¢
        user_session = UserSession.from_user(user)

        return user_session
```

### 3. æ•°æ®æ›´æ–°æµç¨‹

```python
def update_user_profile(user_id, **updates):
    """æ›´æ–°ç”¨æˆ·èµ„æ–™"""

    with get_db() as session:
        # Step 1: è·å–å¯¹è±¡
        user = session.get(User, user_id)
        if not user:
            return {'success': False}

        # Step 2: ä¿®æ”¹å­—æ®µ
        for field, value in updates.items():
            if hasattr(user, field):
                setattr(user, field, value)

        # Step 3: æ›´æ–°æ—¶é—´æˆ³
        user.updated_at = datetime.now()

        # Step 4: æ ‡è®°è„æ•°æ®
        session.add(user)

        # Step 5: æäº¤ï¼ˆé€€å‡º with æ—¶ï¼‰
        # â†’ ç”Ÿæˆ UPDATE SQL
        # â†’ æ‰§è¡Œäº‹åŠ¡

        # Step 6: æ›´æ–°ç¼“å­˜
        token = get_current_token()
        if token:
            session.refresh(user)  # é‡æ–°åŠ è½½å…³ç³»
            session_manager.update_session(token, user)
```

### 4. æ•°æ®åˆ é™¤æµç¨‹

```python
def delete_user(user_id):
    """åˆ é™¤ç”¨æˆ·"""

    with get_db() as session:
        # Step 1: è·å–å¯¹è±¡
        user = session.get(User, user_id)
        if not user:
            return {'success': False}

        # Step 2: åˆ é™¤å¯¹è±¡
        session.delete(user)

        # Step 3: çº§è”åˆ é™¤ï¼ˆè‡ªåŠ¨ï¼‰
        # å› ä¸ºè®¾ç½®äº† ondelete="CASCADE"
        # â†’ è‡ªåŠ¨åˆ é™¤ user_roles ä¸­çš„å…³è”
        # â†’ è‡ªåŠ¨åˆ é™¤ user_permissions ä¸­çš„å…³è”
        # â†’ è‡ªåŠ¨åˆ é™¤ login_logs ä¸­çš„æ—¥å¿—

        # Step 4: æ¸…é™¤ç¼“å­˜
        # æŸ¥æ‰¾å¹¶åˆ é™¤è¯¥ç”¨æˆ·çš„æ‰€æœ‰ä¼šè¯
        for token, session_obj in session_manager.get_all_sessions().items():
            if session_obj.id == user_id:
                session_manager.delete_session(token)

        # Step 5: æ¸…é™¤æµè§ˆå™¨ tokenï¼ˆå¦‚æœæ˜¯å½“å‰ç”¨æˆ·ï¼‰
        if auth_manager.current_user and auth_manager.current_user.id == user_id:
            app.storage.user.pop('auth_session_token', None)
            app.storage.user.pop('auth_remember_token', None)
            auth_manager.current_user = None
```

---

## æ•°æ®ä¸€è‡´æ€§ä¿éšœ

### 1. äº‹åŠ¡ç®¡ç†

```python
@contextmanager
def get_db():
    """è‡ªåŠ¨äº‹åŠ¡ç®¡ç†"""
    session = Session(engine)
    try:
        yield session
        session.commit()    # âœ“ æˆåŠŸæäº¤
    except Exception as e:
        session.rollback()  # âœ— å¤±è´¥å›æ»š
        raise
    finally:
        session.close()     # æ€»æ˜¯å…³é—­

# ä½¿ç”¨ç¤ºä¾‹
with get_db() as session:
    user = User(...)
    session.add(user)

    role = Role(...)
    session.add(role)

    # ä¸¤ä¸ªæ“ä½œåœ¨åŒä¸€äº‹åŠ¡ä¸­
    # è¦ä¹ˆéƒ½æˆåŠŸï¼Œè¦ä¹ˆéƒ½å¤±è´¥
```

### 2. ç¼“å­˜åŒæ­¥ç­–ç•¥

```python
def update_user_data(user_id, updates):
    """æ›´æ–°ç”¨æˆ·æ•°æ®å¹¶åŒæ­¥ç¼“å­˜"""

    # Step 1: æ›´æ–°æ•°æ®åº“
    with get_db() as session:
        user = session.get(User, user_id)
        for k, v in updates.items():
            setattr(user, k, v)
        session.add(user)
        # commit åœ¨è¿™é‡Œå‘ç”Ÿ

        # Step 2: ç«‹å³åˆ·æ–°å¯¹è±¡
        session.refresh(user)  # é‡æ–°åŠ è½½å…³ç³»æ•°æ®

        # Step 3: æ›´æ–°æ‰€æœ‰ç¼“å­˜å±‚
        # æ‰¾åˆ°è¯¥ç”¨æˆ·çš„æ‰€æœ‰ token
        for token, cached_session in session_manager.get_all_sessions().items():
            if cached_session.id == user_id:
                # é‡æ–°åˆ›å»º UserSession
                new_session = UserSession.from_user(user)
                session_manager.update_session(token, user)

        # Step 4: æ›´æ–°å½“å‰ç”¨æˆ·ç¼“å­˜
        if auth_manager.current_user and auth_manager.current_user.id == user_id:
            auth_manager.current_user = UserSession.from_user(user)
```

### 3. å¹¶å‘æ§åˆ¶

```python
# ä¹è§‚é” - ä½¿ç”¨ç‰ˆæœ¬å·
class User(SQLModel, table=True):
    version: int = Field(default=0)  # ç‰ˆæœ¬å·å­—æ®µ

def update_with_optimistic_lock(user_id, updates):
    with get_db() as session:
        user = session.get(User, user_id)
        old_version = user.version

        # ä¿®æ”¹æ•°æ®
        for k, v in updates.items():
            setattr(user, k, v)

        user.version += 1  # å¢åŠ ç‰ˆæœ¬å·
        session.add(user)

        # æäº¤æ—¶æ£€æŸ¥ç‰ˆæœ¬
        try:
            session.commit()
        except IntegrityError:
            # ç‰ˆæœ¬å†²çªï¼Œè¯´æ˜è¢«å…¶ä»–è¿›ç¨‹ä¿®æ”¹äº†
            session.rollback()
            raise ConflictError("æ•°æ®å·²è¢«ä¿®æ”¹ï¼Œè¯·åˆ·æ–°åé‡è¯•")
```

---

## æ•°æ®å®‰å…¨æœºåˆ¶

### 1. å¯†ç å­˜å‚¨å®‰å…¨

```python
class User(SQLModel, table=True):
    password_hash: str  # åªå­˜å‚¨å“ˆå¸Œå€¼

    def set_password(self, password: str):
        """è®¾ç½®å¯†ç  - å•å‘åŠ å¯†"""
        # SHA-256 å“ˆå¸Œ
        self.password_hash = hashlib.sha256(
            password.encode('utf-8')
        ).hexdigest()
        # æ˜æ–‡å¯†ç ä¸ä¿å­˜ï¼Œä¸å¯é€†

    def verify_password(self, password: str) -> bool:
        """éªŒè¯å¯†ç  - å“ˆå¸Œæ¯”å¯¹"""
        input_hash = hashlib.sha256(
            password.encode('utf-8')
        ).hexdigest()
        return input_hash == self.password_hash
```

**å®‰å…¨ç‰¹æ€§ï¼š**

- âœ“ ä¸å­˜å‚¨æ˜æ–‡å¯†ç 
- âœ“ å•å‘åŠ å¯†ï¼ˆä¸å¯é€†ï¼‰
- âœ“ æ•°æ®åº“æ³„éœ²ä¹Ÿæ— æ³•è·å–åŸå¯†ç 
- âœ— å½©è™¹è¡¨æ”»å‡»ï¼ˆå¯ç”¨ bcrypt å¢å¼ºï¼‰

### 2. Token å®‰å…¨æœºåˆ¶

```python
# Token ç”Ÿæˆ
token = secrets.token_urlsafe(32)
# ç”Ÿæˆ 32 å­—èŠ‚ï¼ˆ256ä½ï¼‰éšæœºæ•°æ®
# Base64 URL å®‰å…¨ç¼–ç 
# ç»“æœ: 'vJgkT9X_mP4nQ1wL...' (43 å­—ç¬¦)

# å®‰å…¨ç‰¹æ€§
1. å¯†ç å­¦å®‰å…¨çš„éšæœºæ•°ç”Ÿæˆå™¨
2. é«˜ç†µå€¼ (2^256 ç§å¯èƒ½)
3. æš´åŠ›ç ´è§£å‡ ä¹ä¸å¯èƒ½
4. æ¯æ¬¡ç™»å½•ç”Ÿæˆæ–° token
```

### 3. SQL æ³¨å…¥é˜²æŠ¤

```python
# âœ— ä¸å®‰å…¨ - SQL æ³¨å…¥é£é™©
query = f"SELECT * FROM users WHERE username = '{username}'"

# âœ“ å®‰å…¨ - å‚æ•°åŒ–æŸ¥è¯¢
user = session.exec(
    select(User).where(User.username == username)
).first()

# SQLModel è‡ªåŠ¨è½¬æ¢ä¸ºå‚æ•°åŒ–æŸ¥è¯¢:
# SQL: SELECT * FROM users WHERE username = ?
# Parameters: ['admin']
```

### 4. æƒé™éªŒè¯

```python
# å¤šå±‚æƒé™æ£€æŸ¥
def has_permission(permission_name):
    # Layer 1: æœªç™»å½•
    if not current_user:
        return False

    # Layer 2: è¶…çº§ç®¡ç†å‘˜
    if current_user.is_superuser:
        return True  # ç»•è¿‡æ‰€æœ‰æ£€æŸ¥

    # Layer 3: ç²¾ç¡®æƒé™
    return permission_name in current_user.permissions
```

---

## æ€§èƒ½ä¼˜åŒ–ç­–ç•¥

### 1. æŸ¥è¯¢ä¼˜åŒ–

```python
# âŒ N+1 æŸ¥è¯¢é—®é¢˜
users = session.exec(select(User)).all()
for user in users:
    print(user.roles)  # æ¯ä¸ªç”¨æˆ·è§¦å‘ä¸€æ¬¡æŸ¥è¯¢
# æ€»æŸ¥è¯¢æ•°: 1 + N

# âœ… é¢„åŠ è½½ä¼˜åŒ–
# SQLModel ä¼šæ™ºèƒ½ä¼˜åŒ–ï¼Œä½†å¦‚æœéœ€è¦æ‰‹åŠ¨ä¼˜åŒ–:
from sqlalchemy.orm import selectinload

users = session.exec(
    select(User).options(
        selectinload(User.roles).selectinload(Role.permissions)
    )
).all()
# æ€»æŸ¥è¯¢æ•°: 3 (users + roles + permissions)
```

### 2. ç´¢å¼•ä¼˜åŒ–

```sql
-- åˆ›å»ºçš„ç´¢å¼•
CREATE INDEX idx_users_username ON users(username);
CREATE INDEX idx_users_email ON users(email);
CREATE INDEX idx_users_session_token ON users(session_token);

-- æŸ¥è¯¢æ€§èƒ½å¯¹æ¯”
-- æ— ç´¢å¼•: å…¨è¡¨æ‰«æ O(n) ~100ms (10000 æ¡è®°å½•)
-- æœ‰ç´¢å¼•: B-Tree æŸ¥æ‰¾ O(log n) ~2ms
```

### 3. ç¼“å­˜ç­–ç•¥

```python
# ä¸‰çº§ç¼“å­˜åŠ é€Ÿ
# Level 1: å•ä¾‹ç¼“å­˜
current_user: UserSession  # å‘½ä¸­ç‡ 80%ï¼Œ0.001ms

# Level 2: å“ˆå¸Œè¡¨ç¼“å­˜
_sessions: Dict[str, UserSession]  # å‘½ä¸­ç‡ 15%ï¼Œ0.01ms

# Level 3: æ•°æ®åº“
Database query  # å‘½ä¸­ç‡ 5%ï¼Œ10ms

# æ€§èƒ½æå‡
å¹³å‡è®¿é—®æ—¶é—´ = 0.80 * 0.001 + 0.15 * 0.01 + 0.05 * 10
            = 0.0008 + 0.0015 + 0.5
            = 0.502 ms

æ— ç¼“å­˜å¹³å‡æ—¶é—´ = 10 ms
æ€§èƒ½æå‡ = 10 / 0.502 â‰ˆ 20 å€
```

### 4. æ‰¹é‡æ“ä½œä¼˜åŒ–

```python
# âŒ é€ä¸ªæ’å…¥
for user_data in user_list:
    user = User(**user_data)
    session.add(user)
    session.commit()  # æ¯æ¬¡éƒ½æäº¤
# æ—¶é—´: N * (æ’å…¥æ—¶é—´ + äº‹åŠ¡å¼€é”€)

# âœ… æ‰¹é‡æ’å…¥
session.add_all([
    User(**data) for data in user_list
])
session.commit()  # ä¸€æ¬¡æäº¤
# æ—¶é—´: æ’å…¥æ—¶é—´ + 1æ¬¡äº‹åŠ¡å¼€é”€
```

---

## æ•°æ®æµåŠ¨å®Œæ•´ç¤ºä¾‹

### ç”¨æˆ·æ³¨å†Œåˆ°ç™»å½•çš„å®Œæ•´æ•°æ®æµ

```
1. ç”¨æˆ·å¡«å†™æ³¨å†Œè¡¨å•
   â†“
   form_data = {
       'username': 'newuser',
       'email': 'user@example.com',
       'password': 'password123'
   }

2. æäº¤åˆ°åç«¯
   â†“
   auth_manager.register(**form_data)

3. åˆ›å»º User å¯¹è±¡
   â†“
   user = User(
       username='newuser',
       email='user@example.com',
       password_hash='<sha256-hash>'  # åŠ å¯†å
   )

4. ä¿å­˜åˆ°æ•°æ®åº“
   â†“
   INSERT INTO users (username, email, password_hash, ...)
   VALUES ('newuser', 'user@example.com', '<hash>', ...);
   â†“
   [Database] users è¡¨æ–°å¢ä¸€è¡Œ

5. ç”¨æˆ·ç™»å½•
   â†“
   auth_manager.login('newuser', 'password123')

6. æŸ¥è¯¢æ•°æ®åº“
   â†“
   SELECT * FROM users WHERE username = 'newuser';
   â†“
   user: User å¯¹è±¡ (ORM)

7. éªŒè¯å¯†ç 
   â†“
   user.verify_password('password123') â†’ True

8. ç”Ÿæˆ token
   â†“
   token = 'vJgkT9X_mP4nQ1wL...'

9. æ›´æ–°æ•°æ®åº“
   â†“
   UPDATE users SET session_token = '<token>' WHERE id = <user_id>;

10. åˆ›å»ºä¼šè¯å¯¹è±¡
    â†“
    user_session = UserSession.from_user(user)

11. å­˜å‚¨åˆ°å¤šå±‚ç¼“å­˜
    â†“
    app.storage.user['token'] = token          # æµè§ˆå™¨
    session_manager._sessions[token] = session # å†…å­˜
    auth_manager.current_user = session        # å®ä¾‹

12. è¿”å›ç»™å‰ç«¯
    â†“
    {'success': True, 'user': user_session}

13. å‰ç«¯å­˜å‚¨ tokenï¼Œåç»­è¯·æ±‚æºå¸¦
    â†“
    æ¯æ¬¡è¯·æ±‚: Cookie: token=vJgkT9X_...

14. æƒé™æ£€æŸ¥
    â†“
    @require_permission('user.create')
    â†“
    ä»ç¼“å­˜è·å– user_session
    â†“
    æ£€æŸ¥ 'user.create' in user_session.permissions
    â†“
    å…è®¸/æ‹’ç»è®¿é—®
```

---

## æ€»ç»“

### æ•°æ®ç®¡ç†æ ¸å¿ƒè¦ç‚¹

1. **å››å±‚å­˜å‚¨æ¶æ„**

   - å†…å­˜å¯¹è±¡ï¼ˆæœ€å¿«ï¼‰
   - å†…å­˜ç¼“å­˜ï¼ˆå¾ˆå¿«ï¼‰
   - æµè§ˆå™¨å­˜å‚¨ï¼ˆå¿«ï¼‰
   - æ•°æ®åº“ï¼ˆæŒä¹…ï¼‰

2. **æ•°æ®è½¬æ¢é“¾è·¯**

   - è¡¨å• â†’ éªŒè¯ â†’ ORM â†’ æ•°æ®åº“
   - æ•°æ®åº“ â†’ ORM â†’ ä¸šåŠ¡å¯¹è±¡ â†’ ç¼“å­˜ â†’ UI

3. **ä¸€è‡´æ€§ä¿éšœ**

   - äº‹åŠ¡ç®¡ç†ï¼ˆACIDï¼‰
   - ç¼“å­˜åŒæ­¥ï¼ˆå®æ—¶æ›´æ–°ï¼‰
   - ä¹è§‚é”ï¼ˆå¹¶å‘æ§åˆ¶ï¼‰

4. **å®‰å…¨æœºåˆ¶**

   - å¯†ç åŠ å¯†ï¼ˆå•å‘å“ˆå¸Œï¼‰
   - Token å®‰å…¨ï¼ˆé«˜ç†µéšæœºæ•°ï¼‰
   - SQL æ³¨å…¥é˜²æŠ¤ï¼ˆå‚æ•°åŒ–æŸ¥è¯¢ï¼‰

5. **æ€§èƒ½ä¼˜åŒ–**
   - å¤šçº§ç¼“å­˜ï¼ˆ20 å€æå‡ï¼‰
   - ç´¢å¼•ä¼˜åŒ–ï¼ˆ50 å€æå‡ï¼‰
   - æ‰¹é‡æ“ä½œï¼ˆN å€æå‡ï¼‰
   - é¢„åŠ è½½å…³ç³»ï¼ˆé¿å… N+1ï¼‰

è¿™ä¸ªæ•°æ®ç®¡ç†ç³»ç»Ÿé€šè¿‡ç²¾å¿ƒè®¾è®¡çš„åˆ†å±‚æ¶æ„ã€é«˜æ•ˆçš„ç¼“å­˜ç­–ç•¥å’Œä¸¥æ ¼çš„å®‰å…¨æœºåˆ¶ï¼Œå®ç°äº†é«˜æ€§èƒ½ã€é«˜å®‰å…¨æ€§ã€æ˜“ç»´æŠ¤çš„è®¤è¯æ•°æ®ç®¡ç†ã€‚
