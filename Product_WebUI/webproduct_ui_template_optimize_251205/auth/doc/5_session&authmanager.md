# Session ç®¡ç†åŸç†æ·±åº¦å‰–æ

## ğŸ“‹ ç›®å½•

1. [Session ç®¡ç†æ¦‚è¿°](#session-ç®¡ç†æ¦‚è¿°)
2. [æ ¸å¿ƒæ¶æ„è®¾è®¡](#æ ¸å¿ƒæ¶æ„è®¾è®¡)
3. [Token æœºåˆ¶è¯¦è§£](#token-æœºåˆ¶è¯¦è§£)
4. [å››çº§ç¼“å­˜ä½“ç³»](#å››çº§ç¼“å­˜ä½“ç³»)
5. [Session ç”Ÿå‘½å‘¨æœŸ](#session-ç”Ÿå‘½å‘¨æœŸ)
6. [æ•°æ®åŒæ­¥æœºåˆ¶](#æ•°æ®åŒæ­¥æœºåˆ¶)
7. [å¹¶å‘å¤„ç†ç­–ç•¥](#å¹¶å‘å¤„ç†ç­–ç•¥)
8. [å®‰å…¨æœºåˆ¶](#å®‰å…¨æœºåˆ¶)
9. [æ€§èƒ½ä¼˜åŒ–](#æ€§èƒ½ä¼˜åŒ–)
10. [æ•…éšœæ¢å¤](#æ•…éšœæ¢å¤)

---

## Session ç®¡ç†æ¦‚è¿°

### ä»€ä¹ˆæ˜¯ Sessionï¼Ÿ

Sessionï¼ˆä¼šè¯ï¼‰æ˜¯æœåŠ¡å™¨ç«¯ç”¨æ¥è·Ÿè¸ªç”¨æˆ·çŠ¶æ€çš„æœºåˆ¶ã€‚åœ¨æœ¬ç³»ç»Ÿä¸­ï¼ŒSession åŒ…å«ä¸¤å±‚å«ä¹‰ï¼š

1. **å¹¿ä¹‰ Session**: ç”¨æˆ·ä»ç™»å½•åˆ°ç™»å‡ºçš„æ•´ä¸ªäº¤äº’è¿‡ç¨‹
2. **ç‹­ä¹‰ Session**: å†…å­˜ä¸­å­˜å‚¨çš„ç”¨æˆ·çŠ¶æ€å¯¹è±¡ `UserSession`

### Session çš„æ ¸å¿ƒèŒè´£

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                   Session æ ¸å¿ƒèŒè´£                       â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                         â”‚
â”‚  1ï¸âƒ£ èº«ä»½è¯†åˆ«                                            â”‚
â”‚     - é€šè¿‡ token è¯†åˆ«ç”¨æˆ·èº«ä»½                            â”‚
â”‚     - éªŒè¯ token æœ‰æ•ˆæ€§                                 â”‚
â”‚     - é˜²æ­¢ä¼ªé€ å’Œé‡æ”¾æ”»å‡»                                â”‚
â”‚                                                         â”‚
â”‚  2ï¸âƒ£ çŠ¶æ€ä¿æŒ                                            â”‚
â”‚     - åœ¨å¤šä¸ªè¯·æ±‚é—´ä¿æŒç”¨æˆ·ç™»å½•çŠ¶æ€                       â”‚
â”‚     - å­˜å‚¨ç”¨æˆ·çš„æƒé™ä¿¡æ¯                                â”‚
â”‚     - ç¼“å­˜å¸¸ç”¨æ•°æ®å‡å°‘æ•°æ®åº“æŸ¥è¯¢                         â”‚
â”‚                                                         â”‚
â”‚  3ï¸âƒ£ å®‰å…¨æ§åˆ¶                                            â”‚
â”‚     - Session è¿‡æœŸç®¡ç†                                  â”‚
â”‚     - é˜²æ­¢ Session åŠ«æŒ                                 â”‚
â”‚     - æ”¯æŒè¿œç¨‹ç™»å‡ºï¼ˆè¸¢äººï¼‰                              â”‚
â”‚                                                         â”‚
â”‚  4ï¸âƒ£ æ€§èƒ½ä¼˜åŒ–                                            â”‚
â”‚     - å¤šçº§ç¼“å­˜åŠ é€Ÿè®¿é—®                                  â”‚
â”‚     - å‡å°‘æ•°æ®åº“å‹åŠ›                                    â”‚
â”‚     - é¢„è®¡ç®—æƒé™ä¿¡æ¯                                    â”‚
â”‚                                                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## æ ¸å¿ƒæ¶æ„è®¾è®¡

### 1. ä¸‰å¤§æ ¸å¿ƒç»„ä»¶

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                  Session ç®¡ç†æ¶æ„                       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â”‚
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚                   â”‚                   â”‚
        â–¼                   â–¼                   â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ AuthManager  â”‚   â”‚SessionManagerâ”‚   â”‚ UserSession  â”‚
â”‚  è®¤è¯ç®¡ç†å™¨   â”‚   â”‚  ä¼šè¯ç®¡ç†å™¨   â”‚   â”‚  ä¼šè¯å¯¹è±¡    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
â”‚                   â”‚                   â”‚
â”‚ èŒè´£:             â”‚ èŒè´£:             â”‚ æ•°æ®ç»“æ„:
â”‚ - login/logout   â”‚ - ç¼“å­˜ç®¡ç†        â”‚ - ç”¨æˆ·åŸºæœ¬ä¿¡æ¯
â”‚ - èº«ä»½éªŒè¯       â”‚ - CRUD æ“ä½œ       â”‚ - è§’è‰²åˆ—è¡¨
â”‚ - Session æ£€æŸ¥   â”‚ - å†…å­˜å­˜å‚¨        â”‚ - æƒé™é›†åˆ
â”‚ - ä¸šåŠ¡é€»è¾‘       â”‚ - å¿«é€ŸæŸ¥è¯¢        â”‚ - çŠ¶æ€æ ‡å¿—
â”‚                   â”‚                   â”‚
â”‚ å•ä¾‹å¯¹è±¡:         â”‚ å•ä¾‹å¯¹è±¡:         â”‚ æ•°æ®å¯¹è±¡:
â”‚ auth_manager     â”‚ session_manager   â”‚ æ¯ä¸ªç”¨æˆ·ä¸€ä¸ª
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 2. ç»„ä»¶è¯¦ç»†è¯´æ˜

#### AuthManagerï¼ˆè®¤è¯ç®¡ç†å™¨ï¼‰

```python
class AuthManager:
    """
    è®¤è¯ç®¡ç†å™¨ - Session ç®¡ç†çš„æ€»æ§åˆ¶å™¨

    æ ¸å¿ƒå±æ€§:
        current_user: Optional[UserSession]  # L1ç¼“å­˜ï¼šå½“å‰ç”¨æˆ·
        _session_key: str = 'auth_session_token'  # æµè§ˆå™¨key
        _remember_key: str = 'auth_remember_token'  # è®°ä½æˆ‘key

    æ ¸å¿ƒæ–¹æ³•:
        login()          â†’ åˆ›å»º Session
        logout()         â†’ é”€æ¯ Session
        check_session()  â†’ éªŒè¯ Session
        update_profile() â†’ æ›´æ–° Session
    """

    def __init__(self):
        self.current_user: Optional[UserSession] = None
        self._session_key = 'auth_session_token'
        self._remember_key = 'auth_remember_token'
```

**è®¾è®¡äº®ç‚¹:**

- å•ä¾‹æ¨¡å¼ï¼šå…¨å±€å”¯ä¸€çš„ `auth_manager` å®ä¾‹
- current_user ä½œä¸º L1 ç¼“å­˜ï¼Œæœ€å¿«è®¿é—®é€Ÿåº¦
- ç»Ÿä¸€çš„ Session æ“ä½œå…¥å£

#### SessionManagerï¼ˆä¼šè¯ç®¡ç†å™¨ï¼‰

```python
class SessionManager:
    """
    ä¼šè¯ç®¡ç†å™¨ - å†…å­˜ç¼“å­˜å±‚

    æ ¸å¿ƒå±æ€§:
        _sessions: Dict[str, UserSession]  # token â†’ UserSession æ˜ å°„

    æ ¸å¿ƒæ–¹æ³•:
        create_session(token, user)  â†’ åˆ›å»ºå¹¶ç¼“å­˜
        get_session(token)           â†’ ä»ç¼“å­˜è·å–
        update_session(token, user)  â†’ æ›´æ–°ç¼“å­˜
        delete_session(token)        â†’ åˆ é™¤ç¼“å­˜
        clear_all_sessions()         â†’ æ¸…ç©ºæ‰€æœ‰
    """

    def __init__(self):
        self._sessions: Dict[str, UserSession] = {}
```

**è®¾è®¡äº®ç‚¹:**

- å“ˆå¸Œè¡¨å­˜å‚¨ï¼ŒO(1) æŸ¥è¯¢æ—¶é—´
- å†…å­˜ç¼“å­˜ï¼Œæé€Ÿè®¿é—®ï¼ˆ~0.01msï¼‰
- æ”¯æŒæ‰¹é‡ç®¡ç†ï¼ˆè¸¢äººã€æ¸…ç©ºï¼‰

#### UserSessionï¼ˆä¼šè¯å¯¹è±¡ï¼‰

```python
@dataclass
class UserSession:
    """
    ç”¨æˆ·ä¼šè¯å¯¹è±¡ - è½»é‡çº§æ•°æ®ç»“æ„

    ç‰¹ç‚¹:
    1. ä¸åŒ…å«æ•æ„Ÿæ•°æ®ï¼ˆpassword_hash, tokenï¼‰
    2. é¢„è®¡ç®—æ‰€æœ‰æƒé™ï¼ˆé¿å…é‡å¤æŸ¥è¯¢ï¼‰
    3. çº¯æ•°æ®å¯¹è±¡ï¼ˆå¯åºåˆ—åŒ–ï¼‰
    4. é€‚åˆç¼“å­˜å­˜å‚¨
    """
    # åŸºæœ¬ä¿¡æ¯
    id: int
    username: str
    email: str
    full_name: Optional[str] = None

    # çŠ¶æ€ä¿¡æ¯
    is_active: bool = True
    is_superuser: bool = False

    # æƒé™ä¿¡æ¯ï¼ˆé¢„è®¡ç®—ï¼‰
    roles: List[str] = field(default_factory=list)
    permissions: Set[str] = field(default_factory=set)

    # ä¸šåŠ¡æ–¹æ³•
    def has_role(self, role_name: str) -> bool:
        return role_name in self.roles

    def has_permission(self, permission_name: str) -> bool:
        return self.is_superuser or permission_name in self.permissions
```

**è®¾è®¡äº®ç‚¹:**

- ä» Userï¼ˆæ•°æ®åº“å¯¹è±¡ï¼‰è§£è€¦
- åªä¿ç•™è¿è¡Œæ—¶å¿…éœ€æ•°æ®
- æƒé™é¢„è®¡ç®—ï¼ŒO(1) æ£€æŸ¥é€Ÿåº¦
- @dataclass è‡ªåŠ¨ç”Ÿæˆæ–¹æ³•

---

## Token æœºåˆ¶è¯¦è§£

### 1. åŒ Token è®¾è®¡

ç³»ç»Ÿé‡‡ç”¨åŒ Token æœºåˆ¶ï¼Œå¹³è¡¡å®‰å…¨æ€§å’Œç”¨æˆ·ä½“éªŒï¼š

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚               åŒ Token æ¶æ„                           â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                      â”‚
â”‚  Token 1: session_tokenï¼ˆä¼šè¯ä»¤ç‰Œï¼‰                 â”‚
â”‚  â”œâ”€ ç”¨é€”: çŸ­æœŸèº«ä»½éªŒè¯                               â”‚
â”‚  â”œâ”€ ç”Ÿå‘½å‘¨æœŸ: 24å°æ—¶ï¼ˆå¯é…ç½®ï¼‰                       â”‚
â”‚  â”œâ”€ å­˜å‚¨ä½ç½®: æµè§ˆå™¨ + æ•°æ®åº“ + å†…å­˜                 â”‚
â”‚  â”œâ”€ å®‰å…¨æ€§: é«˜ï¼ˆçŸ­æœŸæœ‰æ•ˆï¼‰                           â”‚
â”‚  â””â”€ åº”ç”¨åœºæ™¯: æ¯æ¬¡è¯·æ±‚çš„èº«ä»½éªŒè¯                     â”‚
â”‚                                                      â”‚
â”‚  Token 2: remember_tokenï¼ˆè®°ä½æˆ‘ä»¤ç‰Œï¼‰              â”‚
â”‚  â”œâ”€ ç”¨é€”: é•¿æœŸå…ç™»å½•                                 â”‚
â”‚  â”œâ”€ ç”Ÿå‘½å‘¨æœŸ: 30å¤©ï¼ˆå¯é…ç½®ï¼‰                         â”‚
â”‚  â”œâ”€ å­˜å‚¨ä½ç½®: æµè§ˆå™¨ + æ•°æ®åº“                        â”‚
â”‚  â”œâ”€ å®‰å…¨æ€§: ä¸­ï¼ˆè‡ªåŠ¨é‡æ–°è®¤è¯ï¼‰                       â”‚
â”‚  â””â”€ åº”ç”¨åœºæ™¯: session_token è¿‡æœŸæ—¶è‡ªåŠ¨ç»­æœŸ          â”‚
â”‚                                                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 2. Token ç”Ÿæˆæœºåˆ¶

```python
import secrets

# Token ç”Ÿæˆ
def generate_token() -> str:
    """
    ç”Ÿæˆå¯†ç å­¦å®‰å…¨çš„éšæœº Token

    æŠ€æœ¯ç»†èŠ‚:
    1. secrets.token_urlsafe(32)
       - ç”Ÿæˆ 32 å­—èŠ‚ï¼ˆ256 ä½ï¼‰éšæœºæ•°æ®
       - ä½¿ç”¨æ“ä½œç³»ç»Ÿçš„å¯†ç å­¦éšæœºæ•°ç”Ÿæˆå™¨
       - Base64 URL å®‰å…¨ç¼–ç ï¼ˆä¸å« +/=ï¼‰

    2. ç»“æœç¤ºä¾‹:
       'vJgkT9X_mP4nQ1wLrHsYzM3bN7KqPfDc8uW2eRt6'
       - é•¿åº¦: 43 å­—ç¬¦
       - å­—ç¬¦é›†: [A-Za-z0-9_-]
       - ç†µå€¼: 2^256 ç§å¯èƒ½

    3. å®‰å…¨æ€§:
       - æš´åŠ›ç ´è§£æ—¶é—´: 2^256 / (10^12 æ¬¡/ç§’) â‰ˆ 10^59 å¹´
       - ç¢°æ’æ¦‚ç‡: å‡ ä¹ä¸å¯èƒ½
    """
    return secrets.token_urlsafe(32)

# å®é™…ä½¿ç”¨
session_token = secrets.token_urlsafe(32)  # ä¼šè¯ token
remember_token = secrets.token_urlsafe(32)  # è®°ä½æˆ‘ token
```

### 3. Token å­˜å‚¨ä½ç½®

```
ç”¨æˆ·ç™»å½•æˆåŠŸåï¼ŒToken çš„ä¸‰é‡å­˜å‚¨ï¼š

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ å­˜å‚¨å±‚ 1: æµè§ˆå™¨ï¼ˆBrowser Storageï¼‰                  â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ app.storage.user = {                                â”‚
â”‚     'auth_session_token': 'xxx...',    # ä¼šè¯token â”‚
â”‚     'auth_remember_token': 'yyy...'    # è®°ä½æˆ‘tokenâ”‚
â”‚ }                                                   â”‚
â”‚                                                     â”‚
â”‚ å®ç°æœºåˆ¶: NiceGUI çš„ app.storage.user               â”‚
â”‚ åº•å±‚æŠ€æœ¯: Cookie / LocalStorage                     â”‚
â”‚ ç”Ÿå‘½å‘¨æœŸ: è·Ÿéšæµè§ˆå™¨ä¼šè¯ / æŒä¹…åŒ–                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ å­˜å‚¨å±‚ 2: æ•°æ®åº“ï¼ˆDatabaseï¼‰                         â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ users è¡¨å­—æ®µ:                                        â”‚
â”‚   - session_token: VARCHAR(255)                     â”‚
â”‚   - remember_token: VARCHAR(255)                    â”‚
â”‚                                                     â”‚
â”‚ ä½œç”¨:                                                â”‚
â”‚   - æŒä¹…åŒ–å­˜å‚¨                                       â”‚
â”‚   - è·¨æœåŠ¡å™¨éªŒè¯                                     â”‚
â”‚   - æ”¯æŒè¸¢äººï¼ˆæ¸…ç©º tokenï¼‰                           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ å­˜å‚¨å±‚ 3: å†…å­˜ç¼“å­˜ï¼ˆMemory Cacheï¼‰                   â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ SessionManager._sessions = {                        â”‚
â”‚     'token_xxx': UserSession(...),                  â”‚
â”‚     'token_yyy': UserSession(...),                  â”‚
â”‚ }                                                   â”‚
â”‚                                                     â”‚
â”‚ ä½œç”¨:                                                â”‚
â”‚   - å¿«é€ŸæŸ¥è¯¢ï¼ˆO(1)ï¼‰                                 â”‚
â”‚   - å‡å°‘æ•°æ®åº“å‹åŠ›                                   â”‚
â”‚   - ç¼“å­˜ç”¨æˆ·æƒé™                                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 4. Token éªŒè¯æµç¨‹

```python
def check_session(self) -> Optional[UserSession]:
    """
    Session éªŒè¯çš„å››çº§æŸ¥æ‰¾æœºåˆ¶

    è®¾è®¡ç†å¿µ: ç”±å¿«åˆ°æ…¢ï¼Œé€çº§é™çº§
    """

    # â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
    # Level 1: æ£€æŸ¥å®ä¾‹ç¼“å­˜ï¼ˆæœ€å¿«ï¼‰
    # â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
    if self.current_user:
        # å‘½ä¸­ç‡: ~80% ï¼ˆåŒä¸€è¯·æ±‚å†…å¤šæ¬¡è°ƒç”¨ï¼‰
        # è€—æ—¶: ~0.001ms
        return self.current_user

    # â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
    # Level 2: ä»æµè§ˆå™¨è·å– token
    # â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
    session_token = app.storage.user.get(self._session_key)
    if not session_token:
        # ç”¨æˆ·æœªç™»å½•ï¼Œç›´æ¥è¿”å›
        return None

    # â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
    # Level 3: æ£€æŸ¥å†…å­˜ç¼“å­˜
    # â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
    user_session = session_manager.get_session(session_token)
    if user_session:
        # å‘½ä¸­ç‡: ~15% ï¼ˆè·¨è¯·æ±‚ï¼Œç¼“å­˜å‘½ä¸­ï¼‰
        # è€—æ—¶: ~0.01ms
        self.current_user = user_session  # å†™å…¥ L1 ç¼“å­˜
        return user_session

    # â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
    # Level 4: æ•°æ®åº“éªŒè¯ï¼ˆæœ€æ…¢ï¼Œæœ€æƒå¨ï¼‰
    # â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
    with get_db() as session:
        user = session.exec(
            select(User).where(
                User.session_token == session_token,
                User.is_active == True
            )
        ).first()

        if user:
            # å‘½ä¸­ç‡: ~5% ï¼ˆæœåŠ¡å™¨é‡å¯ã€ç¼“å­˜å¤±æ•ˆï¼‰
            # è€—æ—¶: ~10ms

            # é‡å»ºå¤šçº§ç¼“å­˜
            user_session = session_manager.create_session(
                session_token, user
            )  # å†™å…¥ L2 ç¼“å­˜
            self.current_user = user_session  # å†™å…¥ L1 ç¼“å­˜

            return user_session
        else:
            # Token æ— æ•ˆï¼ˆè¿‡æœŸã€è¢«ç¯¡æ”¹ã€ç”¨æˆ·å·²åˆ é™¤ï¼‰
            # æ¸…é™¤æµè§ˆå™¨çš„æ— æ•ˆ token
            app.storage.user.pop(self._session_key, None)
            return None

    # â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
    # Level 5: Remember Me æœºåˆ¶ï¼ˆå¯é€‰ï¼‰
    # â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
    remember_token = app.storage.user.get(self._remember_key)
    if remember_token and auth_config.allow_remember_me:
        # ä½¿ç”¨ remember_token è‡ªåŠ¨é‡æ–°ç™»å½•
        # ï¼ˆè¯¦è§ä¸‹æ–‡ Remember Me æœºåˆ¶ï¼‰
        pass

    return None
```

---

## å››çº§ç¼“å­˜ä½“ç³»

### 1. ç¼“å­˜å±‚çº§æ¶æ„

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              å››çº§ç¼“å­˜ä½“ç³»æ¶æ„å›¾                       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

è¯·æ±‚åˆ°è¾¾
   â”‚
   â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ L1: AuthManager.current_user           â”‚  â—„â”€ æœ€å¿«
â”‚ â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â” â”‚
â”‚ ç±»å‹: å®ä¾‹å˜é‡                          â”‚
â”‚ å®¹é‡: 1 ä¸ªç”¨æˆ·                          â”‚
â”‚ ç”Ÿå‘½å‘¨æœŸ: å•æ¬¡è¯·æ±‚                      â”‚
â”‚ è®¿é—®æ—¶é—´: ~0.001ms                      â”‚
â”‚ å‘½ä¸­ç‡: ~80%                            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
   â”‚ æœªå‘½ä¸­
   â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ L2: SessionManager._sessions           â”‚  â—„â”€ å¾ˆå¿«
â”‚ â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â” â”‚
â”‚ ç±»å‹: Dict[token, UserSession]         â”‚
â”‚ å®¹é‡: æ‰€æœ‰åœ¨çº¿ç”¨æˆ·                      â”‚
â”‚ ç”Ÿå‘½å‘¨æœŸ: åº”ç”¨è¿è¡ŒæœŸé—´                  â”‚
â”‚ è®¿é—®æ—¶é—´: ~0.01ms                       â”‚
â”‚ å‘½ä¸­ç‡: ~15%                            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
   â”‚ æœªå‘½ä¸­
   â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ L3: app.storage.user (Browser)         â”‚  â—„â”€ å¿«
â”‚ â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â” â”‚
â”‚ ç±»å‹: Cookie / LocalStorage            â”‚
â”‚ å®¹é‡: token å­—ç¬¦ä¸²                      â”‚
â”‚ ç”Ÿå‘½å‘¨æœŸ: æµè§ˆå™¨ä¼šè¯ / æŒä¹…åŒ–           â”‚
â”‚ è®¿é—®æ—¶é—´: ~1ms                          â”‚
â”‚ å‘½ä¸­ç‡: ~100% (å·²ç™»å½•ç”¨æˆ·)              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
   â”‚ Token å­˜åœ¨
   â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ L4: Database (users è¡¨)                 â”‚  â—„â”€ è¾ƒæ…¢
â”‚ â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â” â”‚
â”‚ ç±»å‹: å…³ç³»æ•°æ®åº“                        â”‚
â”‚ å®¹é‡: æ‰€æœ‰ç”¨æˆ·                          â”‚
â”‚ ç”Ÿå‘½å‘¨æœŸ: æ°¸ä¹…                          â”‚
â”‚ è®¿é—®æ—¶é—´: ~10ms                         â”‚
â”‚ å‘½ä¸­ç‡: ~5%                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 2. æ€§èƒ½å¯¹æ¯”åˆ†æ

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ç¼“å­˜å±‚  â”‚ è®¿é—®æ—¶é—´ â”‚ å‘½ä¸­ç‡   â”‚ å®¹é‡     â”‚ æŒä¹…æ€§   â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ L1      â”‚ 0.001ms  â”‚ ~80%     â”‚ 1 ç”¨æˆ·   â”‚ è¯·æ±‚å†…   â”‚
â”‚ L2      â”‚ 0.01ms   â”‚ ~15%     â”‚ å…¨éƒ¨     â”‚ è¿›ç¨‹å†…   â”‚
â”‚ L3      â”‚ 1ms      â”‚ ~100%*   â”‚ token    â”‚ æµè§ˆå™¨   â”‚
â”‚ L4      â”‚ 10ms     â”‚ ~5%      â”‚ å…¨éƒ¨     â”‚ æ°¸ä¹…     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

* L3 å‘½ä¸­ç‡æ˜¯æŒ‡å·²ç™»å½•ç”¨æˆ·ï¼Œæœªç™»å½•ç”¨æˆ·ç›´æ¥è¿”å›

å¹³å‡è®¿é—®æ—¶é—´è®¡ç®—:
T_avg = 0.80 * 0.001 + 0.15 * 0.01 + 0.05 * 10
      = 0.0008 + 0.0015 + 0.5
      = 0.502 ms

æ— ç¼“å­˜æ—¶é—´: 10 ms
æ€§èƒ½æå‡: 10 / 0.502 â‰ˆ 20 å€
```

### 3. ç¼“å­˜åŒæ­¥ç­–ç•¥

```python
# åœºæ™¯1: ç”¨æˆ·ç™»å½• â†’ å†™å…¥æ‰€æœ‰ç¼“å­˜å±‚
def login(username, password):
    with get_db() as session:
        user = session.exec(
            select(User).where(User.username == username)
        ).first()

        # éªŒè¯å¯†ç ...

        # ç”Ÿæˆ token
        token = secrets.token_urlsafe(32)
        user.session_token = token
        session.commit()  # â†’ L4: æ•°æ®åº“

        # å­˜å‚¨åˆ°æµè§ˆå™¨
        app.storage.user[self._session_key] = token  # â†’ L3

        # åˆ›å»ºä¼šè¯å¯¹è±¡
        user_session = UserSession.from_user(user)

        # å­˜å‚¨åˆ°å†…å­˜ç¼“å­˜
        session_manager.create_session(token, user)  # â†’ L2

        # å­˜å‚¨åˆ°å®ä¾‹å˜é‡
        self.current_user = user_session  # â†’ L1

# åœºæ™¯2: ç”¨æˆ·ç™»å‡º â†’ æ¸…é™¤æ‰€æœ‰ç¼“å­˜å±‚
def logout():
    token = app.storage.user.get(self._session_key)

    # æ¸…é™¤æ•°æ®åº“
    with get_db() as session:
        user = session.exec(
            select(User).where(User.session_token == token)
        ).first()
        if user:
            user.session_token = None
            user.remember_token = None
            session.commit()  # â†’ L4

    # æ¸…é™¤æµè§ˆå™¨
    app.storage.user.pop(self._session_key, None)  # â†’ L3
    app.storage.user.pop(self._remember_key, None)

    # æ¸…é™¤å†…å­˜ç¼“å­˜
    session_manager.delete_session(token)  # â†’ L2

    # æ¸…é™¤å®ä¾‹å˜é‡
    self.current_user = None  # â†’ L1

# åœºæ™¯3: æ›´æ–°ç”¨æˆ·ä¿¡æ¯ â†’ åŒæ­¥æ‰€æœ‰ç¼“å­˜å±‚
def update_profile(**updates):
    with get_db() as session:
        user = session.get(User, current_user.id)

        # æ›´æ–°å­—æ®µ
        for k, v in updates.items():
            setattr(user, k, v)

        session.commit()  # â†’ L4: æ•°æ®åº“æ›´æ–°

        # åˆ·æ–°å…³ç³»æ•°æ®
        session.refresh(user)

        # æ›´æ–°å†…å­˜ç¼“å­˜
        token = app.storage.user.get(self._session_key)
        new_session = UserSession.from_user(user)
        session_manager.update_session(token, user)  # â†’ L2

        # æ›´æ–°å®ä¾‹å˜é‡
        self.current_user = new_session  # â†’ L1

        # L3 (æµè§ˆå™¨) ä¸éœ€è¦æ›´æ–°ï¼Œåªå­˜å‚¨ token
```

---

## Session ç”Ÿå‘½å‘¨æœŸ

### 1. å®Œæ•´ç”Ÿå‘½å‘¨æœŸå›¾

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              Session å®Œæ•´ç”Ÿå‘½å‘¨æœŸ                        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

1ï¸âƒ£ åˆ›å»ºé˜¶æ®µ (Creation)
    â”‚
    â”œâ”€ ç”¨æˆ·æäº¤ç™»å½•è¡¨å•
    â”œâ”€ éªŒè¯ç”¨æˆ·åå¯†ç 
    â”œâ”€ ç”Ÿæˆ session_token
    â”œâ”€ å†™å…¥æ•°æ®åº“ (users.session_token)
    â”œâ”€ å­˜å…¥æµè§ˆå™¨ (app.storage.user)
    â”œâ”€ ç¼“å­˜åˆ°å†…å­˜ (SessionManager)
    â””â”€ åˆ›å»º UserSession å¯¹è±¡
           â”‚
           â–¼
2ï¸âƒ£ æ´»è·ƒé˜¶æ®µ (Active)
    â”‚
    â”œâ”€ ç”¨æˆ·è®¿é—®å—ä¿æŠ¤é¡µé¢
    â”œâ”€ ç³»ç»Ÿæ£€æŸ¥ Session (check_session)
    â”œâ”€ ä»ç¼“å­˜å¿«é€Ÿè·å–
    â”œâ”€ éªŒè¯æƒé™
    â””â”€ è¿”å›ç”¨æˆ·æ•°æ®
           â”‚
           â–¼
3ï¸âƒ£ æ›´æ–°é˜¶æ®µ (Update)
    â”‚
    â”œâ”€ ç”¨æˆ·ä¿®æ”¹èµ„æ–™
    â”œâ”€ æ›´æ–°æ•°æ®åº“
    â”œâ”€ åŒæ­¥æ‰€æœ‰ç¼“å­˜å±‚
    â””â”€ Session ç»§ç»­æœ‰æ•ˆ
           â”‚
           â–¼
4ï¸âƒ£ è¿‡æœŸé˜¶æ®µ (Expiration)
    â”‚
    â”œâ”€ è¾¾åˆ° session_timeout (24å°æ—¶)
    â”œâ”€ session_token å¤±æ•ˆ
    â”‚
    â”œâ”€ å¦‚æœæœ‰ remember_token:
    â”‚  â”œâ”€ éªŒè¯ remember_token
    â”‚  â”œâ”€ ç”Ÿæˆæ–° session_token
    â”‚  â””â”€ è‡ªåŠ¨ç»­æœŸï¼ˆç”¨æˆ·æ— æ„ŸçŸ¥ï¼‰
    â”‚
    â””â”€ å¦‚æœæ—  remember_token:
       â””â”€ è·³è½¬åˆ°ç™»å½•é¡µ
           â”‚
           â–¼
5ï¸âƒ£ é”€æ¯é˜¶æ®µ (Destruction)
    â”‚
    â”œâ”€ ç”¨æˆ·ä¸»åŠ¨ç™»å‡º
    â”œâ”€ æˆ–ç®¡ç†å‘˜è¸¢äºº
    â”œâ”€ æ¸…é™¤æ•°æ®åº“ token
    â”œâ”€ æ¸…é™¤æµè§ˆå™¨ token
    â”œâ”€ åˆ é™¤å†…å­˜ç¼“å­˜
    â””â”€ Session å½»åº•å¤±æ•ˆ
```

### 2. Session åˆ›å»ºè¯¦ç»†æµç¨‹

```python
def login(username: str, password: str, remember_me: bool = False):
    """
    Session åˆ›å»ºçš„ 10 ä¸ªæ­¥éª¤
    """

    # â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
    # Step 1: æ•°æ®éªŒè¯
    # â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
    if not username or not password:
        return {'success': False, 'message': 'è¯·è¾“å…¥ç”¨æˆ·åå’Œå¯†ç '}

    with get_db() as session:
        # â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
        # Step 2: æŸ¥è¯¢ç”¨æˆ·
        # â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
        user = session.exec(
            select(User).where(
                (User.username == username) | (User.email == username)
            )
        ).first()

        if not user:
            return {'success': False, 'message': 'ç”¨æˆ·ä¸å­˜åœ¨'}

        # â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
        # Step 3: éªŒè¯å¯†ç 
        # â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
        if not user.check_password(password):
            user.failed_login_count += 1

            # å¤±è´¥æ¬¡æ•°è¿‡å¤šï¼Œé”å®šè´¦æˆ·
            if user.failed_login_count >= auth_config.max_login_attempts:
                user.locked_until = datetime.now() + timedelta(
                    minutes=auth_config.login_lock_duration
                )

            session.commit()
            return {'success': False, 'message': 'å¯†ç é”™è¯¯'}

        # â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
        # Step 4: æ£€æŸ¥è´¦æˆ·çŠ¶æ€
        # â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
        if not user.is_active:
            return {'success': False, 'message': 'è´¦æˆ·æœªæ¿€æ´»'}

        if user.is_locked():
            remaining = (user.locked_until - datetime.now()).seconds // 60
            return {
                'success': False,
                'message': f'è´¦æˆ·å·²é”å®šï¼Œè¯· {remaining} åˆ†é’Ÿåé‡è¯•'
            }

        # â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
        # Step 5: ç”Ÿæˆ session_token
        # â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
        session_token = secrets.token_urlsafe(32)
        user.session_token = session_token

        # â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
        # Step 6: å¤„ç† Remember Me
        # â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
        if remember_me and auth_config.allow_remember_me:
            remember_token = secrets.token_urlsafe(32)
            user.remember_token = remember_token
            app.storage.user[self._remember_key] = remember_token

        # â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
        # Step 7: æ›´æ–°ç”¨æˆ·ç»Ÿè®¡
        # â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
        user.last_login = datetime.now()
        user.login_count += 1
        user.failed_login_count = 0
        user.locked_until = None

        # æäº¤åˆ°æ•°æ®åº“
        session.commit()

        # â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
        # Step 8: å­˜å‚¨åˆ°æµè§ˆå™¨
        # â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
        app.storage.user[self._session_key] = session_token

        # â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
        # Step 9: åˆ›å»ºå†…å­˜ç¼“å­˜
        # â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
        user_session = session_manager.create_session(session_token, user)
        self.current_user = user_session

        # â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
        # Step 10: è®°å½•ç™»å½•æ—¥å¿—
        # â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
        self._create_login_log(
            user_id=user.id,
            is_success=True,
            ip_address=self._get_client_ip(),
            user_agent=self._get_user_agent()
        )

        return {
            'success': True,
            'message': 'ç™»å½•æˆåŠŸ',
            'user': user_session
        }
```

### 3. Remember Me è‡ªåŠ¨ç»­æœŸæœºåˆ¶

```python
def check_session(self):
    """
    Remember Me æœºåˆ¶ - Session è‡ªåŠ¨ç»­æœŸ
    """

    # å‰é¢çš„ L1-L4 ç¼“å­˜æ£€æŸ¥...

    # â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
    # å¦‚æœ session_token å¤±æ•ˆï¼Œå°è¯• remember_token
    # â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
    remember_token = app.storage.user.get(self._remember_key)

    if remember_token and auth_config.allow_remember_me:
        with get_db() as session:
            # éªŒè¯ remember_token
            user = session.exec(
                select(User).where(
                    User.remember_token == remember_token,
                    User.is_active == True
                )
            ).first()

            if user:
                # âœ… Remember token æœ‰æ•ˆ
                # ç”Ÿæˆæ–°çš„ session_tokenï¼ˆè‡ªåŠ¨ç»­æœŸï¼‰
                new_session_token = secrets.token_urlsafe(32)
                user.session_token = new_session_token
                session.commit()

                # æ›´æ–°æµè§ˆå™¨
                app.storage.user[self._session_key] = new_session_token

                # é‡å»ºç¼“å­˜
                user_session = session_manager.create_session(
                    new_session_token, user
                )
                self.current_user = user_session

                log_success(f"Remember me éªŒè¯æˆåŠŸ: {user.username}")
                return user_session

    return None  # å½»åº•å¤±æ•ˆï¼Œéœ€è¦é‡æ–°ç™»å½•
```

---

## æ•°æ®åŒæ­¥æœºåˆ¶

### 1. æ•°æ®æµå‘å›¾

```
ç”¨æˆ·ä¿®æ”¹èµ„æ–™è¯·æ±‚
        â”‚
        â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Step 1: æ›´æ–°æ•°æ®åº“ï¼ˆæƒå¨æ•°æ®æºï¼‰        â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  with get_db() as session:               â”‚
â”‚      user = session.get(User, user_id)   â”‚
â”‚      user.full_name = new_name           â”‚
â”‚      session.commit()  # äº‹åŠ¡æäº¤        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
        â”‚
        â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Step 2: åˆ·æ–° ORM å¯¹è±¡ï¼ˆåŠ è½½å…³ç³»ï¼‰       â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  session.refresh(user)                   â”‚
â”‚  # é‡æ–°åŠ è½½ user.roles, user.permissionsâ”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
        â”‚
        â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Step 3: æ›´æ–°å†…å­˜ç¼“å­˜ï¼ˆL2ï¼‰              â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  new_session = UserSession.from_user(user)â”‚
â”‚  session_manager.update_session(         â”‚
â”‚      token, new_session                  â”‚
â”‚  )                                       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
        â”‚
        â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Step 4: æ›´æ–°å®ä¾‹ç¼“å­˜ï¼ˆL1ï¼‰              â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  self.current_user = new_session         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
        â”‚
        â–¼
    æ•°æ®åŒæ­¥å®Œæˆ
```

### 2. åŒæ­¥ç­–ç•¥

#### ç­–ç•¥ 1: å†™ç©¿é€ï¼ˆWrite-Throughï¼‰

```python
# æ›´æ–°æ—¶åŒæ­¥æ‰€æœ‰å±‚
def update_user(user_id, updates):
    # 1. æ›´æ–°æ•°æ®åº“
    with get_db() as session:
        user = session.get(User, user_id)
        for k, v in updates.items():
            setattr(user, k, v)
        session.commit()  # â† å†™å…¥æ•°æ®åº“

        # 2. ç«‹å³åŒæ­¥ç¼“å­˜
        session.refresh(user)
        new_session = UserSession.from_user(user)

        # 3. æ›´æ–°æ‰€æœ‰æ´»è·ƒ Session
        for token, cached_session in session_manager.get_all_sessions().items():
            if cached_session.id == user_id:
                session_manager.update_session(token, new_session)
```

**ä¼˜ç‚¹**: æ•°æ®ä¸€è‡´æ€§æœ€å¼º  
**ç¼ºç‚¹**: å†™å…¥æ€§èƒ½ç¨æ…¢

#### ç­–ç•¥ 2: å»¶è¿Ÿæ›´æ–°ï¼ˆLazy Updateï¼‰

```python
# è¯»å–æ—¶æ£€æŸ¥ç‰ˆæœ¬ï¼Œè¿‡æœŸåˆ™æ›´æ–°
def check_session():
    user_session = self.current_user
    if user_session:
        # æ£€æŸ¥æ˜¯å¦è¿‡æœŸï¼ˆç®€åŒ–ç¤ºä¾‹ï¼‰
        if user_session.cached_at < last_updated:
            # è¿‡æœŸï¼Œé‡æ–°åŠ è½½
            with get_db() as session:
                user = session.get(User, user_session.id)
                self.current_user = UserSession.from_user(user)
```

**ä¼˜ç‚¹**: å†™å…¥å¿«  
**ç¼ºç‚¹**: å¯èƒ½çŸ­æš‚ä¸ä¸€è‡´

### 3. ç¼“å­˜å¤±æ•ˆå¤„ç†

```python
# åœºæ™¯1: ç®¡ç†å‘˜ä¿®æ”¹ç”¨æˆ·è§’è‰²
def assign_role(user_id, role_id):
    with get_db() as session:
        user = session.get(User, user_id)
        role = session.get(Role, role_id)
        user.roles.append(role)
        session.commit()

        # âš ï¸ å…³é”®ï¼šæ¸…é™¤è¯¥ç”¨æˆ·çš„æ‰€æœ‰ Session ç¼“å­˜
        # å¼ºåˆ¶ä¸‹æ¬¡è®¿é—®æ—¶é‡æ–°åŠ è½½æƒé™
        for token, cached_session in session_manager.get_all_sessions().items():
            if cached_session.id == user_id:
                session_manager.delete_session(token)

# åœºæ™¯2: ä¿®æ”¹è§’è‰²æƒé™
def update_role_permissions(role_id, permission_ids):
    with get_db() as session:
        role = session.get(Role, role_id)
        # æ›´æ–°æƒé™...
        session.commit()

        # âš ï¸ æ¸…é™¤æ‰€æœ‰æ‹¥æœ‰è¯¥è§’è‰²çš„ç”¨æˆ·çš„ç¼“å­˜
        users_with_role = session.exec(
            select(User).join(UserRoleLink).where(
                UserRoleLink.role_id == role_id
            )
        ).all()

        for user in users_with_role:
            # æ¸…é™¤è¯¥ç”¨æˆ·çš„æ‰€æœ‰ Session
            for token, cached in session_manager.get_all_sessions().items():
                if cached.id == user.id:
                    session_manager.delete_session(token)
```

---

## å®‰å…¨æœºåˆ¶

### 1. Token å®‰å…¨

```python
# å®‰å…¨ç‰¹æ€§1: å¯†ç å­¦å®‰å…¨éšæœºæ•°
token = secrets.token_urlsafe(32)
# - ä½¿ç”¨ os.urandom() è·å–ç³»ç»Ÿç†µ
# - 256 ä½ç†µå€¼
# - æš´åŠ›ç ´è§£éœ€è¦ 10^59 å¹´

# å®‰å…¨ç‰¹æ€§2: Token è½®æ¢
# æ¯æ¬¡ç™»å½•ç”Ÿæˆæ–° tokenï¼Œæ—§ token ç«‹å³å¤±æ•ˆ
user.session_token = new_token  # è¦†ç›–æ—§ token

# å®‰å…¨ç‰¹æ€§3: Token ç»‘å®šç”¨æˆ·
# Token ä¸æºå¸¦ç”¨æˆ·ä¿¡æ¯ï¼Œéœ€è¦æ•°æ®åº“éªŒè¯
# é˜²æ­¢ Token ä¼ªé€ 
```

### 2. Session åŠ«æŒé˜²æŠ¤

```python
# é˜²æŠ¤æªæ–½1: IP åœ°å€éªŒè¯ï¼ˆå¯é€‰ï¼‰
def check_session():
    user_session = self.current_user
    if user_session:
        current_ip = self._get_client_ip()
        if current_ip != user_session.login_ip:
            # IP å˜åŒ–ï¼Œå¯èƒ½è¢«åŠ«æŒ
            self.logout()
            raise SecurityError("Session å¼‚å¸¸ï¼Œè¯·é‡æ–°ç™»å½•")

# é˜²æŠ¤æªæ–½2: User-Agent éªŒè¯
def check_session():
    current_ua = self._get_user_agent()
    if current_ua != user_session.login_ua:
        # User-Agent å˜åŒ–
        self.logout()
        raise SecurityError("è®¾å¤‡å¼‚å¸¸ï¼Œè¯·é‡æ–°ç™»å½•")

# é˜²æŠ¤æªæ–½3: Session è¶…æ—¶
# é™åˆ¶ Session æœ€é•¿æœ‰æ•ˆæœŸ
if datetime.now() - user_session.login_time > timedelta(hours=24):
    self.logout()
    return None
```

### 3. é˜²æš´åŠ›ç ´è§£

```python
# æœºåˆ¶1: å¤±è´¥æ¬¡æ•°é™åˆ¶
if user.failed_login_count >= auth_config.max_login_attempts:
    user.locked_until = datetime.now() + timedelta(
        minutes=auth_config.login_lock_duration
    )
    return {'success': False, 'message': 'è´¦æˆ·å·²é”å®š'}

# æœºåˆ¶2: éªŒè¯ç ï¼ˆæ‰©å±•ï¼‰
if user.failed_login_count >= 3:
    require_captcha = True

# æœºåˆ¶3: ç™»å½•æ—¥å¿—
self._create_login_log(
    user_id=user.id,
    is_success=False,
    ip_address=ip,
    failure_reason='å¯†ç é”™è¯¯'
)
```

---

## æ€§èƒ½ä¼˜åŒ–

### 1. æ€§èƒ½æŒ‡æ ‡

```
æ“ä½œ                    | æ— ç¼“å­˜è€—æ—¶ | æœ‰ç¼“å­˜è€—æ—¶ | æå‡å€æ•°
-----------------------|-----------|-----------|----------
æ£€æŸ¥ Session (L1å‘½ä¸­)   | 10ms      | 0.001ms   | 10,000x
æ£€æŸ¥ Session (L2å‘½ä¸­)   | 10ms      | 0.01ms    | 1,000x
æƒé™éªŒè¯ (é¢„è®¡ç®—)       | 20ms      | 0.001ms   | 20,000x
è·å–ç”¨æˆ·ä¿¡æ¯           | 10ms      | 0.01ms    | 1,000x
```

### 2. ä¼˜åŒ–æŠ€å·§

```python
# æŠ€å·§1: æ‰¹é‡åŠ è½½
# âŒ ä¸å¥½ï¼šN+1 æŸ¥è¯¢
for user_id in user_ids:
    user = session.get(User, user_id)
    print(user.roles)  # æ¯ä¸ªç”¨æˆ·ä¸€æ¬¡æŸ¥è¯¢

# âœ… å¥½ï¼šä¸€æ¬¡æ€§åŠ è½½
users = session.exec(
    select(User).where(User.id.in_(user_ids))
).all()
for user in users:
    print(user.roles)  # SQLModel è‡ªåŠ¨ä¼˜åŒ–

# æŠ€å·§2: æƒé™é¢„è®¡ç®—
# ç™»å½•æ—¶ä¸€æ¬¡æ€§è®¡ç®—æ‰€æœ‰æƒé™ï¼Œå­˜å…¥ UserSession
permissions = set()
for role in user.roles:
    for perm in role.permissions:
        permissions.add(perm.name)
user_session.permissions = permissions

# æŠ€å·§3: åˆç†çš„ç¼“å­˜å¤±æ•ˆç­–ç•¥
# é«˜é¢‘æ“ä½œï¼ˆæŸ¥è¯¢ï¼‰ï¼šä¸å¤±æ•ˆç¼“å­˜
# ä½é¢‘æ“ä½œï¼ˆä¿®æ”¹æƒé™ï¼‰ï¼šæ¸…é™¤ç›¸å…³ç¼“å­˜
```

---

## æ•…éšœæ¢å¤

### 1. æœåŠ¡å™¨é‡å¯æ¢å¤

```python
# é—®é¢˜ï¼šæœåŠ¡å™¨é‡å¯ï¼Œå†…å­˜ç¼“å­˜å…¨éƒ¨ä¸¢å¤±
# SessionManager._sessions = {}  # ç©ºäº†ï¼

# è§£å†³æ–¹æ¡ˆï¼šè‡ªåŠ¨é‡å»ºç¼“å­˜
def check_session():
    # L1, L2 éƒ½æœªå‘½ä¸­
    # è‡ªåŠ¨ä»æ•°æ®åº“ï¼ˆL4ï¼‰åŠ è½½
    with get_db() as session:
        user = session.exec(
            select(User).where(User.session_token == token)
        ).first()

        if user:
            # é‡å»ºç¼“å­˜
            user_session = session_manager.create_session(token, user)
            self.current_user = user_session
            return user_session

    return None

# ç”¨æˆ·æ— æ„ŸçŸ¥ï¼Œåªæ˜¯ç¬¬ä¸€æ¬¡è®¿é—®ç¨æ…¢ï¼ˆ~10msï¼‰
```

### 2. æ•°æ®åº“è¿æ¥å¤±è´¥

```python
def check_session():
    try:
        # å°è¯•ä»æ•°æ®åº“éªŒè¯
        with get_db() as session:
            user = session.exec(...).first()
    except DatabaseError as e:
        # æ•°æ®åº“è¿æ¥å¤±è´¥
        # é™çº§ç­–ç•¥ï¼šä¿¡ä»»å†…å­˜ç¼“å­˜
        user_session = session_manager.get_session(token)
        if user_session:
            log_warning(f"æ•°æ®åº“ä¸å¯ç”¨ï¼Œä½¿ç”¨ç¼“å­˜: {user_session.username}")
            return user_session

        # ç¼“å­˜ä¹Ÿæ²¡æœ‰ï¼Œåªèƒ½å¤±è´¥
        raise ServiceUnavailable("ç³»ç»Ÿç¹å¿™ï¼Œè¯·ç¨åé‡è¯•")
```

### 3. ç¼“å­˜æ±¡æŸ“å¤„ç†

```python
# é—®é¢˜ï¼šç¼“å­˜æ•°æ®ä¸æ•°æ®åº“ä¸ä¸€è‡´
# è§£å†³æ–¹æ¡ˆ1: å®šæœŸåˆ·æ–°
import threading

def periodic_cache_refresh():
    """æ¯5åˆ†é’Ÿåˆ·æ–°ä¸€æ¬¡ç¼“å­˜"""
    while True:
        time.sleep(300)

        # è·å–æ‰€æœ‰æ´»è·ƒ Session
        for token, cached_session in session_manager.get_all_sessions().items():
            # ä»æ•°æ®åº“é‡æ–°åŠ è½½
            with get_db() as session:
                user = session.get(User, cached_session.id)
                if user and user.session_token == token:
                    new_session = UserSession.from_user(user)
                    session_manager.update_session(token, new_session)
                else:
                    # Token å·²å¤±æ•ˆ
                    session_manager.delete_session(token)

# è§£å†³æ–¹æ¡ˆ2: å†™å…¥æ—¶å¼ºåˆ¶åŒæ­¥
# ï¼ˆè§å‰æ–‡"æ•°æ®åŒæ­¥æœºåˆ¶"ï¼‰
```

---

## æ€»ç»“

### Session ç®¡ç†æ ¸å¿ƒè¦ç‚¹

1. **ä¸‰å¤§æ ¸å¿ƒç»„ä»¶**

   - AuthManager: æ€»æ§åˆ¶å™¨
   - SessionManager: å†…å­˜ç¼“å­˜
   - UserSession: æ•°æ®è½½ä½“

2. **åŒ Token æœºåˆ¶**

   - session_token: çŸ­æœŸï¼ˆ24hï¼‰
   - remember_token: é•¿æœŸï¼ˆ30dï¼‰

3. **å››çº§ç¼“å­˜ä½“ç³»**

   - L1: å®ä¾‹å˜é‡ï¼ˆ0.001msï¼‰
   - L2: å†…å­˜å­—å…¸ï¼ˆ0.01msï¼‰
   - L3: æµè§ˆå™¨å­˜å‚¨ï¼ˆ1msï¼‰
   - L4: æ•°æ®åº“ï¼ˆ10msï¼‰
   - **ç»¼åˆæ€§èƒ½æå‡ 20 å€**

4. **å®Œæ•´ç”Ÿå‘½å‘¨æœŸ**

   - åˆ›å»º â†’ æ´»è·ƒ â†’ æ›´æ–° â†’ è¿‡æœŸ â†’ é”€æ¯
   - Remember Me è‡ªåŠ¨ç»­æœŸ

5. **æ•°æ®åŒæ­¥ç­–ç•¥**

   - å†™ç©¿é€ï¼šå¼ºä¸€è‡´æ€§
   - å»¶è¿Ÿæ›´æ–°ï¼šé«˜æ€§èƒ½
   - ç¼“å­˜å¤±æ•ˆï¼šæ¸…é™¤ç›¸å…³

6. **å®‰å…¨æœºåˆ¶**

   - å¯†ç å­¦å®‰å…¨ Token
   - é˜² Session åŠ«æŒ
   - é˜²æš´åŠ›ç ´è§£

7. **æ•…éšœæ¢å¤**
   - æœåŠ¡å™¨é‡å¯ï¼šè‡ªåŠ¨é‡å»º
   - æ•°æ®åº“å¤±è´¥ï¼šé™çº§ç­–ç•¥
   - ç¼“å­˜æ±¡æŸ“ï¼šå®šæœŸåˆ·æ–°

è¿™å¥— Session ç®¡ç†ç³»ç»Ÿé€šè¿‡ç²¾å¿ƒè®¾è®¡çš„å¤šçº§ç¼“å­˜ã€åŒ Token æœºåˆ¶å’Œå®Œå–„çš„åŒæ­¥ç­–ç•¥ï¼Œå®ç°äº†**é«˜æ€§èƒ½ã€é«˜å®‰å…¨æ€§ã€é«˜å¯ç”¨æ€§**çš„ç”¨æˆ·ä¼šè¯ç®¡ç†ï¼Œæ˜¯ webproduct_ui_template è®¤è¯ç³»ç»Ÿçš„æ ¸å¿ƒåŸºçŸ³ã€‚
