# ä¸šåŠ¡æ¨¡å‹ç³»ç»Ÿå®Œæ•´åº”ç”¨æ–‡æ¡£

## ğŸ“‹ ç›®å½•

1. [ç³»ç»Ÿæ¦‚è¿°](#ç³»ç»Ÿæ¦‚è¿°)
2. [æ ¸å¿ƒç»„ä»¶ä»‹ç»](#æ ¸å¿ƒç»„ä»¶ä»‹ç»)
3. [åŸºç¡€ä½¿ç”¨ç¤ºä¾‹](#åŸºç¡€ä½¿ç”¨ç¤ºä¾‹)
4. [å¢åˆ æ”¹æŸ¥æ“ä½œè¯¦è§£](#å¢åˆ æ”¹æŸ¥æ“ä½œè¯¦è§£)
5. [é«˜çº§åº”ç”¨åœºæ™¯](#é«˜çº§åº”ç”¨åœºæ™¯)
6. [æœ€ä½³å®è·µ](#æœ€ä½³å®è·µ)
7. [æ•…éšœæ’é™¤](#æ•…éšœæ’é™¤)

---

## ç³»ç»Ÿæ¦‚è¿°

æœ¬ä¸šåŠ¡æ¨¡å‹ç³»ç»Ÿç”±ä¸‰ä¸ªæ ¸å¿ƒè„šæœ¬ç»„æˆï¼Œæä¾›äº†å®Œæ•´çš„ä¸šåŠ¡æ•°æ®ç®¡ç†è§£å†³æ–¹æ¡ˆï¼š

- **`openai_models.py`**ï¼šå…·ä½“çš„ä¸šåŠ¡æ¨¡å‹å®šä¹‰
- **`shared_base.py`**ï¼šé€šç”¨åŸºç±»å’Œæ··å…¥ç±»
- **`business_utils.py`**ï¼šå·¥å…·ç±»å’Œè¾…åŠ©å‡½æ•°

### ğŸ¯ è®¾è®¡åŸåˆ™

1. **æ¾è€¦åˆ**ï¼šä¸šåŠ¡æ¨¡å‹ä¸è®¤è¯æ¨¡å—è§£è€¦ï¼Œé€šè¿‡å·¥å…·ç±»äº¤äº’
2. **å¯å¤ç”¨**ï¼šé€šç”¨åŠŸèƒ½æŠ½è±¡ä¸ºåŸºç±»å’Œå·¥å…·ç±»
3. **æ˜“æ‰©å±•**ï¼šæ–°å¢ä¸šåŠ¡æ¨¡å‹åªéœ€ç»§æ‰¿åŸºç±»å³å¯
4. **å®¡è®¡å®Œå¤‡**ï¼šè‡ªåŠ¨è®°å½•åˆ›å»ºè€…ã€æ›´æ–°è€…å’Œæ—¶é—´æˆ³

---

## æ ¸å¿ƒç»„ä»¶ä»‹ç»

### 1. `shared_base.py` - åŸºç¡€æ¶æ„

```python
# æä¾›ä¸‰ä¸ªæ ¸å¿ƒç±»ï¼š
TimestampMixin      # æ—¶é—´æˆ³å­—æ®µï¼ˆcreated_at, updated_atï¼‰
AuditMixin          # å®¡è®¡å­—æ®µï¼ˆcreated_by, updated_byï¼‰
BusinessBaseModel   # ä¸šåŠ¡æ¨¡å‹åŸºç±»ï¼ˆç»§æ‰¿ä¸Šè¿°ä¸¤ä¸ªæ··å…¥ç±»ï¼‰
```

### 2. `openai_models.py` - å…·ä½“ä¸šåŠ¡æ¨¡å‹

```python
# å®šä¹‰å…·ä½“çš„ä¸šåŠ¡å®ä½“ï¼š
ModelType          # æšä¸¾ï¼šæ¨¡å‹ç±»å‹
OpenAIConfig       # é…ç½®è¡¨ï¼šå­˜å‚¨OpenAI APIé…ç½®
OpenAIRequest      # è¯·æ±‚è¡¨ï¼šå­˜å‚¨APIè°ƒç”¨è®°å½•
```

### 3. `business_utils.py` - å·¥å…·ç±»é›†åˆ

```python
# æä¾›å››ä¸ªæ ¸å¿ƒå·¥å…·ç±»ï¼š
UserInfoHelper      # ç”¨æˆ·ä¿¡æ¯è·å–
AuditHelper         # å®¡è®¡å­—æ®µç®¡ç†
BusinessQueryHelper # ä¸šåŠ¡æŸ¥è¯¢æ“ä½œ
RelationshipHelper  # å…³ç³»æ•°æ®å¤„ç†
```

---

## åŸºç¡€ä½¿ç”¨ç¤ºä¾‹

### å¿«é€Ÿå¼€å§‹

```python
# 1. å¯¼å…¥å¿…è¦æ¨¡å—
from auth import auth_manager
from database_models.business_models.openai_models import OpenAIConfig, OpenAIRequest, ModelType
from database_models.business_utils import AuditHelper, UserInfoHelper
from auth.database import get_db

# 2. è·å–å½“å‰ç”¨æˆ·
current_user = auth_manager.current_user

# 3. åŸºç¡€æ“ä½œç¤ºä¾‹
def quick_start_example():
    """å¿«é€Ÿå¼€å§‹ç¤ºä¾‹"""
    with get_db() as db:
        # åˆ›å»ºé…ç½®
        config = OpenAIConfig(
            name="æˆ‘çš„ç¬¬ä¸€ä¸ªé…ç½®",
            api_key="sk-xxxxxxxxxx",
            model_name=ModelType.DEEPSEEK
        )

        # è®¾ç½®å®¡è®¡å­—æ®µ
        AuditHelper.set_audit_fields(config, current_user.id)

        db.add(config)
        db.commit()

        print(f"é…ç½®åˆ›å»ºæˆåŠŸï¼ŒID: {config.id}")
```

---

## å¢åˆ æ”¹æŸ¥æ“ä½œè¯¦è§£

### ğŸ“ åˆ›å»ºï¼ˆCreateï¼‰æ“ä½œ

#### 1. åŸºç¡€åˆ›å»º

```python
def create_openai_config_basic():
    """åŸºç¡€é…ç½®åˆ›å»º"""
    from auth import auth_manager
    from database_models.business_models.openai_models import OpenAIConfig, ModelType
    from database_models.business_utils import AuditHelper
    from auth.database import get_db

    current_user = auth_manager.current_user

    with get_db() as db:
        # åˆ›å»ºæ–°é…ç½®
        config = OpenAIConfig(
            name="DeepSeekç”Ÿäº§é…ç½®",
            api_key="sk-real-api-key-here",
            base_url="https://api.deepseek.com/v1",
            model_name=ModelType.DEEPSEEK,
            max_tokens=2000,
            temperature=75,
            is_public=False,
            description="ç”¨äºç”Ÿäº§ç¯å¢ƒçš„DeepSeeké…ç½®"
        )

        # è‡ªåŠ¨è®¾ç½®å®¡è®¡å­—æ®µ
        AuditHelper.set_audit_fields(config, current_user.id)

        db.add(config)
        db.commit()

        # è·å–åˆ›å»ºè€…ä¿¡æ¯è¿›è¡ŒéªŒè¯
        creator_info = config.get_creator_info()
        print(f"âœ… é…ç½®åˆ›å»ºæˆåŠŸ")
        print(f"é…ç½®ID: {config.id}")
        print(f"åˆ›å»ºè€…: {creator_info['username'] if creator_info else 'æœªçŸ¥'}")
        print(f"åˆ›å»ºæ—¶é—´: {config.created_at}")

        return config
```

#### 2. æ‰¹é‡åˆ›å»º

```python
def create_multiple_configs():
    """æ‰¹é‡åˆ›å»ºå¤šä¸ªé…ç½®"""
    from database_models.business_models.openai_models import OpenAIConfig, ModelType
    from database_models.business_utils import AuditHelper
    from auth.database import get_db
    from auth import auth_manager

    current_user = auth_manager.current_user

    # é…ç½®æ•°æ®
    configs_data = [
        {
            "name": "DeepSeek Chat",
            "api_key": "sk-deepseek-key",
            "model_name": ModelType.DEEPSEEK,
            "description": "ç”¨äºèŠå¤©çš„DeepSeeké…ç½®"
        },
        {
            "name": "Moonshot 8K",
            "api_key": "sk-moonshot-key",
            "base_url": "https://api.moonshot.cn/v1",
            "model_name": ModelType.MOONSHOT_V1_8K,
            "description": "Moonshot 8Kä¸Šä¸‹æ–‡é…ç½®"
        },
        {
            "name": "Moonshot 32K",
            "api_key": "sk-moonshot-key-32k",
            "base_url": "https://api.moonshot.cn/v1",
            "model_name": ModelType.MOONSHOT_V1_32K,
            "max_tokens": 4000,
            "description": "Moonshot 32Ké•¿ä¸Šä¸‹æ–‡é…ç½®"
        }
    ]

    with get_db() as db:
        created_configs = []

        for config_data in configs_data:
            config = OpenAIConfig(**config_data)
            AuditHelper.set_audit_fields(config, current_user.id)
            db.add(config)
            created_configs.append(config)

        db.commit()

        print(f"âœ… æ‰¹é‡åˆ›å»ºå®Œæˆï¼Œå…±åˆ›å»º {len(created_configs)} ä¸ªé…ç½®")
        for config in created_configs:
            print(f"  - {config.name} (ID: {config.id})")

        return created_configs
```

#### 3. åˆ›å»ºè¯·æ±‚è®°å½•

```python
def create_openai_request():
    """åˆ›å»ºOpenAIè¯·æ±‚è®°å½•"""
    from database_models.business_models.openai_models import OpenAIRequest
    from database_models.business_utils import AuditHelper
    from auth.database import get_db
    from auth import auth_manager

    current_user = auth_manager.current_user

    with get_db() as db:
        # å‡è®¾ä½¿ç”¨IDä¸º1çš„é…ç½®
        request = OpenAIRequest(
            config_id=1,
            user_id=current_user.id,  # ç›´æ¥å…³è”ç”¨æˆ·
            prompt="è¯·ä»‹ç»ä¸€ä¸‹Pythonç¼–ç¨‹è¯­è¨€",
            response="Pythonæ˜¯ä¸€ç§é«˜çº§ç¼–ç¨‹è¯­è¨€...",
            tokens_used=156,
            cost=12,  # ä»¥åˆ†ä¸ºå•ä½
            status="success"
        )

        # è®¾ç½®å®¡è®¡å­—æ®µ
        AuditHelper.set_audit_fields(request, current_user.id)

        db.add(request)
        db.commit()

        print(f"âœ… è¯·æ±‚è®°å½•åˆ›å»ºæˆåŠŸï¼ŒID: {request.id}")
        print(f"æ¶ˆè€—tokens: {request.tokens_used}")
        print(f"æˆæœ¬: {request.cost}åˆ†")

        return request
```

### ğŸ“– æŸ¥è¯¢ï¼ˆReadï¼‰æ“ä½œ

#### 1. åŸºç¡€æŸ¥è¯¢

```python
def query_configs_basic():
    """åŸºç¡€é…ç½®æŸ¥è¯¢"""
    from database_models.business_models.openai_models import OpenAIConfig
    from database_models.business_utils import UserInfoHelper
    from auth.database import get_db

    with get_db() as db:
        # æŸ¥è¯¢æ‰€æœ‰é…ç½®
        all_configs = db.query(OpenAIConfig).all()
        print(f"æ€»è®¡é…ç½®æ•°é‡: {len(all_configs)}")

        # æŸ¥è¯¢ç‰¹å®šé…ç½®
        config = db.query(OpenAIConfig).filter(OpenAIConfig.name == "DeepSeekç”Ÿäº§é…ç½®").first()
        if config:
            creator_info = config.get_creator_info()
            print(f"\né…ç½®è¯¦æƒ…:")
            print(f"  åç§°: {config.name}")
            print(f"  æ¨¡å‹: {config.model_name.value}")
            print(f"  æœ€å¤§tokens: {config.max_tokens}")
            print(f"  åˆ›å»ºè€…: {creator_info['username'] if creator_info else 'æœªçŸ¥'}")
            print(f"  åˆ›å»ºæ—¶é—´: {config.created_at}")

        # æŸ¥è¯¢æ´»è·ƒé…ç½®
        active_configs = db.query(OpenAIConfig).filter(OpenAIConfig.is_active == True).all()
        print(f"\næ´»è·ƒé…ç½®æ•°é‡: {len(active_configs)}")

        return all_configs
```

#### 2. å¤æ‚æŸ¥è¯¢

```python
def query_configs_advanced():
    """é«˜çº§æŸ¥è¯¢ç¤ºä¾‹"""
    from database_models.business_models.openai_models import OpenAIConfig, OpenAIRequest, ModelType
    from database_models.business_utils import BusinessQueryHelper, UserInfoHelper
    from auth.database import get_db
    from sqlalchemy import and_, or_, desc, func
    from auth import auth_manager

    current_user = auth_manager.current_user

    with get_db() as db:
        # 1. æ¡ä»¶æŸ¥è¯¢
        deepseek_configs = db.query(OpenAIConfig).filter(
            and_(
                OpenAIConfig.model_name == ModelType.DEEPSEEK,
                OpenAIConfig.is_active == True
            )
        ).all()
        print(f"DeepSeekæ´»è·ƒé…ç½®: {len(deepseek_configs)}ä¸ª")

        # 2. æ’åºæŸ¥è¯¢
        latest_configs = db.query(OpenAIConfig).order_by(
            desc(OpenAIConfig.created_at)
        ).limit(5).all()
        print(f"\næœ€æ–°çš„5ä¸ªé…ç½®:")
        for config in latest_configs:
            print(f"  - {config.name} ({config.created_at})")

        # 3. èšåˆæŸ¥è¯¢
        total_requests = db.query(func.sum(OpenAIConfig.total_requests)).scalar() or 0
        total_tokens = db.query(func.sum(OpenAIConfig.total_tokens)).scalar() or 0
        print(f"\nç»Ÿè®¡ä¿¡æ¯:")
        print(f"  æ€»è¯·æ±‚æ•°: {total_requests}")
        print(f"  æ€»tokens: {total_tokens}")

        # 4. å…³è”æŸ¥è¯¢
        configs_with_requests = db.query(OpenAIConfig).join(OpenAIRequest).all()
        print(f"\næœ‰è¯·æ±‚è®°å½•çš„é…ç½®: {len(configs_with_requests)}ä¸ª")

        # 5. ä½¿ç”¨å·¥å…·ç±»æŸ¥è¯¢ç”¨æˆ·æ•°æ®
        user_configs = BusinessQueryHelper.get_user_business_records(
            current_user.id,
            OpenAIConfig,
            is_active=True
        )
        print(f"\nå½“å‰ç”¨æˆ·çš„æ´»è·ƒé…ç½®: {len(user_configs)}ä¸ª")

        return {
            'deepseek_configs': deepseek_configs,
            'latest_configs': latest_configs,
            'user_configs': user_configs,
            'stats': {'total_requests': total_requests, 'total_tokens': total_tokens}
        }
```

#### 3. åˆ†é¡µæŸ¥è¯¢

```python
def query_configs_paginated(page: int = 1, page_size: int = 10):
    """åˆ†é¡µæŸ¥è¯¢é…ç½®"""
    from database_models.business_models.openai_models import OpenAIConfig
    from auth.database import get_db
    from sqlalchemy import desc

    with get_db() as db:
        # è®¡ç®—åç§»é‡
        offset = (page - 1) * page_size

        # åˆ†é¡µæŸ¥è¯¢
        query = db.query(OpenAIConfig).order_by(desc(OpenAIConfig.created_at))
        total_count = query.count()
        configs = query.offset(offset).limit(page_size).all()

        # è®¡ç®—åˆ†é¡µä¿¡æ¯
        total_pages = (total_count + page_size - 1) // page_size

        print(f"åˆ†é¡µæŸ¥è¯¢ç»“æœ:")
        print(f"  å½“å‰é¡µ: {page}/{total_pages}")
        print(f"  æ¯é¡µæ•°é‡: {page_size}")
        print(f"  æ€»è®°å½•æ•°: {total_count}")
        print(f"  å½“å‰é¡µè®°å½•: {len(configs)}")

        # æ˜¾ç¤ºå½“å‰é¡µæ•°æ®
        for i, config in enumerate(configs, 1):
            creator_info = config.get_creator_info()
            print(f"  {offset + i}. {config.name} - {creator_info['username'] if creator_info else 'æœªçŸ¥'}")

        return {
            'configs': configs,
            'pagination': {
                'current_page': page,
                'total_pages': total_pages,
                'page_size': page_size,
                'total_count': total_count
            }
        }
```

### âœï¸ æ›´æ–°ï¼ˆUpdateï¼‰æ“ä½œ

#### 1. å•æ¡è®°å½•æ›´æ–°

```python
def update_openai_config(config_id: int, **updates):
    """æ›´æ–°OpenAIé…ç½®"""
    from database_models.business_models.openai_models import OpenAIConfig
    from database_models.business_utils import AuditHelper
    from auth.database import get_db
    from auth import auth_manager

    current_user = auth_manager.current_user

    with get_db() as db:
        # æŸ¥æ‰¾è¦æ›´æ–°çš„é…ç½®
        config = db.query(OpenAIConfig).filter(OpenAIConfig.id == config_id).first()

        if not config:
            print(f"âŒ æœªæ‰¾åˆ°IDä¸º{config_id}çš„é…ç½®")
            return None

        # è®°å½•æ›´æ–°å‰çš„å€¼
        old_values = {
            'name': config.name,
            'max_tokens': config.max_tokens,
            'temperature': config.temperature
        }

        # åº”ç”¨æ›´æ–°
        for field, value in updates.items():
            if hasattr(config, field):
                setattr(config, field, value)
                print(f"  æ›´æ–° {field}: {old_values.get(field, 'N/A')} -> {value}")

        # è®¾ç½®æ›´æ–°è€…
        AuditHelper.set_audit_fields(config, current_user.id, is_update=True)

        db.commit()

        print(f"âœ… é…ç½®æ›´æ–°æˆåŠŸ")
        print(f"é…ç½®åç§°: {config.name}")
        print(f"æ›´æ–°è€…: {current_user.username}")
        print(f"æ›´æ–°æ—¶é—´: {config.updated_at}")

        return config

# ä½¿ç”¨ç¤ºä¾‹
def update_example():
    """æ›´æ–°ç¤ºä¾‹"""
    # æ›´æ–°é…ç½®åç§°å’Œå‚æ•°
    updated_config = update_openai_config(
        config_id=1,
        name="æ›´æ–°åçš„DeepSeeké…ç½®",
        max_tokens=3000,
        temperature=80,
        description="è¿™æ˜¯æ›´æ–°åçš„é…ç½®æè¿°"
    )

    if updated_config:
        updater_info = updated_config.get_updater_info()
        print(f"æœ€åæ›´æ–°è€…: {updater_info['username'] if updater_info else 'æœªçŸ¥'}")
```

#### 2. æ‰¹é‡æ›´æ–°

```python
def batch_update_configs(filter_criteria: dict, updates: dict):
    """æ‰¹é‡æ›´æ–°é…ç½®"""
    from database_models.business_models.openai_models import OpenAIConfig
    from database_models.business_utils import AuditHelper
    from auth.database import get_db
    from auth import auth_manager

    current_user = auth_manager.current_user

    with get_db() as db:
        # æ„å»ºæŸ¥è¯¢æ¡ä»¶
        query = db.query(OpenAIConfig)
        for field, value in filter_criteria.items():
            if hasattr(OpenAIConfig, field):
                query = query.filter(getattr(OpenAIConfig, field) == value)

        configs = query.all()

        if not configs:
            print("âŒ æ²¡æœ‰æ‰¾åˆ°ç¬¦åˆæ¡ä»¶çš„é…ç½®")
            return []

        print(f"ğŸ“ å‡†å¤‡æ›´æ–° {len(configs)} ä¸ªé…ç½®")

        # æ‰¹é‡æ›´æ–°
        updated_configs = []
        for config in configs:
            print(f"  æ›´æ–°é…ç½®: {config.name}")

            for field, value in updates.items():
                if hasattr(config, field):
                    old_value = getattr(config, field)
                    setattr(config, field, value)
                    print(f"    {field}: {old_value} -> {value}")

            # è®¾ç½®æ›´æ–°è€…
            AuditHelper.set_audit_fields(config, current_user.id, is_update=True)
            updated_configs.append(config)

        db.commit()

        print(f"âœ… æ‰¹é‡æ›´æ–°å®Œæˆï¼Œå…±æ›´æ–° {len(updated_configs)} ä¸ªé…ç½®")
        return updated_configs

# ä½¿ç”¨ç¤ºä¾‹
def batch_update_example():
    """æ‰¹é‡æ›´æ–°ç¤ºä¾‹"""
    # å°†æ‰€æœ‰DeepSeekæ¨¡å‹çš„æœ€å¤§tokensæ›´æ–°ä¸º2500
    updated = batch_update_configs(
        filter_criteria={'model_name': ModelType.DEEPSEEK},
        updates={
            'max_tokens': 2500,
            'description': 'æ‰¹é‡æ›´æ–°ï¼šç»Ÿä¸€è®¾ç½®æœ€å¤§tokensä¸º2500'
        }
    )
```

#### 3. æ¡ä»¶æ›´æ–°

```python
def conditional_update_config(config_id: int, condition_check, updates: dict):
    """æ¡ä»¶æ›´æ–°é…ç½®"""
    from database_models.business_models.openai_models import OpenAIConfig
    from database_models.business_utils import AuditHelper
    from auth.database import get_db
    from auth import auth_manager

    current_user = auth_manager.current_user

    with get_db() as db:
        config = db.query(OpenAIConfig).filter(OpenAIConfig.id == config_id).first()

        if not config:
            print(f"âŒ æœªæ‰¾åˆ°é…ç½® ID: {config_id}")
            return None

        # æ£€æŸ¥æ›´æ–°æ¡ä»¶
        if not condition_check(config):
            print(f"âŒ é…ç½® '{config.name}' ä¸æ»¡è¶³æ›´æ–°æ¡ä»¶")
            return None

        print(f"âœ… é…ç½® '{config.name}' æ»¡è¶³æ›´æ–°æ¡ä»¶ï¼Œå¼€å§‹æ›´æ–°")

        # æ‰§è¡Œæ›´æ–°
        for field, value in updates.items():
            if hasattr(config, field):
                old_value = getattr(config, field)
                setattr(config, field, value)
                print(f"  {field}: {old_value} -> {value}")

        AuditHelper.set_audit_fields(config, current_user.id, is_update=True)
        db.commit()

        print(f"âœ… æ¡ä»¶æ›´æ–°å®Œæˆ")
        return config

# ä½¿ç”¨ç¤ºä¾‹
def conditional_update_example():
    """æ¡ä»¶æ›´æ–°ç¤ºä¾‹"""
    # åªæ›´æ–°è¯·æ±‚æ•°é‡è¶…è¿‡100çš„é…ç½®
    def high_usage_condition(config):
        return config.total_requests > 100

    updated = conditional_update_config(
        config_id=1,
        condition_check=high_usage_condition,
        updates={
            'description': 'é«˜ä½¿ç”¨é‡é…ç½®ï¼Œå·²ä¼˜åŒ–æ€§èƒ½',
            'max_tokens': 4000
        }
    )
```

### ğŸ—‘ï¸ åˆ é™¤ï¼ˆDeleteï¼‰æ“ä½œ

#### 1. è½¯åˆ é™¤ï¼ˆæ¨èï¼‰

```python
def soft_delete_config(config_id: int):
    """è½¯åˆ é™¤é…ç½®ï¼ˆæ¨èæ–¹å¼ï¼‰"""
    from database_models.business_models.openai_models import OpenAIConfig
    from database_models.business_utils import AuditHelper
    from auth.database import get_db
    from auth import auth_manager

    current_user = auth_manager.current_user

    with get_db() as db:
        config = db.query(OpenAIConfig).filter(OpenAIConfig.id == config_id).first()

        if not config:
            print(f"âŒ æœªæ‰¾åˆ°é…ç½® ID: {config_id}")
            return False

        if not config.is_active:
            print(f"âš ï¸ é…ç½® '{config.name}' å·²ç»è¢«åˆ é™¤")
            return False

        # è½¯åˆ é™¤ï¼šè®¾ç½®ä¸ºéæ´»è·ƒçŠ¶æ€
        config.is_active = False
        config.description = f"[å·²åˆ é™¤] {config.description or ''}"

        # è®°å½•åˆ é™¤æ“ä½œ
        AuditHelper.set_audit_fields(config, current_user.id, is_update=True)

        db.commit()

        print(f"âœ… é…ç½® '{config.name}' å·²è½¯åˆ é™¤")
        print(f"åˆ é™¤è€…: {current_user.username}")
        print(f"åˆ é™¤æ—¶é—´: {config.updated_at}")

        return True

def restore_config(config_id: int):
    """æ¢å¤å·²è½¯åˆ é™¤çš„é…ç½®"""
    from database_models.business_models.openai_models import OpenAIConfig
    from database_models.business_utils import AuditHelper
    from auth.database import get_db
    from auth import auth_manager

    current_user = auth_manager.current_user

    with get_db() as db:
        config = db.query(OpenAIConfig).filter(OpenAIConfig.id == config_id).first()

        if not config:
            print(f"âŒ æœªæ‰¾åˆ°é…ç½® ID: {config_id}")
            return False

        if config.is_active:
            print(f"âš ï¸ é…ç½® '{config.name}' æœªè¢«åˆ é™¤ï¼Œæ— éœ€æ¢å¤")
            return False

        # æ¢å¤é…ç½®
        config.is_active = True
        if config.description and config.description.startswith('[å·²åˆ é™¤]'):
            config.description = config.description.replace('[å·²åˆ é™¤] ', '')

        AuditHelper.set_audit_fields(config, current_user.id, is_update=True)
        db.commit()

        print(f"âœ… é…ç½® '{config.name}' å·²æ¢å¤")
        print(f"æ¢å¤è€…: {current_user.username}")

        return True
```

#### 2. ç¡¬åˆ é™¤ï¼ˆè°¨æ…ä½¿ç”¨ï¼‰

```python
def hard_delete_config(config_id: int, confirm: bool = False):
    """ç¡¬åˆ é™¤é…ç½®ï¼ˆè°¨æ…ä½¿ç”¨ï¼‰"""
    from database_models.business_models.openai_models import OpenAIConfig, OpenAIRequest
    from auth.database import get_db

    if not confirm:
        print("âŒ ç¡¬åˆ é™¤éœ€è¦ç¡®è®¤ï¼Œè¯·è®¾ç½® confirm=True")
        return False

    with get_db() as db:
        config = db.query(OpenAIConfig).filter(OpenAIConfig.id == config_id).first()

        if not config:
            print(f"âŒ æœªæ‰¾åˆ°é…ç½® ID: {config_id}")
            return False

        # æ£€æŸ¥æ˜¯å¦æœ‰å…³è”çš„è¯·æ±‚è®°å½•
        request_count = db.query(OpenAIRequest).filter(OpenAIRequest.config_id == config_id).count()

        if request_count > 0:
            print(f"âš ï¸ è­¦å‘Šï¼šé…ç½® '{config.name}' æœ‰ {request_count} æ¡å…³è”è¯·æ±‚è®°å½•")
            print("å»ºè®®ä½¿ç”¨è½¯åˆ é™¤è€Œä¸æ˜¯ç¡¬åˆ é™¤")
            return False

        config_name = config.name

        # æ‰§è¡Œç¡¬åˆ é™¤
        db.delete(config)
        db.commit()

        print(f"âœ… é…ç½® '{config_name}' å·²æ°¸ä¹…åˆ é™¤")
        print("âš ï¸ æ­¤æ“ä½œä¸å¯æ¢å¤")

        return True
```

#### 3. æ‰¹é‡åˆ é™¤

```python
def batch_delete_configs(filter_criteria: dict, soft_delete: bool = True):
    """æ‰¹é‡åˆ é™¤é…ç½®"""
    from database_models.business_models.openai_models import OpenAIConfig
    from database_models.business_utils import AuditHelper
    from auth.database import get_db
    from auth import auth_manager

    current_user = auth_manager.current_user

    with get_db() as db:
        # æ„å»ºæŸ¥è¯¢æ¡ä»¶
        query = db.query(OpenAIConfig)
        for field, value in filter_criteria.items():
            if hasattr(OpenAIConfig, field):
                query = query.filter(getattr(OpenAIConfig, field) == value)

        configs = query.all()

        if not configs:
            print("âŒ æ²¡æœ‰æ‰¾åˆ°ç¬¦åˆæ¡ä»¶çš„é…ç½®")
            return []

        print(f"ğŸ“ å‡†å¤‡åˆ é™¤ {len(configs)} ä¸ªé…ç½®")

        deleted_configs = []
        for config in configs:
            if soft_delete:
                # è½¯åˆ é™¤
                if config.is_active:
                    config.is_active = False
                    config.description = f"[æ‰¹é‡åˆ é™¤] {config.description or ''}"
                    AuditHelper.set_audit_fields(config, current_user.id, is_update=True)
                    deleted_configs.append(config)
                    print(f"  è½¯åˆ é™¤: {config.name}")
            else:
                # ç¡¬åˆ é™¤ï¼ˆéœ€è¦è°¨æ…ï¼‰
                print(f"  ç¡¬åˆ é™¤: {config.name}")
                db.delete(config)
                deleted_configs.append(config)

        db.commit()

        delete_type = "è½¯åˆ é™¤" if soft_delete else "ç¡¬åˆ é™¤"
        print(f"âœ… æ‰¹é‡{delete_type}å®Œæˆï¼Œå…±{delete_type} {len(deleted_configs)} ä¸ªé…ç½®")

        return deleted_configs

# ä½¿ç”¨ç¤ºä¾‹
def batch_delete_example():
    """æ‰¹é‡åˆ é™¤ç¤ºä¾‹"""
    # è½¯åˆ é™¤æ‰€æœ‰æµ‹è¯•é…ç½®
    deleted = batch_delete_configs(
        filter_criteria={'name': 'æµ‹è¯•'},  # åç§°åŒ…å«"æµ‹è¯•"çš„é…ç½®
        soft_delete=True
    )
```

---

## é«˜çº§åº”ç”¨åœºæ™¯

### 1. æ•°æ®ç»Ÿè®¡å’ŒæŠ¥è¡¨

```python
def generate_usage_report():
    """ç”Ÿæˆä½¿ç”¨æƒ…å†µæŠ¥è¡¨"""
    from database_models.business_models.openai_models import OpenAIConfig, OpenAIRequest, ModelType
    from database_models.business_utils import UserInfoHelper
    from auth.database import get_db
    from sqlalchemy import func, desc
    from collections import defaultdict

    with get_db() as db:
        # 1. æ€»ä½“ç»Ÿè®¡
        total_configs = db.query(OpenAIConfig).count()
        active_configs = db.query(OpenAIConfig).filter(OpenAIConfig.is_active == True).count()
        total_requests = db.query(func.sum(OpenAIConfig.total_requests)).scalar() or 0
        total_tokens = db.query(func.sum(OpenAIConfig.total_tokens)).scalar() or 0

        print("ğŸ“Š OpenAIä½¿ç”¨æƒ…å†µæŠ¥è¡¨")
        print("=" * 50)
        print(f"é…ç½®ç»Ÿè®¡:")
        print(f"  æ€»é…ç½®æ•°: {total_configs}")
        print(f"  æ´»è·ƒé…ç½®: {active_configs}")
        print(f"  æ€»è¯·æ±‚æ•°: {total_requests:,}")
        print(f"  æ€»tokens: {total_tokens:,}")

        # 2. æŒ‰æ¨¡å‹ç±»å‹ç»Ÿè®¡
        model_stats = db.query(
            OpenAIConfig.model_name,
            func.count(OpenAIConfig.id).label('count'),
            func.sum(OpenAIConfig.total_requests).label('requests'),
            func.sum(OpenAIConfig.total_tokens).label('tokens')
        ).group_by(OpenAIConfig.model_name).all()

        print(f"\nğŸ“ˆ æŒ‰æ¨¡å‹ç±»å‹ç»Ÿè®¡:")
        for stat in model_stats:
            print(f"  {stat.model_name.value}:")
            print(f"    é…ç½®æ•°: {stat.count}")
            print(f"    è¯·æ±‚æ•°: {stat.requests or 0:,}")
            print(f"    tokens: {stat.tokens or 0:,}")

        # 3. çƒ­é—¨é…ç½®Top 5
        top_configs = db.query(OpenAIConfig).order_by(
            desc(OpenAIConfig.total_requests)
        ).limit(5).all()

        print(f"\nğŸ”¥ çƒ­é—¨é…ç½®Top 5:")
        for i, config in enumerate(top_configs, 1):
            creator_info = config.get_creator_info()
            print(f"  {i}. {config.name}")
            print(f"     è¯·æ±‚æ•°: {config.total_requests:,}")
            print(f"     åˆ›å»ºè€…: {creator_info['username'] if creator_info else 'æœªçŸ¥'}")

        # 4. ç”¨æˆ·æ´»è·ƒåº¦ç»Ÿè®¡
        user_stats = db.query(
            OpenAIConfig.created_by,
            func.count(OpenAIConfig.id).label('config_count'),
            func.sum(OpenAIConfig.total_requests).label('total_requests')
        ).group_by(OpenAIConfig.created_by).order_by(
            desc('total_requests')
        ).limit(10).all()

        print(f"\nğŸ‘¥ ç”¨æˆ·æ´»è·ƒåº¦Top 10:")
        for stat in user_stats:
            user_info = UserInfoHelper.get_user_info(stat.created_by)
            username = user_info['username'] if user_info else f'User#{stat.created_by}'
            print(f"  {username}: {stat.config_count}ä¸ªé…ç½®, {stat.total_requests or 0:,}æ¬¡è¯·æ±‚")

        return {
            'total_stats': {
                'total_configs': total_configs,
                'active_configs': active_configs,
                'total_requests': total_requests,
                'total_tokens': total_tokens
            },
            'model_stats': model_stats,
            'top_configs': top_configs,
            'user_stats': user_stats
        }
```

### 2. æ•°æ®å¯¼å…¥å¯¼å‡º

```python
def export_configs_to_json():
    """å¯¼å‡ºé…ç½®åˆ°JSONæ–‡ä»¶"""
    import json
    from datetime import datetime
    from database_models.business_models.openai_models import OpenAIConfig
    from database_models.business_utils import UserInfoHelper
    from auth.database import get_db

    with get_db() as db:
        configs = db.query(OpenAIConfig).filter(OpenAIConfig.is_active == True).all()

        export_data = {
            'export_time': datetime.now().isoformat(),
            'total_count': len(configs),
            'configs': []
        }

        for config in configs:
            creator_info = config.get_creator_info()
            config_data = {
                'id': config.id,
                'name': config.name,
                'model_name': config.model_name.value,
                'max_tokens': config.max_tokens,
                'temperature': config.temperature,
                'is_public': config.is_public,
                'total_requests': config.total_requests,
                'total_tokens': config.total_tokens,
                'description': config.description,
                'created_at': config.created_at.isoformat() if config.created_at else None,
                'creator': creator_info['username'] if creator_info else None
            }
            export_data['configs'].append(config_data)

        # ä¿å­˜åˆ°æ–‡ä»¶
        filename = f"openai_configs_export_{datetime.now().strftime('%Y%m%d_%H%M%S')}.json"
        with open(filename, 'w', encoding='utf-8') as f:
            json.dump(export_data, f, indent=2, ensure_ascii=False)

        print(f"âœ… é…ç½®å¯¼å‡ºå®Œæˆ")
        print(f"æ–‡ä»¶å: {filename}")
        print(f"å¯¼å‡ºé…ç½®æ•°: {len(configs)}")

        return filename

def import_configs_from_json(filename: str):
    """ä»JSONæ–‡ä»¶å¯¼å…¥é…ç½®"""
    import json
    from database_models.business_models.openai_models import OpenAIConfig, ModelType
    from database_models.business_utils import AuditHelper
    from auth.database import get_db
    from auth import auth_manager

    current_user = auth_manager.current_user

    try:
        with open(filename, 'r', encoding='utf-8') as f:
            import_data = json.load(f)

        configs_data = import_data.get('configs', [])

        with get_db() as db:
            imported_count = 0
            skipped_count = 0

            for config_data in configs_data:
                # æ£€æŸ¥æ˜¯å¦å·²å­˜åœ¨åŒåé…ç½®
                existing = db.query(OpenAIConfig).filter(
                    OpenAIConfig.name == config_data['name']
                ).first()

                if existing:
                    print(f"âš ï¸ è·³è¿‡å·²å­˜åœ¨çš„é…ç½®: {config_data['name']}")
                    skipped_count += 1
                    continue

                # åˆ›å»ºæ–°é…ç½®
                try:
                    model_name = ModelType(config_data['model_name'])
                except ValueError:
                    print(f"âŒ æ— æ•ˆçš„æ¨¡å‹ç±»å‹: {config_data['model_name']}")
                    skipped_count += 1
                    continue

                config = OpenAIConfig(
                    name=config_data['name'],
                    api_key="éœ€è¦æ‰‹åŠ¨è®¾ç½®",  # å®‰å…¨è€ƒè™‘ï¼Œä¸å¯¼å…¥APIå¯†é’¥
                    model_name=model_name,
                    max_tokens=config_data.get('max_tokens', 1000),
                    temperature=config_data.get('temperature', 70),
                    is_public=config_data.get('is_public', False),
                    description=f"[å¯¼å…¥] {config_data.get('description', '')}"
                )

                AuditHelper.set_audit_fields(config, current_user.id)
                db.add(config)
                imported_count += 1

                print(f"âœ… å¯¼å…¥é…ç½®: {config.name}")

            db.commit()

            print(f"\nğŸ“Š å¯¼å…¥å®Œæˆ")
            print(f"æˆåŠŸå¯¼å…¥: {imported_count}")
            print(f"è·³è¿‡é‡å¤: {skipped_count}")
            print(f"âš ï¸ è¯·æ‰‹åŠ¨è®¾ç½®å¯¼å…¥é…ç½®çš„APIå¯†é’¥")

            return imported_count

    except FileNotFoundError:
        print(f"âŒ æ–‡ä»¶ä¸å­˜åœ¨: {filename}")
        return 0
    except json.JSONDecodeError:
        print(f"âŒ JSONæ–‡ä»¶æ ¼å¼é”™è¯¯: {filename}")
        return 0
    except Exception as e:
        print(f"âŒ å¯¼å…¥å¤±è´¥: {e}")
        return 0
```

### 3. æ•°æ®éªŒè¯å’Œæ¸…ç†

```python
def validate_and_cleanup_data():
    """æ•°æ®éªŒè¯å’Œæ¸…ç†"""
    from database_models.business_models.openai_models import OpenAIConfig, OpenAIRequest
    from database_models.business_utils import AuditHelper
    from auth.database import get_db
    from auth import auth_manager

    current_user = auth_manager.current_user

    with get_db() as db:
        print("ğŸ” å¼€å§‹æ•°æ®éªŒè¯å’Œæ¸…ç†...")

        # 1. æŸ¥æ‰¾æ— æ•ˆçš„APIå¯†é’¥
        invalid_keys = db.query(OpenAIConfig).filter(
            OpenAIConfig.api_key.in_(['', 'sk-example', 'éœ€è¦æ‰‹åŠ¨è®¾ç½®'])
        ).all()

        if invalid_keys:
            print(f"\nâš ï¸ å‘ç° {len(invalid_keys)} ä¸ªæ— æ•ˆAPIå¯†é’¥çš„é…ç½®:")
            for config in invalid_keys:
                print(f"  - {config.name} (ID: {config.id})")

        # 2. æŸ¥æ‰¾å­¤å„¿è¯·æ±‚è®°å½•ï¼ˆé…ç½®å·²åˆ é™¤ï¼‰
        orphan_requests = db.query(OpenAIRequest).filter(
            ~OpenAIRequest.config_id.in_(
                db.query(OpenAIConfig.id).filter(OpenAIConfig.is_active == True)
            )
        ).all()

        if orphan_requests:
            print(f"\nğŸ” å‘ç° {len(orphan_requests)} ä¸ªå­¤å„¿è¯·æ±‚è®°å½•:")
            for request in orphan_requests:
                print(f"  - è¯·æ±‚ID: {request.id}, é…ç½®ID: {request.config_id}")

        # 3. æ¸…ç†æµ‹è¯•æ•°æ®
        test_configs = db.query(OpenAIConfig).filter(
            OpenAIConfig.name.like('%æµ‹è¯•%')
        ).all()

        if test_configs:
            print(f"\nğŸ§¹ å‘ç° {len(test_configs)} ä¸ªæµ‹è¯•é…ç½®:")
            for config in test_configs:
                print(f"  - {config.name}")

            # å¯é€‰æ‹©æ¸…ç†æµ‹è¯•æ•°æ®
            cleanup_choice = input("æ˜¯å¦æ¸…ç†æµ‹è¯•æ•°æ®ï¼Ÿ(y/N): ")
            if cleanup_choice.lower() == 'y':
                for config in test_configs:
                    config.is_active = False
                    config.description = f"[è‡ªåŠ¨æ¸…ç†] {config.description or ''}"
                    AuditHelper.set_audit_fields(config, current_user.id, is_update=True)

                db.commit()
                print(f"âœ… å·²æ¸…ç† {len(test_configs)} ä¸ªæµ‹è¯•é…ç½®")

        # 4. ç»Ÿè®¡æ•°æ®å®Œæ•´æ€§
        total_configs = db.query(OpenAIConfig).count()
        configs_with_creator = db.query(OpenAIConfig).filter(
            OpenAIConfig.created_by.isnot(None)
        ).count()

        print(f"\nğŸ“Š æ•°æ®å®Œæ•´æ€§ç»Ÿè®¡:")
        print(f"æ€»é…ç½®æ•°: {total_configs}")
        print(f"æœ‰åˆ›å»ºè€…è®°å½•: {configs_with_creator}")
        print(f"ç¼ºå¤±åˆ›å»ºè€…: {total_configs - configs_with_creator}")

        return {
            'invalid_keys': len(invalid_keys),
            'orphan_requests': len(orphan_requests),
            'test_configs': len(test_configs),
            'data_integrity': {
                'total_configs': total_configs,
                'with_creator': configs_with_creator,
                'missing_creator': total_configs - configs_with_creator
            }
        }
```

### 4. æ€§èƒ½ç›‘æ§å’Œä¼˜åŒ–

```python
def monitor_performance():
    """æ€§èƒ½ç›‘æ§"""
    import time
    from database_models.business_models.openai_models import OpenAIConfig, OpenAIRequest
    from auth.database import get_db
    from sqlalchemy import text

    print("ğŸ“ˆ æ€§èƒ½ç›‘æ§æŠ¥å‘Š")
    print("=" * 50)

    with get_db() as db:
        # 1. æŸ¥è¯¢æ€§èƒ½æµ‹è¯•
        start_time = time.time()

        # ç®€å•æŸ¥è¯¢
        simple_query_start = time.time()
        simple_result = db.query(OpenAIConfig).count()
        simple_query_time = time.time() - simple_query_start

        # å¤æ‚æŸ¥è¯¢
        complex_query_start = time.time()
        complex_result = db.query(OpenAIConfig).join(OpenAIRequest).count()
        complex_query_time = time.time() - complex_query_start

        # èšåˆæŸ¥è¯¢
        agg_query_start = time.time()
        agg_result = db.execute(text("""
            SELECT
                model_name,
                COUNT(*) as config_count,
                SUM(total_requests) as total_requests,
                AVG(total_tokens) as avg_tokens
            FROM openai_configs
            WHERE is_active = 1
            GROUP BY model_name
        """)).fetchall()
        agg_query_time = time.time() - agg_query_start

        total_time = time.time() - start_time

        print(f"æŸ¥è¯¢æ€§èƒ½:")
        print(f"  ç®€å•æŸ¥è¯¢: {simple_query_time:.4f}s ({simple_result} æ¡è®°å½•)")
        print(f"  å¤æ‚æŸ¥è¯¢: {complex_query_time:.4f}s ({complex_result} æ¡è®°å½•)")
        print(f"  èšåˆæŸ¥è¯¢: {agg_query_time:.4f}s ({len(agg_result)} ä¸ªåˆ†ç»„)")
        print(f"  æ€»è€—æ—¶: {total_time:.4f}s")

        # 2. æ•°æ®åº“å¤§å°ç›‘æ§
        try:
            size_result = db.execute(text("""
                SELECT
                    name,
                    COUNT(*) as record_count
                FROM sqlite_master
                WHERE type = 'table' AND name LIKE '%openai%'
                GROUP BY name
            """)).fetchall()

            print(f"\næ•°æ®è¡¨ç»Ÿè®¡:")
            for table in size_result:
                count = db.execute(text(f"SELECT COUNT(*) FROM {table.name}")).scalar()
                print(f"  {table.name}: {count} æ¡è®°å½•")

        except Exception as e:
            print(f"  æ•°æ®åº“å¤§å°æŸ¥è¯¢å¤±è´¥: {e}")

        # 3. æ€§èƒ½å»ºè®®
        print(f"\nğŸ’¡ æ€§èƒ½å»ºè®®:")
        if complex_query_time > 0.1:
            print("  - è€ƒè™‘ä¸ºå¸¸ç”¨æŸ¥è¯¢æ·»åŠ ç´¢å¼•")
        if simple_result > 1000:
            print("  - å»ºè®®å®æ–½æ•°æ®åˆ†é¡µ")
        if agg_query_time > 0.05:
            print("  - è€ƒè™‘æ·»åŠ æ±‡æ€»è¡¨ä¼˜åŒ–èšåˆæŸ¥è¯¢")

        return {
            'query_performance': {
                'simple_query_time': simple_query_time,
                'complex_query_time': complex_query_time,
                'agg_query_time': agg_query_time,
                'total_time': total_time
            },
            'record_counts': {table.name: db.execute(text(f"SELECT COUNT(*) FROM {table.name}")).scalar() for table in size_result}
        }
```

---

## æœ€ä½³å®è·µ

### 1. é”™è¯¯å¤„ç†å’Œæ—¥å¿—è®°å½•

```python
def safe_operation_example():
    """å®‰å…¨æ“ä½œç¤ºä¾‹ï¼ŒåŒ…å«å®Œæ•´çš„é”™è¯¯å¤„ç†"""
    import logging
    from database_models.business_models.openai_models import OpenAIConfig, ModelType
    from database_models.business_utils import AuditHelper
    from auth.database import get_db
    from auth import auth_manager
    from sqlalchemy.exc import IntegrityError, SQLAlchemyError

    # é…ç½®æ—¥å¿—
    logger = logging.getLogger(__name__)

    def create_config_safely(name: str, api_key: str, model_name: str):
        """å®‰å…¨åœ°åˆ›å»ºé…ç½®"""
        try:
            current_user = auth_manager.current_user
            if not current_user:
                logger.error("ç”¨æˆ·æœªç™»å½•")
                return {'success': False, 'message': 'ç”¨æˆ·æœªç™»å½•'}

            # éªŒè¯è¾“å…¥
            if not name or not api_key:
                logger.error(f"æ— æ•ˆè¾“å…¥: name={name}, api_key={'***' if api_key else None}")
                return {'success': False, 'message': 'åç§°å’ŒAPIå¯†é’¥ä¸èƒ½ä¸ºç©º'}

            # éªŒè¯æ¨¡å‹ç±»å‹
            try:
                model_type = ModelType(model_name)
            except ValueError:
                logger.error(f"æ— æ•ˆçš„æ¨¡å‹ç±»å‹: {model_name}")
                return {'success': False, 'message': f'æ— æ•ˆçš„æ¨¡å‹ç±»å‹: {model_name}'}

            with get_db() as db:
                # æ£€æŸ¥é‡å
                existing = db.query(OpenAIConfig).filter(OpenAIConfig.name == name).first()
                if existing:
                    logger.warning(f"é…ç½®åç§°å·²å­˜åœ¨: {name}")
                    return {'success': False, 'message': f'é…ç½®åç§° "{name}" å·²å­˜åœ¨'}

                # åˆ›å»ºé…ç½®
                config = OpenAIConfig(
                    name=name,
                    api_key=api_key,
                    model_name=model_type
                )

                AuditHelper.set_audit_fields(config, current_user.id)
                db.add(config)
                db.commit()

                logger.info(f"é…ç½®åˆ›å»ºæˆåŠŸ: {name} (ID: {config.id}) by {current_user.username}")
                return {
                    'success': True,
                    'message': 'é…ç½®åˆ›å»ºæˆåŠŸ',
                    'config_id': config.id
                }

        except IntegrityError as e:
            logger.error(f"æ•°æ®å®Œæ•´æ€§é”™è¯¯: {e}")
            return {'success': False, 'message': 'æ•°æ®å®Œæ•´æ€§é”™è¯¯ï¼Œè¯·æ£€æŸ¥è¾“å…¥'}

        except SQLAlchemyError as e:
            logger.error(f"æ•°æ®åº“é”™è¯¯: {e}")
            return {'success': False, 'message': 'æ•°æ®åº“æ“ä½œå¤±è´¥'}

        except Exception as e:
            logger.error(f"æœªçŸ¥é”™è¯¯: {e}")
            return {'success': False, 'message': 'æ“ä½œå¤±è´¥ï¼Œè¯·ç¨åé‡è¯•'}

    # ä½¿ç”¨ç¤ºä¾‹
    result = create_config_safely("å®‰å…¨æµ‹è¯•é…ç½®", "sk-test-key", "deepseek-chat")
    if result['success']:
        print(f"âœ… {result['message']}, ID: {result['config_id']}")
    else:
        print(f"âŒ {result['message']}")

    return result
```

### 2. äº‹åŠ¡ç®¡ç†

```python
def transaction_example():
    """äº‹åŠ¡ç®¡ç†ç¤ºä¾‹"""
    from database_models.business_models.openai_models import OpenAIConfig, OpenAIRequest
    from database_models.business_utils import AuditHelper
    from auth.database import get_db
    from auth import auth_manager
    from sqlalchemy.exc import SQLAlchemyError

    current_user = auth_manager.current_user

    def create_config_with_initial_request():
        """åˆ›å»ºé…ç½®å¹¶åŒæ—¶åˆ›å»ºåˆå§‹è¯·æ±‚è®°å½•ï¼ˆäº‹åŠ¡ï¼‰"""
        try:
            with get_db() as db:
                # å¼€å§‹äº‹åŠ¡
                config = OpenAIConfig(
                    name="äº‹åŠ¡æµ‹è¯•é…ç½®",
                    api_key="sk-transaction-test",
                    model_name=ModelType.DEEPSEEK
                )
                AuditHelper.set_audit_fields(config, current_user.id)
                db.add(config)
                db.flush()  # è·å–IDä½†ä¸æäº¤

                # åˆ›å»ºåˆå§‹è¯·æ±‚è®°å½•
                initial_request = OpenAIRequest(
                    config_id=config.id,
                    user_id=current_user.id,
                    prompt="åˆå§‹åŒ–æµ‹è¯•",
                    response="é…ç½®åˆ›å»ºæˆåŠŸ",
                    tokens_used=10,
                    status="success"
                )
                AuditHelper.set_audit_fields(initial_request, current_user.id)
                db.add(initial_request)

                # æ›´æ–°é…ç½®ç»Ÿè®¡
                config.total_requests = 1
                config.total_tokens = 10
                AuditHelper.set_audit_fields(config, current_user.id, is_update=True)

                # æäº¤äº‹åŠ¡
                db.commit()

                print(f"âœ… äº‹åŠ¡å®Œæˆï¼Œé…ç½®ID: {config.id}, è¯·æ±‚ID: {initial_request.id}")
                return {'success': True, 'config_id': config.id, 'request_id': initial_request.id}

        except SQLAlchemyError as e:
            print(f"âŒ äº‹åŠ¡å¤±è´¥ï¼Œå·²å›æ»š: {e}")
            return {'success': False, 'error': str(e)}

    return create_config_with_initial_request()
```

### 3. ç¼“å­˜ç­–ç•¥

```python
def caching_example():
    """ç¼“å­˜ç­–ç•¥ç¤ºä¾‹"""
    import time
    from functools import lru_cache
    from database_models.business_models.openai_models import OpenAIConfig
    from database_models.business_utils import UserInfoHelper
    from auth.database import get_db

    # 1. ä½¿ç”¨LRUç¼“å­˜
    @lru_cache(maxsize=128)
    def get_config_summary_cached(config_id: int):
        """ç¼“å­˜é…ç½®æ‘˜è¦ä¿¡æ¯"""
        with get_db() as db:
            config = db.query(OpenAIConfig).filter(OpenAIConfig.id == config_id).first()
            if config:
                creator_info = config.get_creator_info()
                return {
                    'id': config.id,
                    'name': config.name,
                    'model_name': config.model_name.value,
                    'creator': creator_info['username'] if creator_info else None,
                    'created_at': config.created_at.isoformat() if config.created_at else None
                }
        return None

    # 2. æ‰‹åŠ¨ç¼“å­˜ç®¡ç†
    class ConfigCache:
        def __init__(self):
            self._cache = {}
            self._cache_time = {}
            self._ttl = 300  # 5åˆ†é’ŸTTL

        def get(self, key):
            if key in self._cache:
                if time.time() - self._cache_time[key] < self._ttl:
                    return self._cache[key]
                else:
                    # ç¼“å­˜è¿‡æœŸ
                    del self._cache[key]
                    del self._cache_time[key]
            return None

        def set(self, key, value):
            self._cache[key] = value
            self._cache_time[key] = time.time()

        def clear(self):
            self._cache.clear()
            self._cache_time.clear()

    # å…¨å±€ç¼“å­˜å®ä¾‹
    config_cache = ConfigCache()

    def get_popular_configs():
        """è·å–çƒ­é—¨é…ç½®ï¼ˆå¸¦ç¼“å­˜ï¼‰"""
        cache_key = "popular_configs"
        cached_result = config_cache.get(cache_key)

        if cached_result:
            print("ğŸ“‹ ä»ç¼“å­˜è·å–çƒ­é—¨é…ç½®")
            return cached_result

        print("ğŸ” ä»æ•°æ®åº“æŸ¥è¯¢çƒ­é—¨é…ç½®")
        with get_db() as db:
            configs = db.query(OpenAIConfig).filter(
                OpenAIConfig.is_active == True
            ).order_by(OpenAIConfig.total_requests.desc()).limit(10).all()

            result = []
            for config in configs:
                creator_info = config.get_creator_info()
                result.append({
                    'id': config.id,
                    'name': config.name,
                    'total_requests': config.total_requests,
                    'creator': creator_info['username'] if creator_info else None
                })

            config_cache.set(cache_key, result)
            return result

    # ä½¿ç”¨ç¤ºä¾‹
    print("ç¬¬ä¸€æ¬¡æŸ¥è¯¢:")
    popular_configs = get_popular_configs()
    print(f"è·å–åˆ° {len(popular_configs)} ä¸ªçƒ­é—¨é…ç½®")

    print("\nç¬¬äºŒæ¬¡æŸ¥è¯¢:")
    popular_configs = get_popular_configs()  # è¿™æ¬¡ä¼šä»ç¼“å­˜è·å–

    return popular_configs
```

---

## æ•…éšœæ’é™¤

### å¸¸è§é—®é¢˜å’Œè§£å†³æ–¹æ¡ˆ

#### 1. æ¨¡å‹å¯¼å…¥é—®é¢˜

```python
def troubleshoot_import_issues():
    """æ’æŸ¥æ¨¡å‹å¯¼å…¥é—®é¢˜"""
    print("ğŸ” æ£€æŸ¥æ¨¡å‹å¯¼å…¥çŠ¶æ€...")

    try:
        from database_models.business_models.openai_models import OpenAIConfig, OpenAIRequest, ModelType
        print("âœ… OpenAIæ¨¡å‹å¯¼å…¥æˆåŠŸ")
    except ImportError as e:
        print(f"âŒ OpenAIæ¨¡å‹å¯¼å…¥å¤±è´¥: {e}")
        return False

    try:
        from database_models.shared_base import BusinessBaseModel, TimestampMixin, AuditMixin
        print("âœ… åŸºç¡€æ¨¡å‹å¯¼å…¥æˆåŠŸ")
    except ImportError as e:
        print(f"âŒ åŸºç¡€æ¨¡å‹å¯¼å…¥å¤±è´¥: {e}")
        return False

    try:
        from database_models.business_utils import UserInfoHelper, AuditHelper
        print("âœ… å·¥å…·ç±»å¯¼å…¥æˆåŠŸ")
    except ImportError as e:
        print(f"âŒ å·¥å…·ç±»å¯¼å…¥å¤±è´¥: {e}")
        return False

    return True
```

#### 2. æ•°æ®åº“è¿æ¥é—®é¢˜

```python
def troubleshoot_database_connection():
    """æ’æŸ¥æ•°æ®åº“è¿æ¥é—®é¢˜"""
    print("ğŸ” æ£€æŸ¥æ•°æ®åº“è¿æ¥...")

    try:
        from auth.database import get_db, check_connection

        # æ£€æŸ¥è¿æ¥
        if check_connection():
            print("âœ… æ•°æ®åº“è¿æ¥æ­£å¸¸")
        else:
            print("âŒ æ•°æ®åº“è¿æ¥å¤±è´¥")
            return False

        # æ£€æŸ¥è¡¨æ˜¯å¦å­˜åœ¨
        with get_db() as db:
            from database_models.business_models.openai_models import OpenAIConfig

            try:
                count = db.query(OpenAIConfig).count()
                print(f"âœ… OpenAIé…ç½®è¡¨æ­£å¸¸ï¼Œå…± {count} æ¡è®°å½•")
            except Exception as e:
                print(f"âŒ OpenAIé…ç½®è¡¨è®¿é—®å¤±è´¥: {e}")
                return False

        return True

    except Exception as e:
        print(f"âŒ æ•°æ®åº“æ£€æŸ¥å¤±è´¥: {e}")
        return False
```

#### 3. æƒé™é—®é¢˜æ’æŸ¥

```python
def troubleshoot_permission_issues():
    """æ’æŸ¥æƒé™é—®é¢˜"""
    print("ğŸ” æ£€æŸ¥ç”¨æˆ·æƒé™...")

    try:
        from auth import auth_manager

        current_user = auth_manager.current_user
        if not current_user:
            print("âŒ ç”¨æˆ·æœªç™»å½•")
            return False

        print(f"âœ… å½“å‰ç”¨æˆ·: {current_user.username}")

        # æ£€æŸ¥åŸºç¡€æƒé™
        if hasattr(current_user, 'has_permission'):
            permissions_to_check = [
                'openai.view',
                'openai.create',
                'openai.edit',
                'openai.delete'
            ]

            for perm in permissions_to_check:
                has_perm = current_user.has_permission(perm)
                status = "âœ…" if has_perm else "âŒ"
                print(f"{status} æƒé™ {perm}: {'æœ‰' if has_perm else 'æ— '}")

        # æ£€æŸ¥è§’è‰²
        if hasattr(current_user, 'roles'):
            print(f"ç”¨æˆ·è§’è‰²: {current_user.roles}")

        return True

    except Exception as e:
        print(f"âŒ æƒé™æ£€æŸ¥å¤±è´¥: {e}")
        return False
```

### è¯Šæ–­è„šæœ¬

```python
def run_full_diagnosis():
    """è¿è¡Œå®Œæ•´è¯Šæ–­"""
    print("ğŸ¥ å¼€å§‹ç³»ç»Ÿè¯Šæ–­...")
    print("=" * 50)

    results = {
        'import_check': troubleshoot_import_issues(),
        'database_check': troubleshoot_database_connection(),
        'permission_check': troubleshoot_permission_issues()
    }

    print("\nğŸ“‹ è¯Šæ–­ç»“æœ:")
    print("=" * 50)

    all_ok = True
    for check_name, result in results.items():
        status = "âœ… æ­£å¸¸" if result else "âŒ å¼‚å¸¸"
        print(f"{check_name}: {status}")
        if not result:
            all_ok = False

    if all_ok:
        print("\nğŸ‰ ç³»ç»ŸçŠ¶æ€è‰¯å¥½ï¼Œæ‰€æœ‰æ£€æŸ¥å‡é€šè¿‡ï¼")
    else:
        print("\nâš ï¸ å‘ç°é—®é¢˜ï¼Œè¯·æ ¹æ®ä¸Šè¿°ä¿¡æ¯è¿›è¡Œä¿®å¤ã€‚")

    return results

# è¿è¡Œè¯Šæ–­
if __name__ == "__main__":
    diagnosis_results = run_full_diagnosis()
```

---

## æ€»ç»“

æœ¬æ–‡æ¡£è¯¦ç»†ä»‹ç»äº†ä¸šåŠ¡æ¨¡å‹ç³»ç»Ÿçš„ä¸‰ä¸ªæ ¸å¿ƒç»„ä»¶çš„ä½¿ç”¨æ–¹æ³•ï¼š

### ğŸ¯ æ ¸å¿ƒä»·å€¼

1. **`shared_base.py`**ï¼šæä¾›ç»Ÿä¸€çš„åŸºç¡€æ¶æ„ï¼ŒåŒ…å«æ—¶é—´æˆ³ã€å®¡è®¡å­—æ®µç­‰
2. **`openai_models.py`**ï¼šå…·ä½“ä¸šåŠ¡æ¨¡å‹å®ç°ï¼Œå±•ç¤ºäº†å®Œæ•´çš„è¡¨è®¾è®¡æ¨¡å¼
3. **`business_utils.py`**ï¼šå·¥å…·ç±»é›†åˆï¼Œå®ç°è·¨æ¨¡å—çš„æ¾è€¦åˆè®¾è®¡

### ğŸ“š å­¦ä¹ è·¯å¾„

1. **æ–°æ‰‹å…¥é—¨**ï¼šä»åŸºç¡€çš„å¢åˆ æ”¹æŸ¥æ“ä½œå¼€å§‹
2. **è¿›é˜¶åº”ç”¨**ï¼šæŒæ¡äº‹åŠ¡ç®¡ç†ã€ç¼“å­˜ç­–ç•¥ã€æ‰¹é‡æ“ä½œ
3. **é«˜çº§åº”ç”¨**ï¼šå­¦ä¹ æ€§èƒ½ç›‘æ§ã€æ•°æ®å¯¼å…¥å¯¼å‡ºã€æŠ¥è¡¨ç”Ÿæˆ

### ğŸ› ï¸ æœ€ä½³å®è·µ

- å§‹ç»ˆä½¿ç”¨ `AuditHelper` è®¾ç½®å®¡è®¡å­—æ®µ
- ç”¨ `UserInfoHelper` è·å–ç”¨æˆ·ä¿¡æ¯ï¼Œé¿å…ç›´æ¥ä¾èµ–
- å®æ–½å®Œæ•´çš„é”™è¯¯å¤„ç†å’Œæ—¥å¿—è®°å½•
- åˆç†ä½¿ç”¨äº‹åŠ¡ç¡®ä¿æ•°æ®ä¸€è‡´æ€§
- æ ¹æ®éœ€è¦å®æ–½ç¼“å­˜ç­–ç•¥

è¿™å¥—ç³»ç»Ÿä¸ºä¸šåŠ¡æ¨¡å‹çš„å¼€å‘æä¾›äº†å®Œæ•´çš„æ¡†æ¶æ”¯æŒï¼Œæ—¢ä¿è¯äº†åŠŸèƒ½çš„å®Œæ•´æ€§ï¼Œåˆå®ç°äº†è‰¯å¥½çš„æ¶æ„è®¾è®¡ã€‚
