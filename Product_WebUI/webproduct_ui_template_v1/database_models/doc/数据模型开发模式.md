# 业务模型系统完整应用文档

## 📋 目录

1. [系统概述](#系统概述)
2. [核心组件介绍](#核心组件介绍)
3. [基础使用示例](#基础使用示例)
4. [增删改查操作详解](#增删改查操作详解)
5. [高级应用场景](#高级应用场景)
6. [最佳实践](#最佳实践)
7. [故障排除](#故障排除)

---

## 系统概述

本业务模型系统由三个核心脚本组成，提供了完整的业务数据管理解决方案：

- **`openai_models.py`**：具体的业务模型定义
- **`shared_base.py`**：通用基类和混入类
- **`business_utils.py`**：工具类和辅助函数

### 🎯 设计原则

1. **松耦合**：业务模型与认证模块解耦，通过工具类交互
2. **可复用**：通用功能抽象为基类和工具类
3. **易扩展**：新增业务模型只需继承基类即可
4. **审计完备**：自动记录创建者、更新者和时间戳

---

## 核心组件介绍

### 1. `shared_base.py` - 基础架构

```python
# 提供三个核心类：
TimestampMixin      # 时间戳字段（created_at, updated_at）
AuditMixin          # 审计字段（created_by, updated_by）
BusinessBaseModel   # 业务模型基类（继承上述两个混入类）
```

### 2. `openai_models.py` - 具体业务模型

```python
# 定义具体的业务实体：
ModelType          # 枚举：模型类型
OpenAIConfig       # 配置表：存储OpenAI API配置
OpenAIRequest      # 请求表：存储API调用记录
```

### 3. `business_utils.py` - 工具类集合

```python
# 提供四个核心工具类：
UserInfoHelper      # 用户信息获取
AuditHelper         # 审计字段管理
BusinessQueryHelper # 业务查询操作
RelationshipHelper  # 关系数据处理
```

---

## 基础使用示例

### 快速开始

```python
# 1. 导入必要模块
from auth import auth_manager
from database_models.business_models.openai_models import OpenAIConfig, OpenAIRequest, ModelType
from database_models.business_utils import AuditHelper, UserInfoHelper
from auth.database import get_db

# 2. 获取当前用户
current_user = auth_manager.current_user

# 3. 基础操作示例
def quick_start_example():
    """快速开始示例"""
    with get_db() as db:
        # 创建配置
        config = OpenAIConfig(
            name="我的第一个配置",
            api_key="sk-xxxxxxxxxx",
            model_name=ModelType.DEEPSEEK
        )

        # 设置审计字段
        AuditHelper.set_audit_fields(config, current_user.id)

        db.add(config)
        db.commit()

        print(f"配置创建成功，ID: {config.id}")
```

---

## 增删改查操作详解

### 📝 创建（Create）操作

#### 1. 基础创建

```python
def create_openai_config_basic():
    """基础配置创建"""
    from auth import auth_manager
    from database_models.business_models.openai_models import OpenAIConfig, ModelType
    from database_models.business_utils import AuditHelper
    from auth.database import get_db

    current_user = auth_manager.current_user

    with get_db() as db:
        # 创建新配置
        config = OpenAIConfig(
            name="DeepSeek生产配置",
            api_key="sk-real-api-key-here",
            base_url="https://api.deepseek.com/v1",
            model_name=ModelType.DEEPSEEK,
            max_tokens=2000,
            temperature=75,
            is_public=False,
            description="用于生产环境的DeepSeek配置"
        )

        # 自动设置审计字段
        AuditHelper.set_audit_fields(config, current_user.id)

        db.add(config)
        db.commit()

        # 获取创建者信息进行验证
        creator_info = config.get_creator_info()
        print(f"✅ 配置创建成功")
        print(f"配置ID: {config.id}")
        print(f"创建者: {creator_info['username'] if creator_info else '未知'}")
        print(f"创建时间: {config.created_at}")

        return config
```

#### 2. 批量创建

```python
def create_multiple_configs():
    """批量创建多个配置"""
    from database_models.business_models.openai_models import OpenAIConfig, ModelType
    from database_models.business_utils import AuditHelper
    from auth.database import get_db
    from auth import auth_manager

    current_user = auth_manager.current_user

    # 配置数据
    configs_data = [
        {
            "name": "DeepSeek Chat",
            "api_key": "sk-deepseek-key",
            "model_name": ModelType.DEEPSEEK,
            "description": "用于聊天的DeepSeek配置"
        },
        {
            "name": "Moonshot 8K",
            "api_key": "sk-moonshot-key",
            "base_url": "https://api.moonshot.cn/v1",
            "model_name": ModelType.MOONSHOT_V1_8K,
            "description": "Moonshot 8K上下文配置"
        },
        {
            "name": "Moonshot 32K",
            "api_key": "sk-moonshot-key-32k",
            "base_url": "https://api.moonshot.cn/v1",
            "model_name": ModelType.MOONSHOT_V1_32K,
            "max_tokens": 4000,
            "description": "Moonshot 32K长上下文配置"
        }
    ]

    with get_db() as db:
        created_configs = []

        for config_data in configs_data:
            config = OpenAIConfig(**config_data)
            AuditHelper.set_audit_fields(config, current_user.id)
            db.add(config)
            created_configs.append(config)

        db.commit()

        print(f"✅ 批量创建完成，共创建 {len(created_configs)} 个配置")
        for config in created_configs:
            print(f"  - {config.name} (ID: {config.id})")

        return created_configs
```

#### 3. 创建请求记录

```python
def create_openai_request():
    """创建OpenAI请求记录"""
    from database_models.business_models.openai_models import OpenAIRequest
    from database_models.business_utils import AuditHelper
    from auth.database import get_db
    from auth import auth_manager

    current_user = auth_manager.current_user

    with get_db() as db:
        # 假设使用ID为1的配置
        request = OpenAIRequest(
            config_id=1,
            user_id=current_user.id,  # 直接关联用户
            prompt="请介绍一下Python编程语言",
            response="Python是一种高级编程语言...",
            tokens_used=156,
            cost=12,  # 以分为单位
            status="success"
        )

        # 设置审计字段
        AuditHelper.set_audit_fields(request, current_user.id)

        db.add(request)
        db.commit()

        print(f"✅ 请求记录创建成功，ID: {request.id}")
        print(f"消耗tokens: {request.tokens_used}")
        print(f"成本: {request.cost}分")

        return request
```

### 📖 查询（Read）操作

#### 1. 基础查询

```python
def query_configs_basic():
    """基础配置查询"""
    from database_models.business_models.openai_models import OpenAIConfig
    from database_models.business_utils import UserInfoHelper
    from auth.database import get_db

    with get_db() as db:
        # 查询所有配置
        all_configs = db.query(OpenAIConfig).all()
        print(f"总计配置数量: {len(all_configs)}")

        # 查询特定配置
        config = db.query(OpenAIConfig).filter(OpenAIConfig.name == "DeepSeek生产配置").first()
        if config:
            creator_info = config.get_creator_info()
            print(f"\n配置详情:")
            print(f"  名称: {config.name}")
            print(f"  模型: {config.model_name.value}")
            print(f"  最大tokens: {config.max_tokens}")
            print(f"  创建者: {creator_info['username'] if creator_info else '未知'}")
            print(f"  创建时间: {config.created_at}")

        # 查询活跃配置
        active_configs = db.query(OpenAIConfig).filter(OpenAIConfig.is_active == True).all()
        print(f"\n活跃配置数量: {len(active_configs)}")

        return all_configs
```

#### 2. 复杂查询

```python
def query_configs_advanced():
    """高级查询示例"""
    from database_models.business_models.openai_models import OpenAIConfig, OpenAIRequest, ModelType
    from database_models.business_utils import BusinessQueryHelper, UserInfoHelper
    from auth.database import get_db
    from sqlalchemy import and_, or_, desc, func
    from auth import auth_manager

    current_user = auth_manager.current_user

    with get_db() as db:
        # 1. 条件查询
        deepseek_configs = db.query(OpenAIConfig).filter(
            and_(
                OpenAIConfig.model_name == ModelType.DEEPSEEK,
                OpenAIConfig.is_active == True
            )
        ).all()
        print(f"DeepSeek活跃配置: {len(deepseek_configs)}个")

        # 2. 排序查询
        latest_configs = db.query(OpenAIConfig).order_by(
            desc(OpenAIConfig.created_at)
        ).limit(5).all()
        print(f"\n最新的5个配置:")
        for config in latest_configs:
            print(f"  - {config.name} ({config.created_at})")

        # 3. 聚合查询
        total_requests = db.query(func.sum(OpenAIConfig.total_requests)).scalar() or 0
        total_tokens = db.query(func.sum(OpenAIConfig.total_tokens)).scalar() or 0
        print(f"\n统计信息:")
        print(f"  总请求数: {total_requests}")
        print(f"  总tokens: {total_tokens}")

        # 4. 关联查询
        configs_with_requests = db.query(OpenAIConfig).join(OpenAIRequest).all()
        print(f"\n有请求记录的配置: {len(configs_with_requests)}个")

        # 5. 使用工具类查询用户数据
        user_configs = BusinessQueryHelper.get_user_business_records(
            current_user.id,
            OpenAIConfig,
            is_active=True
        )
        print(f"\n当前用户的活跃配置: {len(user_configs)}个")

        return {
            'deepseek_configs': deepseek_configs,
            'latest_configs': latest_configs,
            'user_configs': user_configs,
            'stats': {'total_requests': total_requests, 'total_tokens': total_tokens}
        }
```

#### 3. 分页查询

```python
def query_configs_paginated(page: int = 1, page_size: int = 10):
    """分页查询配置"""
    from database_models.business_models.openai_models import OpenAIConfig
    from auth.database import get_db
    from sqlalchemy import desc

    with get_db() as db:
        # 计算偏移量
        offset = (page - 1) * page_size

        # 分页查询
        query = db.query(OpenAIConfig).order_by(desc(OpenAIConfig.created_at))
        total_count = query.count()
        configs = query.offset(offset).limit(page_size).all()

        # 计算分页信息
        total_pages = (total_count + page_size - 1) // page_size

        print(f"分页查询结果:")
        print(f"  当前页: {page}/{total_pages}")
        print(f"  每页数量: {page_size}")
        print(f"  总记录数: {total_count}")
        print(f"  当前页记录: {len(configs)}")

        # 显示当前页数据
        for i, config in enumerate(configs, 1):
            creator_info = config.get_creator_info()
            print(f"  {offset + i}. {config.name} - {creator_info['username'] if creator_info else '未知'}")

        return {
            'configs': configs,
            'pagination': {
                'current_page': page,
                'total_pages': total_pages,
                'page_size': page_size,
                'total_count': total_count
            }
        }
```

### ✏️ 更新（Update）操作

#### 1. 单条记录更新

```python
def update_openai_config(config_id: int, **updates):
    """更新OpenAI配置"""
    from database_models.business_models.openai_models import OpenAIConfig
    from database_models.business_utils import AuditHelper
    from auth.database import get_db
    from auth import auth_manager

    current_user = auth_manager.current_user

    with get_db() as db:
        # 查找要更新的配置
        config = db.query(OpenAIConfig).filter(OpenAIConfig.id == config_id).first()

        if not config:
            print(f"❌ 未找到ID为{config_id}的配置")
            return None

        # 记录更新前的值
        old_values = {
            'name': config.name,
            'max_tokens': config.max_tokens,
            'temperature': config.temperature
        }

        # 应用更新
        for field, value in updates.items():
            if hasattr(config, field):
                setattr(config, field, value)
                print(f"  更新 {field}: {old_values.get(field, 'N/A')} -> {value}")

        # 设置更新者
        AuditHelper.set_audit_fields(config, current_user.id, is_update=True)

        db.commit()

        print(f"✅ 配置更新成功")
        print(f"配置名称: {config.name}")
        print(f"更新者: {current_user.username}")
        print(f"更新时间: {config.updated_at}")

        return config

# 使用示例
def update_example():
    """更新示例"""
    # 更新配置名称和参数
    updated_config = update_openai_config(
        config_id=1,
        name="更新后的DeepSeek配置",
        max_tokens=3000,
        temperature=80,
        description="这是更新后的配置描述"
    )

    if updated_config:
        updater_info = updated_config.get_updater_info()
        print(f"最后更新者: {updater_info['username'] if updater_info else '未知'}")
```

#### 2. 批量更新

```python
def batch_update_configs(filter_criteria: dict, updates: dict):
    """批量更新配置"""
    from database_models.business_models.openai_models import OpenAIConfig
    from database_models.business_utils import AuditHelper
    from auth.database import get_db
    from auth import auth_manager

    current_user = auth_manager.current_user

    with get_db() as db:
        # 构建查询条件
        query = db.query(OpenAIConfig)
        for field, value in filter_criteria.items():
            if hasattr(OpenAIConfig, field):
                query = query.filter(getattr(OpenAIConfig, field) == value)

        configs = query.all()

        if not configs:
            print("❌ 没有找到符合条件的配置")
            return []

        print(f"📝 准备更新 {len(configs)} 个配置")

        # 批量更新
        updated_configs = []
        for config in configs:
            print(f"  更新配置: {config.name}")

            for field, value in updates.items():
                if hasattr(config, field):
                    old_value = getattr(config, field)
                    setattr(config, field, value)
                    print(f"    {field}: {old_value} -> {value}")

            # 设置更新者
            AuditHelper.set_audit_fields(config, current_user.id, is_update=True)
            updated_configs.append(config)

        db.commit()

        print(f"✅ 批量更新完成，共更新 {len(updated_configs)} 个配置")
        return updated_configs

# 使用示例
def batch_update_example():
    """批量更新示例"""
    # 将所有DeepSeek模型的最大tokens更新为2500
    updated = batch_update_configs(
        filter_criteria={'model_name': ModelType.DEEPSEEK},
        updates={
            'max_tokens': 2500,
            'description': '批量更新：统一设置最大tokens为2500'
        }
    )
```

#### 3. 条件更新

```python
def conditional_update_config(config_id: int, condition_check, updates: dict):
    """条件更新配置"""
    from database_models.business_models.openai_models import OpenAIConfig
    from database_models.business_utils import AuditHelper
    from auth.database import get_db
    from auth import auth_manager

    current_user = auth_manager.current_user

    with get_db() as db:
        config = db.query(OpenAIConfig).filter(OpenAIConfig.id == config_id).first()

        if not config:
            print(f"❌ 未找到配置 ID: {config_id}")
            return None

        # 检查更新条件
        if not condition_check(config):
            print(f"❌ 配置 '{config.name}' 不满足更新条件")
            return None

        print(f"✅ 配置 '{config.name}' 满足更新条件，开始更新")

        # 执行更新
        for field, value in updates.items():
            if hasattr(config, field):
                old_value = getattr(config, field)
                setattr(config, field, value)
                print(f"  {field}: {old_value} -> {value}")

        AuditHelper.set_audit_fields(config, current_user.id, is_update=True)
        db.commit()

        print(f"✅ 条件更新完成")
        return config

# 使用示例
def conditional_update_example():
    """条件更新示例"""
    # 只更新请求数量超过100的配置
    def high_usage_condition(config):
        return config.total_requests > 100

    updated = conditional_update_config(
        config_id=1,
        condition_check=high_usage_condition,
        updates={
            'description': '高使用量配置，已优化性能',
            'max_tokens': 4000
        }
    )
```

### 🗑️ 删除（Delete）操作

#### 1. 软删除（推荐）

```python
def soft_delete_config(config_id: int):
    """软删除配置（推荐方式）"""
    from database_models.business_models.openai_models import OpenAIConfig
    from database_models.business_utils import AuditHelper
    from auth.database import get_db
    from auth import auth_manager

    current_user = auth_manager.current_user

    with get_db() as db:
        config = db.query(OpenAIConfig).filter(OpenAIConfig.id == config_id).first()

        if not config:
            print(f"❌ 未找到配置 ID: {config_id}")
            return False

        if not config.is_active:
            print(f"⚠️ 配置 '{config.name}' 已经被删除")
            return False

        # 软删除：设置为非活跃状态
        config.is_active = False
        config.description = f"[已删除] {config.description or ''}"

        # 记录删除操作
        AuditHelper.set_audit_fields(config, current_user.id, is_update=True)

        db.commit()

        print(f"✅ 配置 '{config.name}' 已软删除")
        print(f"删除者: {current_user.username}")
        print(f"删除时间: {config.updated_at}")

        return True

def restore_config(config_id: int):
    """恢复已软删除的配置"""
    from database_models.business_models.openai_models import OpenAIConfig
    from database_models.business_utils import AuditHelper
    from auth.database import get_db
    from auth import auth_manager

    current_user = auth_manager.current_user

    with get_db() as db:
        config = db.query(OpenAIConfig).filter(OpenAIConfig.id == config_id).first()

        if not config:
            print(f"❌ 未找到配置 ID: {config_id}")
            return False

        if config.is_active:
            print(f"⚠️ 配置 '{config.name}' 未被删除，无需恢复")
            return False

        # 恢复配置
        config.is_active = True
        if config.description and config.description.startswith('[已删除]'):
            config.description = config.description.replace('[已删除] ', '')

        AuditHelper.set_audit_fields(config, current_user.id, is_update=True)
        db.commit()

        print(f"✅ 配置 '{config.name}' 已恢复")
        print(f"恢复者: {current_user.username}")

        return True
```

#### 2. 硬删除（谨慎使用）

```python
def hard_delete_config(config_id: int, confirm: bool = False):
    """硬删除配置（谨慎使用）"""
    from database_models.business_models.openai_models import OpenAIConfig, OpenAIRequest
    from auth.database import get_db

    if not confirm:
        print("❌ 硬删除需要确认，请设置 confirm=True")
        return False

    with get_db() as db:
        config = db.query(OpenAIConfig).filter(OpenAIConfig.id == config_id).first()

        if not config:
            print(f"❌ 未找到配置 ID: {config_id}")
            return False

        # 检查是否有关联的请求记录
        request_count = db.query(OpenAIRequest).filter(OpenAIRequest.config_id == config_id).count()

        if request_count > 0:
            print(f"⚠️ 警告：配置 '{config.name}' 有 {request_count} 条关联请求记录")
            print("建议使用软删除而不是硬删除")
            return False

        config_name = config.name

        # 执行硬删除
        db.delete(config)
        db.commit()

        print(f"✅ 配置 '{config_name}' 已永久删除")
        print("⚠️ 此操作不可恢复")

        return True
```

#### 3. 批量删除

```python
def batch_delete_configs(filter_criteria: dict, soft_delete: bool = True):
    """批量删除配置"""
    from database_models.business_models.openai_models import OpenAIConfig
    from database_models.business_utils import AuditHelper
    from auth.database import get_db
    from auth import auth_manager

    current_user = auth_manager.current_user

    with get_db() as db:
        # 构建查询条件
        query = db.query(OpenAIConfig)
        for field, value in filter_criteria.items():
            if hasattr(OpenAIConfig, field):
                query = query.filter(getattr(OpenAIConfig, field) == value)

        configs = query.all()

        if not configs:
            print("❌ 没有找到符合条件的配置")
            return []

        print(f"📝 准备删除 {len(configs)} 个配置")

        deleted_configs = []
        for config in configs:
            if soft_delete:
                # 软删除
                if config.is_active:
                    config.is_active = False
                    config.description = f"[批量删除] {config.description or ''}"
                    AuditHelper.set_audit_fields(config, current_user.id, is_update=True)
                    deleted_configs.append(config)
                    print(f"  软删除: {config.name}")
            else:
                # 硬删除（需要谨慎）
                print(f"  硬删除: {config.name}")
                db.delete(config)
                deleted_configs.append(config)

        db.commit()

        delete_type = "软删除" if soft_delete else "硬删除"
        print(f"✅ 批量{delete_type}完成，共{delete_type} {len(deleted_configs)} 个配置")

        return deleted_configs

# 使用示例
def batch_delete_example():
    """批量删除示例"""
    # 软删除所有测试配置
    deleted = batch_delete_configs(
        filter_criteria={'name': '测试'},  # 名称包含"测试"的配置
        soft_delete=True
    )
```

---

## 高级应用场景

### 1. 数据统计和报表

```python
def generate_usage_report():
    """生成使用情况报表"""
    from database_models.business_models.openai_models import OpenAIConfig, OpenAIRequest, ModelType
    from database_models.business_utils import UserInfoHelper
    from auth.database import get_db
    from sqlalchemy import func, desc
    from collections import defaultdict

    with get_db() as db:
        # 1. 总体统计
        total_configs = db.query(OpenAIConfig).count()
        active_configs = db.query(OpenAIConfig).filter(OpenAIConfig.is_active == True).count()
        total_requests = db.query(func.sum(OpenAIConfig.total_requests)).scalar() or 0
        total_tokens = db.query(func.sum(OpenAIConfig.total_tokens)).scalar() or 0

        print("📊 OpenAI使用情况报表")
        print("=" * 50)
        print(f"配置统计:")
        print(f"  总配置数: {total_configs}")
        print(f"  活跃配置: {active_configs}")
        print(f"  总请求数: {total_requests:,}")
        print(f"  总tokens: {total_tokens:,}")

        # 2. 按模型类型统计
        model_stats = db.query(
            OpenAIConfig.model_name,
            func.count(OpenAIConfig.id).label('count'),
            func.sum(OpenAIConfig.total_requests).label('requests'),
            func.sum(OpenAIConfig.total_tokens).label('tokens')
        ).group_by(OpenAIConfig.model_name).all()

        print(f"\n📈 按模型类型统计:")
        for stat in model_stats:
            print(f"  {stat.model_name.value}:")
            print(f"    配置数: {stat.count}")
            print(f"    请求数: {stat.requests or 0:,}")
            print(f"    tokens: {stat.tokens or 0:,}")

        # 3. 热门配置Top 5
        top_configs = db.query(OpenAIConfig).order_by(
            desc(OpenAIConfig.total_requests)
        ).limit(5).all()

        print(f"\n🔥 热门配置Top 5:")
        for i, config in enumerate(top_configs, 1):
            creator_info = config.get_creator_info()
            print(f"  {i}. {config.name}")
            print(f"     请求数: {config.total_requests:,}")
            print(f"     创建者: {creator_info['username'] if creator_info else '未知'}")

        # 4. 用户活跃度统计
        user_stats = db.query(
            OpenAIConfig.created_by,
            func.count(OpenAIConfig.id).label('config_count'),
            func.sum(OpenAIConfig.total_requests).label('total_requests')
        ).group_by(OpenAIConfig.created_by).order_by(
            desc('total_requests')
        ).limit(10).all()

        print(f"\n👥 用户活跃度Top 10:")
        for stat in user_stats:
            user_info = UserInfoHelper.get_user_info(stat.created_by)
            username = user_info['username'] if user_info else f'User#{stat.created_by}'
            print(f"  {username}: {stat.config_count}个配置, {stat.total_requests or 0:,}次请求")

        return {
            'total_stats': {
                'total_configs': total_configs,
                'active_configs': active_configs,
                'total_requests': total_requests,
                'total_tokens': total_tokens
            },
            'model_stats': model_stats,
            'top_configs': top_configs,
            'user_stats': user_stats
        }
```

### 2. 数据导入导出

```python
def export_configs_to_json():
    """导出配置到JSON文件"""
    import json
    from datetime import datetime
    from database_models.business_models.openai_models import OpenAIConfig
    from database_models.business_utils import UserInfoHelper
    from auth.database import get_db

    with get_db() as db:
        configs = db.query(OpenAIConfig).filter(OpenAIConfig.is_active == True).all()

        export_data = {
            'export_time': datetime.now().isoformat(),
            'total_count': len(configs),
            'configs': []
        }

        for config in configs:
            creator_info = config.get_creator_info()
            config_data = {
                'id': config.id,
                'name': config.name,
                'model_name': config.model_name.value,
                'max_tokens': config.max_tokens,
                'temperature': config.temperature,
                'is_public': config.is_public,
                'total_requests': config.total_requests,
                'total_tokens': config.total_tokens,
                'description': config.description,
                'created_at': config.created_at.isoformat() if config.created_at else None,
                'creator': creator_info['username'] if creator_info else None
            }
            export_data['configs'].append(config_data)

        # 保存到文件
        filename = f"openai_configs_export_{datetime.now().strftime('%Y%m%d_%H%M%S')}.json"
        with open(filename, 'w', encoding='utf-8') as f:
            json.dump(export_data, f, indent=2, ensure_ascii=False)

        print(f"✅ 配置导出完成")
        print(f"文件名: {filename}")
        print(f"导出配置数: {len(configs)}")

        return filename

def import_configs_from_json(filename: str):
    """从JSON文件导入配置"""
    import json
    from database_models.business_models.openai_models import OpenAIConfig, ModelType
    from database_models.business_utils import AuditHelper
    from auth.database import get_db
    from auth import auth_manager

    current_user = auth_manager.current_user

    try:
        with open(filename, 'r', encoding='utf-8') as f:
            import_data = json.load(f)

        configs_data = import_data.get('configs', [])

        with get_db() as db:
            imported_count = 0
            skipped_count = 0

            for config_data in configs_data:
                # 检查是否已存在同名配置
                existing = db.query(OpenAIConfig).filter(
                    OpenAIConfig.name == config_data['name']
                ).first()

                if existing:
                    print(f"⚠️ 跳过已存在的配置: {config_data['name']}")
                    skipped_count += 1
                    continue

                # 创建新配置
                try:
                    model_name = ModelType(config_data['model_name'])
                except ValueError:
                    print(f"❌ 无效的模型类型: {config_data['model_name']}")
                    skipped_count += 1
                    continue

                config = OpenAIConfig(
                    name=config_data['name'],
                    api_key="需要手动设置",  # 安全考虑，不导入API密钥
                    model_name=model_name,
                    max_tokens=config_data.get('max_tokens', 1000),
                    temperature=config_data.get('temperature', 70),
                    is_public=config_data.get('is_public', False),
                    description=f"[导入] {config_data.get('description', '')}"
                )

                AuditHelper.set_audit_fields(config, current_user.id)
                db.add(config)
                imported_count += 1

                print(f"✅ 导入配置: {config.name}")

            db.commit()

            print(f"\n📊 导入完成")
            print(f"成功导入: {imported_count}")
            print(f"跳过重复: {skipped_count}")
            print(f"⚠️ 请手动设置导入配置的API密钥")

            return imported_count

    except FileNotFoundError:
        print(f"❌ 文件不存在: {filename}")
        return 0
    except json.JSONDecodeError:
        print(f"❌ JSON文件格式错误: {filename}")
        return 0
    except Exception as e:
        print(f"❌ 导入失败: {e}")
        return 0
```

### 3. 数据验证和清理

```python
def validate_and_cleanup_data():
    """数据验证和清理"""
    from database_models.business_models.openai_models import OpenAIConfig, OpenAIRequest
    from database_models.business_utils import AuditHelper
    from auth.database import get_db
    from auth import auth_manager

    current_user = auth_manager.current_user

    with get_db() as db:
        print("🔍 开始数据验证和清理...")

        # 1. 查找无效的API密钥
        invalid_keys = db.query(OpenAIConfig).filter(
            OpenAIConfig.api_key.in_(['', 'sk-example', '需要手动设置'])
        ).all()

        if invalid_keys:
            print(f"\n⚠️ 发现 {len(invalid_keys)} 个无效API密钥的配置:")
            for config in invalid_keys:
                print(f"  - {config.name} (ID: {config.id})")

        # 2. 查找孤儿请求记录（配置已删除）
        orphan_requests = db.query(OpenAIRequest).filter(
            ~OpenAIRequest.config_id.in_(
                db.query(OpenAIConfig.id).filter(OpenAIConfig.is_active == True)
            )
        ).all()

        if orphan_requests:
            print(f"\n🔍 发现 {len(orphan_requests)} 个孤儿请求记录:")
            for request in orphan_requests:
                print(f"  - 请求ID: {request.id}, 配置ID: {request.config_id}")

        # 3. 清理测试数据
        test_configs = db.query(OpenAIConfig).filter(
            OpenAIConfig.name.like('%测试%')
        ).all()

        if test_configs:
            print(f"\n🧹 发现 {len(test_configs)} 个测试配置:")
            for config in test_configs:
                print(f"  - {config.name}")

            # 可选择清理测试数据
            cleanup_choice = input("是否清理测试数据？(y/N): ")
            if cleanup_choice.lower() == 'y':
                for config in test_configs:
                    config.is_active = False
                    config.description = f"[自动清理] {config.description or ''}"
                    AuditHelper.set_audit_fields(config, current_user.id, is_update=True)

                db.commit()
                print(f"✅ 已清理 {len(test_configs)} 个测试配置")

        # 4. 统计数据完整性
        total_configs = db.query(OpenAIConfig).count()
        configs_with_creator = db.query(OpenAIConfig).filter(
            OpenAIConfig.created_by.isnot(None)
        ).count()

        print(f"\n📊 数据完整性统计:")
        print(f"总配置数: {total_configs}")
        print(f"有创建者记录: {configs_with_creator}")
        print(f"缺失创建者: {total_configs - configs_with_creator}")

        return {
            'invalid_keys': len(invalid_keys),
            'orphan_requests': len(orphan_requests),
            'test_configs': len(test_configs),
            'data_integrity': {
                'total_configs': total_configs,
                'with_creator': configs_with_creator,
                'missing_creator': total_configs - configs_with_creator
            }
        }
```

### 4. 性能监控和优化

```python
def monitor_performance():
    """性能监控"""
    import time
    from database_models.business_models.openai_models import OpenAIConfig, OpenAIRequest
    from auth.database import get_db
    from sqlalchemy import text

    print("📈 性能监控报告")
    print("=" * 50)

    with get_db() as db:
        # 1. 查询性能测试
        start_time = time.time()

        # 简单查询
        simple_query_start = time.time()
        simple_result = db.query(OpenAIConfig).count()
        simple_query_time = time.time() - simple_query_start

        # 复杂查询
        complex_query_start = time.time()
        complex_result = db.query(OpenAIConfig).join(OpenAIRequest).count()
        complex_query_time = time.time() - complex_query_start

        # 聚合查询
        agg_query_start = time.time()
        agg_result = db.execute(text("""
            SELECT
                model_name,
                COUNT(*) as config_count,
                SUM(total_requests) as total_requests,
                AVG(total_tokens) as avg_tokens
            FROM openai_configs
            WHERE is_active = 1
            GROUP BY model_name
        """)).fetchall()
        agg_query_time = time.time() - agg_query_start

        total_time = time.time() - start_time

        print(f"查询性能:")
        print(f"  简单查询: {simple_query_time:.4f}s ({simple_result} 条记录)")
        print(f"  复杂查询: {complex_query_time:.4f}s ({complex_result} 条记录)")
        print(f"  聚合查询: {agg_query_time:.4f}s ({len(agg_result)} 个分组)")
        print(f"  总耗时: {total_time:.4f}s")

        # 2. 数据库大小监控
        try:
            size_result = db.execute(text("""
                SELECT
                    name,
                    COUNT(*) as record_count
                FROM sqlite_master
                WHERE type = 'table' AND name LIKE '%openai%'
                GROUP BY name
            """)).fetchall()

            print(f"\n数据表统计:")
            for table in size_result:
                count = db.execute(text(f"SELECT COUNT(*) FROM {table.name}")).scalar()
                print(f"  {table.name}: {count} 条记录")

        except Exception as e:
            print(f"  数据库大小查询失败: {e}")

        # 3. 性能建议
        print(f"\n💡 性能建议:")
        if complex_query_time > 0.1:
            print("  - 考虑为常用查询添加索引")
        if simple_result > 1000:
            print("  - 建议实施数据分页")
        if agg_query_time > 0.05:
            print("  - 考虑添加汇总表优化聚合查询")

        return {
            'query_performance': {
                'simple_query_time': simple_query_time,
                'complex_query_time': complex_query_time,
                'agg_query_time': agg_query_time,
                'total_time': total_time
            },
            'record_counts': {table.name: db.execute(text(f"SELECT COUNT(*) FROM {table.name}")).scalar() for table in size_result}
        }
```

---

## 最佳实践

### 1. 错误处理和日志记录

```python
def safe_operation_example():
    """安全操作示例，包含完整的错误处理"""
    import logging
    from database_models.business_models.openai_models import OpenAIConfig, ModelType
    from database_models.business_utils import AuditHelper
    from auth.database import get_db
    from auth import auth_manager
    from sqlalchemy.exc import IntegrityError, SQLAlchemyError

    # 配置日志
    logger = logging.getLogger(__name__)

    def create_config_safely(name: str, api_key: str, model_name: str):
        """安全地创建配置"""
        try:
            current_user = auth_manager.current_user
            if not current_user:
                logger.error("用户未登录")
                return {'success': False, 'message': '用户未登录'}

            # 验证输入
            if not name or not api_key:
                logger.error(f"无效输入: name={name}, api_key={'***' if api_key else None}")
                return {'success': False, 'message': '名称和API密钥不能为空'}

            # 验证模型类型
            try:
                model_type = ModelType(model_name)
            except ValueError:
                logger.error(f"无效的模型类型: {model_name}")
                return {'success': False, 'message': f'无效的模型类型: {model_name}'}

            with get_db() as db:
                # 检查重名
                existing = db.query(OpenAIConfig).filter(OpenAIConfig.name == name).first()
                if existing:
                    logger.warning(f"配置名称已存在: {name}")
                    return {'success': False, 'message': f'配置名称 "{name}" 已存在'}

                # 创建配置
                config = OpenAIConfig(
                    name=name,
                    api_key=api_key,
                    model_name=model_type
                )

                AuditHelper.set_audit_fields(config, current_user.id)
                db.add(config)
                db.commit()

                logger.info(f"配置创建成功: {name} (ID: {config.id}) by {current_user.username}")
                return {
                    'success': True,
                    'message': '配置创建成功',
                    'config_id': config.id
                }

        except IntegrityError as e:
            logger.error(f"数据完整性错误: {e}")
            return {'success': False, 'message': '数据完整性错误，请检查输入'}

        except SQLAlchemyError as e:
            logger.error(f"数据库错误: {e}")
            return {'success': False, 'message': '数据库操作失败'}

        except Exception as e:
            logger.error(f"未知错误: {e}")
            return {'success': False, 'message': '操作失败，请稍后重试'}

    # 使用示例
    result = create_config_safely("安全测试配置", "sk-test-key", "deepseek-chat")
    if result['success']:
        print(f"✅ {result['message']}, ID: {result['config_id']}")
    else:
        print(f"❌ {result['message']}")

    return result
```

### 2. 事务管理

```python
def transaction_example():
    """事务管理示例"""
    from database_models.business_models.openai_models import OpenAIConfig, OpenAIRequest
    from database_models.business_utils import AuditHelper
    from auth.database import get_db
    from auth import auth_manager
    from sqlalchemy.exc import SQLAlchemyError

    current_user = auth_manager.current_user

    def create_config_with_initial_request():
        """创建配置并同时创建初始请求记录（事务）"""
        try:
            with get_db() as db:
                # 开始事务
                config = OpenAIConfig(
                    name="事务测试配置",
                    api_key="sk-transaction-test",
                    model_name=ModelType.DEEPSEEK
                )
                AuditHelper.set_audit_fields(config, current_user.id)
                db.add(config)
                db.flush()  # 获取ID但不提交

                # 创建初始请求记录
                initial_request = OpenAIRequest(
                    config_id=config.id,
                    user_id=current_user.id,
                    prompt="初始化测试",
                    response="配置创建成功",
                    tokens_used=10,
                    status="success"
                )
                AuditHelper.set_audit_fields(initial_request, current_user.id)
                db.add(initial_request)

                # 更新配置统计
                config.total_requests = 1
                config.total_tokens = 10
                AuditHelper.set_audit_fields(config, current_user.id, is_update=True)

                # 提交事务
                db.commit()

                print(f"✅ 事务完成，配置ID: {config.id}, 请求ID: {initial_request.id}")
                return {'success': True, 'config_id': config.id, 'request_id': initial_request.id}

        except SQLAlchemyError as e:
            print(f"❌ 事务失败，已回滚: {e}")
            return {'success': False, 'error': str(e)}

    return create_config_with_initial_request()
```

### 3. 缓存策略

```python
def caching_example():
    """缓存策略示例"""
    import time
    from functools import lru_cache
    from database_models.business_models.openai_models import OpenAIConfig
    from database_models.business_utils import UserInfoHelper
    from auth.database import get_db

    # 1. 使用LRU缓存
    @lru_cache(maxsize=128)
    def get_config_summary_cached(config_id: int):
        """缓存配置摘要信息"""
        with get_db() as db:
            config = db.query(OpenAIConfig).filter(OpenAIConfig.id == config_id).first()
            if config:
                creator_info = config.get_creator_info()
                return {
                    'id': config.id,
                    'name': config.name,
                    'model_name': config.model_name.value,
                    'creator': creator_info['username'] if creator_info else None,
                    'created_at': config.created_at.isoformat() if config.created_at else None
                }
        return None

    # 2. 手动缓存管理
    class ConfigCache:
        def __init__(self):
            self._cache = {}
            self._cache_time = {}
            self._ttl = 300  # 5分钟TTL

        def get(self, key):
            if key in self._cache:
                if time.time() - self._cache_time[key] < self._ttl:
                    return self._cache[key]
                else:
                    # 缓存过期
                    del self._cache[key]
                    del self._cache_time[key]
            return None

        def set(self, key, value):
            self._cache[key] = value
            self._cache_time[key] = time.time()

        def clear(self):
            self._cache.clear()
            self._cache_time.clear()

    # 全局缓存实例
    config_cache = ConfigCache()

    def get_popular_configs():
        """获取热门配置（带缓存）"""
        cache_key = "popular_configs"
        cached_result = config_cache.get(cache_key)

        if cached_result:
            print("📋 从缓存获取热门配置")
            return cached_result

        print("🔍 从数据库查询热门配置")
        with get_db() as db:
            configs = db.query(OpenAIConfig).filter(
                OpenAIConfig.is_active == True
            ).order_by(OpenAIConfig.total_requests.desc()).limit(10).all()

            result = []
            for config in configs:
                creator_info = config.get_creator_info()
                result.append({
                    'id': config.id,
                    'name': config.name,
                    'total_requests': config.total_requests,
                    'creator': creator_info['username'] if creator_info else None
                })

            config_cache.set(cache_key, result)
            return result

    # 使用示例
    print("第一次查询:")
    popular_configs = get_popular_configs()
    print(f"获取到 {len(popular_configs)} 个热门配置")

    print("\n第二次查询:")
    popular_configs = get_popular_configs()  # 这次会从缓存获取

    return popular_configs
```

---

## 故障排除

### 常见问题和解决方案

#### 1. 模型导入问题

```python
def troubleshoot_import_issues():
    """排查模型导入问题"""
    print("🔍 检查模型导入状态...")

    try:
        from database_models.business_models.openai_models import OpenAIConfig, OpenAIRequest, ModelType
        print("✅ OpenAI模型导入成功")
    except ImportError as e:
        print(f"❌ OpenAI模型导入失败: {e}")
        return False

    try:
        from database_models.shared_base import BusinessBaseModel, TimestampMixin, AuditMixin
        print("✅ 基础模型导入成功")
    except ImportError as e:
        print(f"❌ 基础模型导入失败: {e}")
        return False

    try:
        from database_models.business_utils import UserInfoHelper, AuditHelper
        print("✅ 工具类导入成功")
    except ImportError as e:
        print(f"❌ 工具类导入失败: {e}")
        return False

    return True
```

#### 2. 数据库连接问题

```python
def troubleshoot_database_connection():
    """排查数据库连接问题"""
    print("🔍 检查数据库连接...")

    try:
        from auth.database import get_db, check_connection

        # 检查连接
        if check_connection():
            print("✅ 数据库连接正常")
        else:
            print("❌ 数据库连接失败")
            return False

        # 检查表是否存在
        with get_db() as db:
            from database_models.business_models.openai_models import OpenAIConfig

            try:
                count = db.query(OpenAIConfig).count()
                print(f"✅ OpenAI配置表正常，共 {count} 条记录")
            except Exception as e:
                print(f"❌ OpenAI配置表访问失败: {e}")
                return False

        return True

    except Exception as e:
        print(f"❌ 数据库检查失败: {e}")
        return False
```

#### 3. 权限问题排查

```python
def troubleshoot_permission_issues():
    """排查权限问题"""
    print("🔍 检查用户权限...")

    try:
        from auth import auth_manager

        current_user = auth_manager.current_user
        if not current_user:
            print("❌ 用户未登录")
            return False

        print(f"✅ 当前用户: {current_user.username}")

        # 检查基础权限
        if hasattr(current_user, 'has_permission'):
            permissions_to_check = [
                'openai.view',
                'openai.create',
                'openai.edit',
                'openai.delete'
            ]

            for perm in permissions_to_check:
                has_perm = current_user.has_permission(perm)
                status = "✅" if has_perm else "❌"
                print(f"{status} 权限 {perm}: {'有' if has_perm else '无'}")

        # 检查角色
        if hasattr(current_user, 'roles'):
            print(f"用户角色: {current_user.roles}")

        return True

    except Exception as e:
        print(f"❌ 权限检查失败: {e}")
        return False
```

### 诊断脚本

```python
def run_full_diagnosis():
    """运行完整诊断"""
    print("🏥 开始系统诊断...")
    print("=" * 50)

    results = {
        'import_check': troubleshoot_import_issues(),
        'database_check': troubleshoot_database_connection(),
        'permission_check': troubleshoot_permission_issues()
    }

    print("\n📋 诊断结果:")
    print("=" * 50)

    all_ok = True
    for check_name, result in results.items():
        status = "✅ 正常" if result else "❌ 异常"
        print(f"{check_name}: {status}")
        if not result:
            all_ok = False

    if all_ok:
        print("\n🎉 系统状态良好，所有检查均通过！")
    else:
        print("\n⚠️ 发现问题，请根据上述信息进行修复。")

    return results

# 运行诊断
if __name__ == "__main__":
    diagnosis_results = run_full_diagnosis()
```

---

## 总结

本文档详细介绍了业务模型系统的三个核心组件的使用方法：

### 🎯 核心价值

1. **`shared_base.py`**：提供统一的基础架构，包含时间戳、审计字段等
2. **`openai_models.py`**：具体业务模型实现，展示了完整的表设计模式
3. **`business_utils.py`**：工具类集合，实现跨模块的松耦合设计

### 📚 学习路径

1. **新手入门**：从基础的增删改查操作开始
2. **进阶应用**：掌握事务管理、缓存策略、批量操作
3. **高级应用**：学习性能监控、数据导入导出、报表生成

### 🛠️ 最佳实践

- 始终使用 `AuditHelper` 设置审计字段
- 用 `UserInfoHelper` 获取用户信息，避免直接依赖
- 实施完整的错误处理和日志记录
- 合理使用事务确保数据一致性
- 根据需要实施缓存策略

这套系统为业务模型的开发提供了完整的框架支持，既保证了功能的完整性，又实现了良好的架构设计。
