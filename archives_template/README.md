# ä¼ä¸šæ¡£æ¡ˆæ‰å¹³åŒ–æ•°æ®æ¨¡å‹è®¾è®¡æ–‡æ¡£

## æ–‡æ¡£æ¦‚è¿°

**é¡¹ç›®åç§°**ï¼šä¼ä¸šæ¡£æ¡ˆç®¡ç†ç³»ç»Ÿ  
**æ–‡æ¡£ç‰ˆæœ¬**ï¼šv1.0  
**åˆ›å»ºæ—¶é—´**ï¼š2025 å¹´ 7 æœˆ 26 æ—¥  
**æ–‡æ¡£ä½œè€…**ï¼šç³»ç»Ÿæ¶æ„å¸ˆ  
**é€‚ç”¨èŒƒå›´**ï¼šä¼ä¸šæ¡£æ¡ˆæ•°æ®å­˜å‚¨ã€æŸ¥è¯¢ã€åˆ†æç³»ç»Ÿ

## 1. è®¾è®¡èƒŒæ™¯

### 1.1 ä¸šåŠ¡éœ€æ±‚

- ç®¡ç†ä¼ä¸šçš„ 1500+ä¸ªæ¡£æ¡ˆå­—æ®µ
- æ”¯æŒå››çº§å±‚çº§ç»“æ„ï¼šä¸€çº§åˆ†ç±» â†’ äºŒçº§åˆ†ç±» â†’ ä¸‰çº§åˆ†ç±» â†’ å…·ä½“å­—æ®µ
- éœ€è¦é«˜æ•ˆçš„å­—æ®µçº§ CRUD æ“ä½œ
- æ”¯æŒè·¨ä¼ä¸šæ•°æ®ç»Ÿè®¡åˆ†æ
- å‰ç«¯éœ€è¦çµæ´»çš„å±‚çº§å±•ç¤ºå’Œå››çº§è”åŠ¨é€‰æ‹©

### 1.2 ä¼ ç»ŸåµŒå¥—æ¨¡å‹çš„é—®é¢˜

- **æ€§èƒ½ç“¶é¢ˆ**ï¼šæ·±åº¦åµŒå¥—å¯¼è‡´æŸ¥è¯¢æ•ˆç‡ä½ä¸‹
- **æ›´æ–°å›°éš¾**ï¼šä¿®æ”¹å•ä¸ªå­—æ®µéœ€è¦æ›´æ–°æ•´ä¸ªä¼ä¸šæ–‡æ¡£
- **ç´¢å¼•é™åˆ¶**ï¼šåµŒå¥—æ•°ç»„éš¾ä»¥å»ºç«‹æœ‰æ•ˆç´¢å¼•
- **å†…å­˜å¼€é”€**ï¼šå•ä¸ªä¼ä¸šæ–‡æ¡£è¿‡å¤§ï¼ˆMB çº§åˆ«ï¼‰
- **æ‰©å±•æ€§å·®**ï¼šæ–°å¢å­—æ®µéœ€è¦ä¿®æ”¹ç°æœ‰æ•°æ®ç»“æ„

### 1.3 è®¾è®¡ç›®æ ‡

- ğŸ¯ **é«˜æ€§èƒ½**ï¼šå­—æ®µçº§æ“ä½œè¾¾åˆ°æ¯«ç§’çº§å“åº”
- ğŸ¯ **å¯æ‰©å±•**ï¼šè½»æ¾æ·»åŠ æ–°å­—æ®µã€æ–°åˆ†ç±»ã€æ–°ä¼ä¸š
- ğŸ¯ **æ˜“æŸ¥è¯¢**ï¼šæ”¯æŒå¤æ‚çš„ç»Ÿè®¡åˆ†æå’Œæ¨¡ç³ŠæŸ¥è¯¢
- ğŸ¯ **å‰ç«¯å‹å¥½**ï¼šä¾¿äºå®ç°å››çº§è”åŠ¨å’Œæ ‘å½¢å±•ç¤º
- ğŸ¯ **æ•°æ®ä¸€è‡´æ€§**ï¼šä¿è¯æ•°æ®å®Œæ•´æ€§å’Œå…³è”å…³ç³»

## 2. æ‰å¹³åŒ–è®¾è®¡æ ¸å¿ƒæ€æƒ³

### 2.1 è®¾è®¡åŸåˆ™

**"ä¸€ä¸ªå­—æ®µ = ä¸€ä¸ªæ–‡æ¡£"**

å°†ä¼ ç»Ÿçš„åµŒå¥—ç»“æ„å®Œå…¨æ‰å¹³åŒ–ï¼š

```
ä¼ ç»Ÿæ¨¡å‹ï¼š1ä¸ªä¼ä¸š = 1ä¸ªå¤æ‚åµŒå¥—æ–‡æ¡£ï¼ˆåŒ…å«1500ä¸ªå­—æ®µï¼‰
æ‰å¹³åŒ–æ¨¡å‹ï¼š1ä¸ªä¼ä¸š = 1500ä¸ªç‹¬ç«‹å­—æ®µæ–‡æ¡£ï¼ˆæ¾æ•£å…³è”ï¼‰
```

### 2.2 å…³è”æ–¹å¼

é€šè¿‡ä»¥ä¸‹å­—æ®µç»´æŠ¤é€»è¾‘å…³è”å…³ç³»ï¼š

- `enterprise_code`ï¼šä¼ä¸šç»´åº¦å…³è”
- `l1_code`, `l2_code`, `l3_code`ï¼šå±‚çº§ç»´åº¦å…³è”
- `path_code`, `path_name`ï¼šè·¯å¾„ç»´åº¦å…³è”
- æ’åºå­—æ®µï¼š`l1_order`, `l2_order`, `l3_order`, `field_order`

## 3. æ•°æ®æ¨¡å‹è®¾è®¡

### 3.1 æ–‡æ¡£ç»“æ„

```json
{
  "_id": "ObjectId",

  // === ä¼ä¸šç»´åº¦ ===
  "enterprise_code": "E001", // ä¼ä¸šä»£ç ï¼ˆä¸»è¦æŸ¥è¯¢ç»´åº¦ï¼‰
  "enterprise_name": "ç¤ºä¾‹ç§‘æŠ€æœ‰é™å…¬å¸", // ä¼ä¸šåç§°

  // === å±‚çº§ç»´åº¦ ===
  "l1_code": "L1A1B2C3", // ä¸€çº§åˆ†ç±»ç¼–ç 
  "l1_name": "åŸºæœ¬ä¿¡æ¯", // ä¸€çº§åˆ†ç±»åç§°
  "l2_code": "L2D4E5F6", // äºŒçº§åˆ†ç±»ç¼–ç 
  "l2_name": "ç™»è®°ä¿¡æ¯", // äºŒçº§åˆ†ç±»åç§°
  "l3_code": "L3G7H8I9", // ä¸‰çº§åˆ†ç±»ç¼–ç 
  "l3_name": "ä¼ä¸šåŸºæœ¬ä¿¡æ¯", // ä¸‰çº§åˆ†ç±»åç§°

  // === è·¯å¾„ç»´åº¦ ===
  "path_code": "L1A1B2C3.L2D4E5F6.L3G7H8I9", // ç¼–ç è·¯å¾„
  "path_name": "åŸºæœ¬ä¿¡æ¯.ç™»è®°ä¿¡æ¯.ä¼ä¸šåŸºæœ¬ä¿¡æ¯", // åç§°è·¯å¾„
  "full_path_code": "L1A1B2C3.L2D4E5F6.L3G7H8I9.FJ1K2L3", // å®Œæ•´ç¼–ç è·¯å¾„
  "full_path_name": "åŸºæœ¬ä¿¡æ¯.ç™»è®°ä¿¡æ¯.ä¼ä¸šåŸºæœ¬ä¿¡æ¯.ç»Ÿä¸€ç¤¾ä¼šä¿¡ç”¨ä»£ç ", // å®Œæ•´åç§°è·¯å¾„

  // === å­—æ®µç»´åº¦ ===
  "field_code": "FJ1K2L3", // å­—æ®µç¼–ç 
  "field_name": "ç»Ÿä¸€ç¤¾ä¼šä¿¡ç”¨ä»£ç ", // å­—æ®µåç§°
  "field_type": "string", // å­—æ®µç±»å‹

  // === æ•°æ®ç»´åº¦ ===
  "value": "91110000123456789X", // å­—æ®µå€¼
  "value_text": "91110000123456789X", // æ–‡æœ¬å€¼ï¼ˆç”¨äºå…¨æ–‡æ£€ç´¢ï¼‰

  // === å…ƒæ•°æ®ç»´åº¦ ===
  "remark": "å¿…å¡«é¡¹", // å¤‡æ³¨è¯´æ˜
  "data_url": "http://api.example.com", // æ•°æ®æºURL
  "is_required": true, // æ˜¯å¦å¿…å¡«
  "data_source": "å·¥å•†å±€", // æ•°æ®æ¥æº

  // === æ’åºç»´åº¦ ===
  "l1_order": 1, // ä¸€çº§åˆ†ç±»æ’åº
  "l2_order": 1, // äºŒçº§åˆ†ç±»æ’åº
  "l3_order": 1, // ä¸‰çº§åˆ†ç±»æ’åº
  "field_order": 1, // å­—æ®µæ’åº

  // === æ—¶é—´ç»´åº¦ ===
  "create_time": "2025-07-26T10:30:00Z", // åˆ›å»ºæ—¶é—´
  "update_time": "2025-07-26T10:30:00Z", // æ›´æ–°æ—¶é—´

  // === çŠ¶æ€ç»´åº¦ ===
  "status": "active" // æ•°æ®çŠ¶æ€ï¼šactive/inactive/draft
}
```

### 3.2 å­—æ®µç±»å‹å®šä¹‰

| å­—æ®µç±»å‹  | è¯´æ˜     | ç¤ºä¾‹å­—æ®µ           |
| --------- | -------- | ------------------ |
| `string`  | æ–‡æœ¬ç±»å‹ | ä¼ä¸šåç§°ã€åœ°å€     |
| `number`  | æ•°å€¼ç±»å‹ | æ³¨å†Œèµ„é‡‘ã€å‘˜å·¥æ•°é‡ |
| `date`    | æ—¥æœŸç±»å‹ | æˆç«‹æ—¥æœŸã€ç™»è®°æ—¥æœŸ |
| `boolean` | å¸ƒå°”ç±»å‹ | æ˜¯å¦ä¸Šå¸‚ã€æ˜¯å¦å›½ä¼ |
| `email`   | é‚®ç®±ç±»å‹ | è”ç³»é‚®ç®±           |
| `phone`   | ç”µè¯ç±»å‹ | è”ç³»ç”µè¯ã€ä¼ çœŸ     |
| `url`     | é“¾æ¥ç±»å‹ | ä¼ä¸šç½‘ç«™           |

### 3.3 ç¼–ç è§„åˆ™

#### 3.3.1 å±‚çº§ç¼–ç 

- **ä¸€çº§åˆ†ç±»ç¼–ç **ï¼š`L1` + 6 ä½å“ˆå¸Œç ï¼Œå¦‚ `L1A1B2C3`
- **äºŒçº§åˆ†ç±»ç¼–ç **ï¼š`L2` + 6 ä½å“ˆå¸Œç ï¼Œå¦‚ `L2D4E5F6`
- **ä¸‰çº§åˆ†ç±»ç¼–ç **ï¼š`L3` + 6 ä½å“ˆå¸Œç ï¼Œå¦‚ `L3G7H8I9`
- **å­—æ®µç¼–ç **ï¼š`F` + 6 ä½å“ˆå¸Œç ï¼Œå¦‚ `FJ1K2L3`

#### 3.3.2 å“ˆå¸Œç®—æ³•

ä½¿ç”¨ MD5 å“ˆå¸Œç¡®ä¿ç¼–ç çš„å”¯ä¸€æ€§å’Œä¸€è‡´æ€§ï¼š

```python
def generate_code(name: str, level: str, parent_code: str = "") -> str:
    hash_input = f"{parent_code}_{name}" if parent_code else name
    hash_code = hashlib.md5(hash_input.encode('utf-8')).hexdigest()[:6].upper()
    return f"{level_prefix}{hash_code}"
```

## 4. ç´¢å¼•è®¾è®¡

### 4.1 ä¸»è¦ç´¢å¼•

```javascript
// 1. ä¼ä¸šä¸»ç´¢å¼• - æœ€å¸¸ç”¨æŸ¥è¯¢
db.enterprise_fields.createIndex(
  {
    enterprise_code: 1,
    l1_code: 1,
    l2_code: 1,
    l3_code: 1,
    field_order: 1,
  },
  { name: "idx_enterprise_hierarchy" }
);

// 2. è·¯å¾„æŸ¥è¯¢ç´¢å¼•
db.enterprise_fields.createIndex(
  {
    enterprise_code: 1,
    path_code: 1,
  },
  { name: "idx_enterprise_path" }
);

// 3. å­—æ®µæŸ¥è¯¢ç´¢å¼•
db.enterprise_fields.createIndex(
  {
    enterprise_code: 1,
    field_name: 1,
  },
  { name: "idx_enterprise_field" }
);

// 4. å…¨æ–‡æœç´¢ç´¢å¼•
db.enterprise_fields.createIndex(
  {
    field_name: "text",
    value_text: "text",
    remark: "text",
  },
  {
    name: "idx_fulltext_search",
    weights: {
      field_name: 10,
      value_text: 5,
      remark: 1,
    },
  }
);

// 5. åˆ†ç±»ç»Ÿè®¡ç´¢å¼•
db.enterprise_fields.createIndex(
  {
    l1_code: 1,
    l2_code: 1,
    l3_code: 1,
  },
  { name: "idx_category_stats" }
);

// 6. å”¯ä¸€æ€§çº¦æŸç´¢å¼•
db.enterprise_fields.createIndex(
  {
    enterprise_code: 1,
    field_code: 1,
  },
  { name: "idx_unique_enterprise_field", unique: true }
);
```

### 4.2 åˆ†ç‰‡ç­–ç•¥ï¼ˆå¤§è§„æ¨¡éƒ¨ç½²ï¼‰

```javascript
// æŒ‰ä¼ä¸šä»£ç è¿›è¡Œåˆ†ç‰‡ï¼Œæ”¯æŒæ°´å¹³æ‰©å±•
sh.shardCollection("enterprise_db.enterprise_fields", {
  enterprise_code: 1,
  l1_code: 1,
});
```

## 5. æ ¸å¿ƒæŸ¥è¯¢æ¨¡å¼

### 5.1 å•ä¼ä¸šå®Œæ•´æ•°æ®æŸ¥è¯¢

```javascript
// è·å–ä¼ä¸šçš„å±‚çº§ç»“æ„æ•°æ®ï¼ˆç”¨äºå‰ç«¯æ ‘å½¢å±•ç¤ºï¼‰
db.enterprise_fields.aggregate([
  { $match: { enterprise_code: "E001", status: "active" } },
  { $sort: { l1_order: 1, l2_order: 1, l3_order: 1, field_order: 1 } },

  // æŒ‰ä¸‰çº§åˆ†ç±»åˆ†ç»„
  {
    $group: {
      _id: {
        l1_code: "$l1_code",
        l1_name: "$l1_name",
        l2_code: "$l2_code",
        l2_name: "$l2_name",
        l3_code: "$l3_code",
        l3_name: "$l3_name",
      },
      fields: {
        $push: {
          field_code: "$field_code",
          field_name: "$field_name",
          value: "$value",
          is_required: "$is_required",
        },
      },
    },
  },

  // æŒ‰äºŒçº§åˆ†ç±»åˆ†ç»„
  {
    $group: {
      _id: {
        l1_code: "$_id.l1_code",
        l1_name: "$_id.l1_name",
        l2_code: "$_id.l2_code",
        l2_name: "$_id.l2_name",
      },
      level3_categories: {
        $push: {
          l3_code: "$_id.l3_code",
          l3_name: "$_id.l3_name",
          fields: "$fields",
        },
      },
    },
  },

  // æŒ‰ä¸€çº§åˆ†ç±»åˆ†ç»„
  {
    $group: {
      _id: { l1_code: "$_id.l1_code", l1_name: "$_id.l1_name" },
      level2_categories: {
        $push: {
          l2_code: "$_id.l2_code",
          l2_name: "$_id.l2_name",
          level3_categories: "$level3_categories",
        },
      },
    },
  },
]);
```

### 5.2 å­—æ®µçº§æŸ¥è¯¢

```javascript
// ç²¾ç¡®æŸ¥è¯¢ç‰¹å®šå­—æ®µ
db.enterprise_fields.findOne({
  enterprise_code: "E001",
  field_name: "ç»Ÿä¸€ç¤¾ä¼šä¿¡ç”¨ä»£ç ",
});

// æ¨¡ç³ŠæŸ¥è¯¢å­—æ®µ
db.enterprise_fields
  .find({
    enterprise_code: "E001",
    $text: { $search: "ç»Ÿä¸€ ä¿¡ç”¨" },
  })
  .hint("idx_fulltext_search");

// æŒ‰åˆ†ç±»æŸ¥è¯¢å­—æ®µ
db.enterprise_fields
  .find({
    enterprise_code: "E001",
    l1_name: "åŸºæœ¬ä¿¡æ¯",
    l2_name: "ç™»è®°ä¿¡æ¯",
  })
  .sort({ l3_order: 1, field_order: 1 });
```

### 5.3 è·¨ä¼ä¸šç»Ÿè®¡åˆ†æ

```javascript
// æ³¨å†Œèµ„é‡‘ç»Ÿè®¡åˆ†æ
db.enterprise_fields.aggregate([
  {
    $match: {
      field_name: "æ³¨å†Œèµ„é‡‘",
      value: { $ne: "", $ne: null },
    },
  },

  // æ•°æ®ç±»å‹è½¬æ¢
  {
    $addFields: {
      numeric_value: {
        $toDouble: {
          $replaceAll: { input: "$value", find: "ä¸‡å…ƒ", replacement: "" },
        },
      },
    },
  },

  // ç»Ÿè®¡è®¡ç®—
  {
    $group: {
      _id: null,
      æ€»ä¼ä¸šæ•°: { $sum: 1 },
      å¹³å‡æ³¨å†Œèµ„é‡‘: { $avg: "$numeric_value" },
      æœ€å¤§æ³¨å†Œèµ„é‡‘: { $max: "$numeric_value" },
      æœ€å°æ³¨å†Œèµ„é‡‘: { $min: "$numeric_value" },
      æ ‡å‡†å·®: { $stdDevPop: "$numeric_value" },
    },
  },
]);

// æŒ‰åœ°åŒºç»Ÿè®¡ä¼ä¸šåˆ†å¸ƒ
db.enterprise_fields.aggregate([
  { $match: { field_name: { $in: ["æ³¨å†Œèµ„é‡‘", "ä¼ä¸šåœ°å€"] } } },

  // é‡ç»„ä¼ä¸šæ•°æ®
  {
    $group: {
      _id: "$enterprise_code",
      enterprise_name: { $first: "$enterprise_name" },
      fields: { $push: { field_name: "$field_name", value: "$value" } },
    },
  },

  // æå–åœ°åŒºå’Œèµ„é‡‘ä¿¡æ¯
  {
    $addFields: {
      åœ°åŒº: {
        $substr: [
          {
            $arrayElemAt: [
              {
                $map: {
                  input: {
                    $filter: {
                      input: "$fields",
                      cond: { $eq: ["$$this.field_name", "ä¼ä¸šåœ°å€"] },
                    },
                  },
                  as: "item",
                  in: "$$item.value",
                },
              },
              0,
            ],
          },
          0,
          2,
        ],
      },
      æ³¨å†Œèµ„é‡‘: {
        $toDouble: {
          $replaceAll: {
            input: {
              $arrayElemAt: [
                {
                  $map: {
                    input: {
                      $filter: {
                        input: "$fields",
                        cond: { $eq: ["$$this.field_name", "æ³¨å†Œèµ„é‡‘"] },
                      },
                    },
                    as: "item",
                    in: "$$item.value",
                  },
                },
                0,
              ],
            },
            find: "ä¸‡å…ƒ",
            replacement: "",
          },
        },
      },
    },
  },

  // æŒ‰åœ°åŒºåˆ†ç»„ç»Ÿè®¡
  {
    $group: {
      _id: "$åœ°åŒº",
      ä¼ä¸šæ•°é‡: { $sum: 1 },
      å¹³å‡æ³¨å†Œèµ„é‡‘: { $avg: "$æ³¨å†Œèµ„é‡‘" },
      èµ„é‡‘æ€»å’Œ: { $sum: "$æ³¨å†Œèµ„é‡‘" },
    },
  },

  { $sort: { èµ„é‡‘æ€»å’Œ: -1 } },
]);
```

### 5.4 å››çº§è”åŠ¨æŸ¥è¯¢

```javascript
// è·å–ä¸€çº§åˆ†ç±»åˆ—è¡¨
db.enterprise_fields.distinct("l1_name", { status: "active" });

// æ ¹æ®ä¸€çº§åˆ†ç±»è·å–äºŒçº§åˆ†ç±»
db.enterprise_fields
  .find(
    {
      l1_code: "L1A1B2C3",
      status: "active",
    },
    { l2_code: 1, l2_name: 1, l2_order: 1 }
  )
  .sort({ l2_order: 1 });

// æ ¹æ®å‰ä¸¤çº§è·å–ä¸‰çº§åˆ†ç±»
db.enterprise_fields
  .find(
    {
      l1_code: "L1A1B2C3",
      l2_code: "L2D4E5F6",
      status: "active",
    },
    { l3_code: 1, l3_name: 1, l3_order: 1 }
  )
  .sort({ l3_order: 1 });

// æ ¹æ®å‰ä¸‰çº§è·å–å­—æ®µåˆ—è¡¨
db.enterprise_fields
  .find(
    {
      l1_code: "L1A1B2C3",
      l2_code: "L2D4E5F6",
      l3_code: "L3G7H8I9",
      status: "active",
    },
    { field_code: 1, field_name: 1, field_order: 1 }
  )
  .sort({ field_order: 1 });
```

## 6. CRUD æ“ä½œ

### 6.1 åˆ›å»ºæ“ä½œ

#### 6.1.1 æ·»åŠ æ–°å­—æ®µåˆ°å•ä¸ªä¼ä¸š

```javascript
// ä¸ºä¼ä¸šE001æ·»åŠ æ–°å­—æ®µ"ä¼ä¸šç®€ç§°"
const newField = {
  enterprise_code: "E001",
  enterprise_name: "ç¤ºä¾‹ç§‘æŠ€æœ‰é™å…¬å¸",
  l1_code: "L1A1B2C3",
  l1_name: "åŸºæœ¬ä¿¡æ¯",
  l2_code: "L2D4E5F6",
  l2_name: "ç™»è®°ä¿¡æ¯",
  l3_code: "L3G7H8I9",
  l3_name: "ä¼ä¸šåŸºæœ¬ä¿¡æ¯",
  field_code: "F_SHORT_NAME",
  field_name: "ä¼ä¸šç®€ç§°",
  field_type: "string",
  value: "ç¤ºä¾‹ç§‘æŠ€",
  is_required: false,
  create_time: new Date(),
  update_time: new Date(),
  status: "active",
};

db.enterprise_fields.insertOne(newField);
```

#### 6.1.2 ä¸ºæ‰€æœ‰ä¼ä¸šæ‰¹é‡æ·»åŠ å­—æ®µ

```javascript
// è·å–æ‰€æœ‰ä¼ä¸šä»£ç 
const enterprises = db.enterprise_fields.distinct("enterprise_code");

// æ‰¹é‡ç”Ÿæˆæ–‡æ¡£
const bulkOps = enterprises.map((code) => ({
  insertOne: {
    document: {
      enterprise_code: code,
      // ... å…¶ä»–å­—æ®µä¿¡æ¯
      field_name: "æ–°å­—æ®µå",
      value: "",
      create_time: new Date(),
    },
  },
}));

db.enterprise_fields.bulkWrite(bulkOps);
```

### 6.2 è¯»å–æ“ä½œ

```javascript
// è¯»å–ä¼ä¸šçš„ç‰¹å®šå­—æ®µå€¼
db.enterprise_fields.findOne(
  {
    enterprise_code: "E001",
    field_name: "ç»Ÿä¸€ç¤¾ä¼šä¿¡ç”¨ä»£ç ",
  },
  { value: 1 }
);

// è¯»å–ä¼ä¸šçš„æŸä¸ªåˆ†ç±»ä¸‹æ‰€æœ‰å­—æ®µ
db.enterprise_fields
  .find({
    enterprise_code: "E001",
    l3_code: "L3G7H8I9",
  })
  .sort({ field_order: 1 });
```

### 6.3 æ›´æ–°æ“ä½œ

```javascript
// æ›´æ–°å•ä¸ªå­—æ®µå€¼
db.enterprise_fields.updateOne(
  {
    enterprise_code: "E001",
    field_name: "æ³¨å†Œèµ„é‡‘",
  },
  {
    $set: {
      value: "2000ä¸‡å…ƒ",
      update_time: new Date(),
    },
  }
);

// æ‰¹é‡æ›´æ–°æŸç±»å­—æ®µ
db.enterprise_fields.updateMany(
  {
    enterprise_code: "E001",
    l1_name: "åŸºæœ¬ä¿¡æ¯",
    value: "",
  },
  {
    $set: {
      status: "incomplete",
      update_time: new Date(),
    },
  }
);
```

### 6.4 åˆ é™¤æ“ä½œ

```javascript
// åˆ é™¤ç‰¹å®šå­—æ®µï¼ˆè½¯åˆ é™¤ï¼‰
db.enterprise_fields.updateOne(
  {
    enterprise_code: "E001",
    field_code: "F_TEMP_FIELD",
  },
  {
    $set: {
      status: "inactive",
      update_time: new Date(),
    },
  }
);

// ç‰©ç†åˆ é™¤ï¼ˆè°¨æ…ä½¿ç”¨ï¼‰
db.enterprise_fields.deleteOne({
  enterprise_code: "E001",
  field_code: "F_TEMP_FIELD",
});
```

## 7. æ€§èƒ½ä¼˜åŒ–

### 7.1 æŸ¥è¯¢æ€§èƒ½

| æ“ä½œç±»å‹   | ä¼ ç»ŸåµŒå¥—æ¨¡å‹        | æ‰å¹³åŒ–æ¨¡å‹          | æ€§èƒ½æå‡     |
| ---------- | ------------------- | ------------------- | ------------ |
| å•å­—æ®µæŸ¥è¯¢ | éœ€è¦æ‰«ææ•´ä¸ªæ–‡æ¡£    | ç›´æ¥ç´¢å¼•å®šä½        | 100-1000 å€  |
| å­—æ®µæ›´æ–°   | æ›´æ–°æ•´ä¸ªæ–‡æ¡£(MB çº§) | æ›´æ–°å•ä¸ªæ–‡æ¡£(KB çº§) | 1000-2000 å€ |
| è·¨ä¼ä¸šç»Ÿè®¡ | å†…å­˜è§£æåµŒå¥—ç»“æ„    | ç›´æ¥èšåˆè®¡ç®—        | 10-100 å€    |
| æ¨¡ç³Šæœç´¢   | å…¨æ–‡æ¡£æ‰«æ          | å…¨æ–‡ç´¢å¼•            | 50-500 å€    |

### 7.2 å­˜å‚¨ç©ºé—´

```
å•ä¸ªå­—æ®µæ–‡æ¡£å¤§å°ï¼šçº¦500-800å­—èŠ‚
å•ä¼ä¸šå­˜å‚¨ï¼ˆ1500å­—æ®µï¼‰ï¼š1500 Ã— 600å­—èŠ‚ â‰ˆ 900KB
1000ä¸ªä¼ä¸šæ€»å­˜å‚¨ï¼šçº¦900MB
åŒ…å«ç´¢å¼•æ€»å­˜å‚¨ï¼šçº¦1.5-2GB

ç›¸æ¯”åµŒå¥—æ¨¡å‹èŠ‚çœï¼š60-70%å­˜å‚¨ç©ºé—´
```

### 7.3 å¹¶å‘æ€§èƒ½

**å†™æ“ä½œå¹¶å‘**ï¼š

- ä¸åŒå­—æ®µå¯ä»¥å®Œå…¨å¹¶è¡Œæ›´æ–°
- é¿å…æ–‡æ¡£çº§é”ç«äº‰
- æ”¯æŒé«˜å¹¶å‘å†™å…¥åœºæ™¯

**è¯»æ“ä½œå¹¶å‘**ï¼š

- å­—æ®µçº§ç¼“å­˜ç­–ç•¥
- å‡å°‘é”ç­‰å¾…æ—¶é—´
- æå‡æ•´ä½“ååé‡

## 8. æ‰©å±•æ€§è®¾è®¡

### 8.1 æ°´å¹³æ‰©å±•

**åˆ†ç‰‡ç­–ç•¥**ï¼š

```javascript
// æŒ‰ä¼ä¸šä»£ç åˆ†ç‰‡
sh.shardCollection("enterprise_db.enterprise_fields", {
  enterprise_code: 1,
});

// æ”¯æŒä¼ä¸šç»´åº¦çš„æ°´å¹³æ‰©å±•
// æ–°å¢ä¼ä¸šè‡ªåŠ¨åˆ†å¸ƒåˆ°ä¸åŒåˆ†ç‰‡
```

**å®¹é‡è§„åˆ’**ï¼š

```
å°è§„æ¨¡ï¼š1,000ä¼ä¸š Ã— 1,500å­—æ®µ = 150ä¸‡æ–‡æ¡£
ä¸­è§„æ¨¡ï¼š10,000ä¼ä¸š Ã— 1,500å­—æ®µ = 1,500ä¸‡æ–‡æ¡£
å¤§è§„æ¨¡ï¼š100,000ä¼ä¸š Ã— 1,500å­—æ®µ = 1.5äº¿æ–‡æ¡£

MongoDBå•é›†åˆç†è®ºä¸Šé™ï¼šçº¦160äº¿æ–‡æ¡£
```

### 8.2 åŠŸèƒ½æ‰©å±•

**æ–°å¢å­—æ®µç±»å‹**ï¼š

```javascript
// è½»æ¾æ·»åŠ æ–°çš„å­—æ®µç±»å‹
"field_type": "json",     // JSONå¯¹è±¡ç±»å‹
"field_type": "file",     // æ–‡ä»¶ç±»å‹
"field_type": "enum",     // æšä¸¾ç±»å‹
"field_type": "array"     // æ•°ç»„ç±»å‹
```

**æ–°å¢å…ƒæ•°æ®**ï¼š

```javascript
// å¯ä»¥éšæ—¶æ·»åŠ æ–°çš„å…ƒæ•°æ®å­—æ®µ
"validation_rule": "regex:^[0-9]{18}$",  // éªŒè¯è§„åˆ™
"display_format": "currency",             // æ˜¾ç¤ºæ ¼å¼
"auto_fill": true,                       // è‡ªåŠ¨å¡«å……
"computed_field": "field1 + field2"      // è®¡ç®—å­—æ®µ
```

### 8.3 ç‰ˆæœ¬ç®¡ç†

**å­—æ®µç‰ˆæœ¬æ§åˆ¶**ï¼š

```javascript
{
  // åŸºç¡€å­—æ®µä¿¡æ¯
  "field_code": "F_REG_CAPITAL",
  "field_name": "æ³¨å†Œèµ„é‡‘",

  // ç‰ˆæœ¬æ§åˆ¶
  "version": 2,
  "version_history": [
    {
      "version": 1,
      "field_name": "æ³¨å†Œèµ„æœ¬",
      "change_time": "2025-01-01T00:00:00Z",
      "change_reason": "å­—æ®µåç§°è§„èŒƒåŒ–"
    }
  ]
}
```

## 9. æ•°æ®ä¸€è‡´æ€§ä¿éšœ

### 9.1 äº‹åŠ¡æ”¯æŒ

```javascript
// ä½¿ç”¨MongoDBäº‹åŠ¡ç¡®ä¿å¤šå­—æ®µæ“ä½œçš„ä¸€è‡´æ€§
const session = client.startSession();

try {
  await session.withTransaction(async () => {
    // åŒæ—¶æ›´æ–°ä¼ä¸šçš„å¤šä¸ªç›¸å…³å­—æ®µ
    await db.enterprise_fields.updateMany(
      {
        enterprise_code: "E001",
        l1_name: "åŸºæœ¬ä¿¡æ¯",
      },
      {
        $set: { update_time: new Date() },
      },
      { session }
    );

    await db.enterprise_fields.insertOne(
      {
        enterprise_code: "E001",
        field_name: "æ–°å­—æ®µ",
        // ... å…¶ä»–å­—æ®µ
      },
      { session }
    );
  });
} finally {
  await session.endSession();
}
```

### 9.2 æ•°æ®æ ¡éªŒ

**åº”ç”¨å±‚æ ¡éªŒ**ï¼š

```javascript
// ç¡®ä¿ä¼ä¸šå­—æ®µå®Œæ•´æ€§
async function validateEnterpriseFields(enterpriseCode) {
  const fieldCount = await db.enterprise_fields.countDocuments({
    enterprise_code: enterpriseCode,
    status: "active",
  });

  const expectedFieldCount = 1500; // æœŸæœ›çš„å­—æ®µæ€»æ•°

  if (fieldCount !== expectedFieldCount) {
    console.warn(
      `ä¼ä¸š ${enterpriseCode} å­—æ®µä¸å®Œæ•´ï¼š${fieldCount}/${expectedFieldCount}`
    );
    // æ‰§è¡Œæ•°æ®ä¿®å¤é€»è¾‘
    await repairEnterpriseFields(enterpriseCode);
  }
}
```

**æ•°æ®åº“å±‚æ ¡éªŒ**ï¼š

```javascript
// å­—æ®µå€¼ç±»å‹æ ¡éªŒ
db.enterprise_fields.createIndex(
  { enterprise_code: 1, field_code: 1 },
  {
    unique: true,
    partialFilterExpression: { status: "active" },
  }
);
```

## 10. ç›‘æ§å’Œç»´æŠ¤

### 10.1 æ€§èƒ½ç›‘æ§æŒ‡æ ‡

**æŸ¥è¯¢æ€§èƒ½æŒ‡æ ‡**ï¼š

- å¹³å‡æŸ¥è¯¢å“åº”æ—¶é—´
- ç´¢å¼•å‘½ä¸­ç‡
- æ…¢æŸ¥è¯¢åˆ†æ
- å¹¶å‘è¿æ¥æ•°

**å­˜å‚¨æŒ‡æ ‡**ï¼š

- æ–‡æ¡£æ€»æ•°
- ç´¢å¼•å¤§å°
- å­˜å‚¨ç©ºé—´ä½¿ç”¨ç‡
- åˆ†ç‰‡å‡è¡¡åº¦

### 10.2 æ—¥å¸¸ç»´æŠ¤

**ç´¢å¼•ç»´æŠ¤**ï¼š

```javascript
// å®šæœŸé‡å»ºç´¢å¼•
db.enterprise_fields.reIndex();

// åˆ†æç´¢å¼•ä½¿ç”¨æƒ…å†µ
db.enterprise_fields.aggregate([{ $indexStats: {} }]);
```

**æ•°æ®æ¸…ç†**ï¼š

```javascript
// æ¸…ç†æ— æ•ˆçŠ¶æ€çš„æ•°æ®
db.enterprise_fields.deleteMany({
  status: "inactive",
  update_time: { $lt: new Date(Date.now() - 90 * 24 * 60 * 60 * 1000) }, // 90å¤©å‰
});
```

## 11. å‰ç«¯é›†æˆæŒ‡å—

### 11.1 API è®¾è®¡å»ºè®®

**RESTful API è®¾è®¡**ï¼š

```javascript
// è·å–ä¼ä¸šå­—æ®µå±‚çº§ç»“æ„
GET /api/enterprises/{code}/fields/hierarchy

// è·å–ç‰¹å®šåˆ†ç±»ä¸‹çš„å­—æ®µ
GET /api/enterprises/{code}/fields?l1={l1}&l2={l2}&l3={l3}

// æ›´æ–°å•ä¸ªå­—æ®µ
PUT /api/enterprises/{code}/fields/{fieldCode}

// æ‰¹é‡æ›´æ–°å­—æ®µ
PATCH /api/enterprises/{code}/fields

// å››çº§è”åŠ¨API
GET /api/categories/level1
GET /api/categories/level2?l1={l1_code}
GET /api/categories/level3?l1={l1_code}&l2={l2_code}
GET /api/fields?l1={l1_code}&l2={l2_code}&l3={l3_code}
```

### 11.2 å‰ç«¯ç¼“å­˜ç­–ç•¥

**åˆ†çº§ç¼“å­˜**ï¼š

```javascript
// ä¸€çº§åˆ†ç±»ç¼“å­˜ï¼ˆå˜åŒ–é¢‘ç‡ä½ï¼‰
cache.set("level1_categories", data, 3600); // 1å°æ—¶

// äºŒçº§åˆ†ç±»ç¼“å­˜
cache.set(`level2_${l1_code}`, data, 1800); // 30åˆ†é’Ÿ

// å­—æ®µæ•°æ®ç¼“å­˜ï¼ˆå˜åŒ–é¢‘ç‡é«˜ï¼‰
cache.set(`enterprise_${code}_fields`, data, 300); // 5åˆ†é’Ÿ
```

### 11.3 ç»„ä»¶è®¾è®¡å»ºè®®

**å››çº§è”åŠ¨ç»„ä»¶**ï¼š

```jsx
<CascadeFieldSelector
  enterprise={enterpriseCode}
  levels={["l1", "l2", "l3", "field"]}
  onChange={handleFieldSelect}
  showFieldCount={true}
  enableSearch={true}
/>
```

**æ ‘å½¢å±•ç¤ºç»„ä»¶**ï¼š

```jsx
<EnterpriseFieldTree
  enterprise={enterpriseCode}
  onFieldEdit={handleFieldEdit}
  showProgress={true}
  groupBy="category"
/>
```

## 12. å®‰å…¨è€ƒè™‘

### 12.1 æ•°æ®æƒé™

**å­—æ®µçº§æƒé™æ§åˆ¶**ï¼š

```javascript
// ç”¨æˆ·åªèƒ½è®¿é—®æˆæƒçš„å­—æ®µ
const authorizedFields = await db.enterprise_fields.find({
  enterprise_code: enterpriseCode,
  field_code: { $in: userPermissions.allowedFields },
  l1_code: { $in: userPermissions.allowedCategories },
});
```

**æ•æ„Ÿæ•°æ®ä¿æŠ¤**ï¼š

```javascript
// æ•æ„Ÿå­—æ®µåŠ å¯†å­˜å‚¨
{
  field_name: "é“¶è¡Œè´¦å·",
  value: "encrypted:AES256:xxxxx",
  is_sensitive: true,
  encryption_method: "AES256"
}
```

### 12.2 æ“ä½œå®¡è®¡

**å˜æ›´æ—¥å¿—**ï¼š

```javascript
// å­—æ®µå˜æ›´å†å²è®°å½•
{
  field_code: "F_REG_CAPITAL",
  change_log: [
    {
      user: "user123",
      action: "update",
      old_value: "1000ä¸‡å…ƒ",
      new_value: "2000ä¸‡å…ƒ",
```
